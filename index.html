<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
      --chip-bg:#0b1222;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#4b5563; --text:#0f172a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#d97706; --danger:#dc2626; --border:#e5e7eb;
      --chip-bg:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}

    /* –®–∞–ø–∫–∞ –æ–±—ã—á–Ω–∞—è (–ù–ï —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç—Å—è) */
    header{
      position:relative; top:auto; background:var(--bg);
      border-bottom:1px solid var(--border); backdrop-filter:none; z-index:auto;
    }
    [data-theme="light"] header{ background:var(--bg); }

    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{margin:0 0 4px;font-size:24px}
    .sub{color:var(--muted);font-size:13px}

    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
    .tab{flex:1;min-width:120px;text-align:center;padding:12px 10px;border:1px solid var(--border);border-radius:12px;background:var(--card);cursor:pointer;color:var(--text);font-weight:700}
    .tab.active{outline:2px solid var(--accent2)}

    .grid{display:grid;grid-template-columns:110px 1fr 44px;gap:8px;align-items:center}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .row{display:contents}
    .time{font-variant-numeric:tabular-nums;color:var(--muted)}
    .label{font-size:15px}
    input[type="checkbox"]{width:28px;height:28px}
    input[type="number"], input[type="time"], input[type="email"]{
      font-size:16px;padding:8px 10px;border:1px solid var(--border);
      border-radius:10px;background:transparent;color:var(--text);width:100%;max-width:140px
    }
    .muted{color:var(--muted)}

    /* –≠–º–æ–¥–∑–∏ –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É */
    .chips{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;padding-bottom:4px}
    .chip{padding:8px 12px;border:1px solid var(--border);border-radius:999px;background:var(--chip-bg);color:var(--text);cursor:pointer;font-size:18px}
    .chip.active{outline:2px solid var(--accent2);}
    .stateRow{margin:10px 0}
    .stateTitle{font-size:14px;color:var(--muted);margin-bottom:6px}

    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b1024;font-size:12px}
    [data-theme="light"] .pill{background:#f1f5f9}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:var(--chip-bg);color:var(--text)!important;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent2); color:#fff;}
    .btn.warn{background:var(--warn); color:#000;}
    .btn.danger{background:var(--danger); color:#fff;}
    .btn.ghost{background:var(--card)}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .kpi .card{padding:14px}
    .big{font-size:22px;font-weight:800}
    progress{width:100%;height:14px}
    footer.sticky{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(15,23,42,.97),rgba(15,23,42,.9));backdrop-filter:blur(8px);border-top:1px solid var(--border)}
    [data-theme="light"] footer.sticky{background:linear-gradient(0deg,rgba(255,255,255,.97),rgba(255,255,255,.9))}
    .small{font-size:12px}
    .right{margin-left:auto}

    /* –°–ø–∞—Ä–∫–ª–∞–π–Ω—ã */
    .spark-wrap{display:grid;grid-template-columns:84px 1fr;gap:8px;align-items:center}
    .spark-title{color:var(--muted);font-size:12px}
    .spark-kpi{font-size:12px;color:var(--muted)}
    .spark svg{width:100%;height:40px;display:block}
    .spark path{fill:none;stroke:currentColor;stroke-width:2}
    .spark .axis{stroke:currentColor;opacity:.2;stroke-width:1}
    .spark .dot{fill:currentColor}

    @media (min-width:1025px){
      .tabs .tab{min-width:140px}
      .grid{grid-template-columns:140px 1fr 60px}
    }
    @media(max-width:560px){
      .wrap{padding:12px}
      h1{font-size:22px}
      .grid{grid-template-columns:88px 1fr 36px; gap:6px}
      .tab{min-width:100px; padding:10px 10px; font-size:13px}
      .btn{padding:10px 12px}
      input[type="number"], input[type="time"], input[type="email"]{max-width:110px}
      .kpi{grid-template-columns:1fr 1fr}
    }
  </style>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="flex" style="align-items:flex-start;justify-content:space-between;">
        <div>
          <h1>üìÖ –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</h1>
          <div class="sub" id="dateLine">‚Äî</div>
          <div class="flex" style="margin-top:10px">
            <span class="pill" id="sportPill">–°–ø–æ—Ä—Ç –¥–Ω—è: ‚Äî</span>
            <span class="pill" id="sleepPill">–°–æ–Ω: 22:30 ‚Üí 06:00 (‚âà7‚Äì8 —á)</span>
            <span class="pill">–¶–µ–ª—å –≤–µ—Å–∞: 80 –∫–≥</span>
          </div>
        </div>
        <div class="flex right">
          <button class="btn" id="themeBtn">üåô/‚òÄÔ∏è</button>
          <button class="btn" id="settingsBtn">‚öôÔ∏è</button>
          <button class="btn" id="exportBtn">–≠–∫—Å–ø–æ—Ä—Ç</button>
          <label class="btn" for="importInput">–ò–º–ø–æ—Ä—Ç<input id="importInput" type="file" accept="application/json" hidden></label>
          <button class="btn warn" id="resetDayBtn">–°–±—Ä–æ—Å –¥–Ω—è</button>
          <button class="btn primary" id="saveNearBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <a class="btn ghost" href="./charts.html">–ì—Ä–∞—Ñ–∏–∫–∏</a>
        </div>
      </div>

      <div id="authBox" class="flex" style="margin-top:10px">
        <input id="emailInput" type="email" placeholder="email (–¥–ª—è –≤—Ö–æ–¥–∞ –ø–æ —Å—Å—ã–ª–∫–µ)" style="max-width:260px">
        <button class="btn" id="loginBtn">–í–æ–π—Ç–∏</button>
        <button class="btn" id="logoutBtn" style="display:none">–í—ã–π—Ç–∏</button>
        <span id="whoami" class="sub"></span>
      </div>

      <div class="tabs" id="dayTabs"></div>

      <div class="flex" id="weekNav" style="margin-top:6px">
        <button class="btn" id="prevWeekBtn">‚üµ –ù–µ–¥–µ–ª—è</button>
        <div class="pill" id="weekLabel">–ù–µ–¥–µ–ª—è ‚Äî</div>
        <button class="btn" id="nextWeekBtn">–ù–µ–¥–µ–ª—è ‚ü∂</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="kpi">
      <div class="card"><div class="muted small">–í—ã–ø–æ–ª–Ω–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div><div class="big" id="doneToday">0%</div><progress id="progToday" max="100" value="0"></progress></div>
      <div class="card"><div class="muted small">–ù–µ–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å</div><div class="big" id="doneWeek">0%</div><progress id="progWeek" max="100" value="0"></progress></div>
      <div class="card"><div class="muted small">–ö–Ω–∏–≥–∞ / –º–µ—Å—è—Ü</div><div class="big" id="bookPages">20 —Å—Ç—Ä/–¥–µ–Ω—å</div><div class="small muted">–ß–∏—Ç–∞–π 20‚Äì30 –º–∏–Ω –µ–∂–µ–¥–Ω–µ–≤–Ω–æ</div></div>
      <div class="card"><div class="muted small">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</div><div class="big" id="engDaily">Duolingo 15‚Äì30 –º–∏–Ω</div><div class="small muted">–ü–æ–¥–∫–∞—Å—Ç –≤ –¥–æ—Ä–æ–≥–µ</div></div>

      <!-- –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –∑–∞ –Ω–µ–¥–µ–ª—é -->
      <div class="card" id="healthWeeklyCard">
        <div class="muted small">–ó–¥–æ—Ä–æ–≤—å–µ (–Ω–µ–¥–µ–ª—è)</div>
        <div class="spark-wrap" style="margin-top:6px">
          <div>
            <div class="spark-title">–í–µ—Å (–∫–≥)</div>
            <div class="spark-kpi" id="weightLast">‚Äî</div>
          </div>
          <div class="spark" id="weightSpark"></div>
        </div>
        <div class="spark-wrap" style="margin-top:10px">
          <div>
            <div class="spark-title">–ü—É–ª—å—Å —É—Ç—Ä–æ–º</div>
            <div class="spark-kpi" id="pulseLast">‚Äî</div>
          </div>
          <div class="spark" id="pulseSpark"></div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–ë—É–¥–Ω–∏–π –¥–µ–Ω—å ‚Äî —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</h3>
      <div class="grid" id="scheduleGrid"></div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">üç¥ –ü–∏—Ç–∞–Ω–∏–µ –∑–∞ –¥–µ–Ω—å</h3>
      <div class="grid" id="nutritionMeals"></div>
      <div class="grid" id="nutritionTotals"></div>
      <div class="small muted" style="margin-top:8px">–¶–≤–µ—Ç –∏—Ç–æ–≥–∞ –ø–æ –∫–∞–ª–æ—Ä–∏—è–º: >2000 ‚Äî <b style="color:#ef4444">–∫—Ä–∞—Å–Ω—ã–π</b>, <1500 ‚Äî <b style="color:#2563eb">—Å–∏–Ω–∏–π</b>.</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ü–µ–ª–∏</h3>
      <div class="grid" id="dailyGoals"></div>
    </section>

    <section class="card" id="weeklySection">
      <h3 style="margin-top:0">–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</h3>
      <div class="grid" id="weeklyGoals"></div>
      <div class="small muted" style="margin-top:8px">–ù–µ–¥–µ–ª—è —Å—á–∏—Ç–∞–µ—Ç—Å—è –ø–æ ISO (–ø–Ω‚Äì–≤—Å). ¬´–°–±—Ä–æ—Å –¥–Ω—è¬ª —á–∏—Å—Ç–∏—Ç –≤–µ—Å—å —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, —Ü–µ–ª–∏ –∏ –ø–∏—Ç–∞–Ω–∏–µ).</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞ –¥–µ–Ω—å</h3>
      <div id="stateGrid"></div>
      <div class="small muted">–í—ã–±–µ—Ä–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 5: 1 ‚Äî –ø–ª–æ—Ö–æ, 5 ‚Äî –æ—Ç–ª–∏—á–Ω–æ.</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–ó–¥–æ—Ä–æ–≤—å–µ –∏ –¥–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ (—É—Ç—Ä–æ)</h3>
      <div class="grid" id="healthGrid"></div>
      <div class="grid" id="alphaGrid"></div>
    </section>
  </main>

  <footer class="sticky">
    <div class="wrap flex" style="justify-content:space-between">
      <div class="small muted">–î–æ–±–∞–≤—å –Ω–∞ –¥–æ–º–∞—à–Ω–∏–π —ç–∫—Ä–∞–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ üì≤</div>
      <button class="btn primary" id="addToHome" style="display:none">–î–æ–±–∞–≤–∏—Ç—å –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω</button>
    </div>
  </footer>

  <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
  <div class="settings" id="settings" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:16px">
    <div class="box" style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;max-width:420px;width:100%">
      <h3 style="margin:0 0 8px">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <label>–í—Ä–µ–º—è –ø–æ–¥—ä—ë–º–∞</label>
      <input id="wakeTime" type="time" value="06:00">
      <label>–í—Ä–µ–º—è —Å–Ω–∞</label>
      <input id="sleepTime" type="time" value="22:30">
      <div class="flex" style="margin-top:12px;justify-content:flex-end">
        <button class="btn" id="cancelSettings">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn primary" id="saveSettings">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <script>
  /* ====== –î–∞—Ç–∞/—É—Ç–∏–ª—ã ====== */
  const DAYS_FULL = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
  const pad=(n)=> String(n).padStart(2,'0');
  const ymd=(d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  function isoWeek(d){ const t = new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-day+3); const first=new Date(Date.UTC(t.getUTCFullYear(),0,4)); const w=1+Math.round(((t-first)/86400000-3+((first.getUTCDay()+6)%7))/7); return `${t.getUTCFullYear()}-W${pad(w)}`;}
  const today = new Date();
  function startOfISOWeek(d){ const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day); t.setHours(0,0,0,0); return t;}
  function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x;}
  let viewWeekStart = startOfISOWeek(today);
  let currentDay = (today.getDay()+6)%7;
  function getViewDate(){ return addDays(viewWeekStart, currentDay); }

  /* ====== –¢–µ–º–∞/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ====== */
  const root=document.documentElement, themeBtn=document.getElementById('themeBtn');
  function applyTheme(t){ root.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
  applyTheme(localStorage.getItem('theme')||'dark');
  themeBtn.onclick=()=> applyTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');
  const settings = document.getElementById('settings');
  document.getElementById('settingsBtn').onclick=()=>{ loadTimes(); settings.style.display='flex'; };
  document.getElementById('cancelSettings').onclick=()=> settings.style.display='none';
  document.getElementById('saveSettings').onclick=()=>{ localStorage.setItem('wakeTime', document.getElementById('wakeTime').value); localStorage.setItem('sleepTime', document.getElementById('sleepTime').value); loadTimes(); settings.style.display='none'; scheduleSave(); };
  function loadTimes(){ const w=localStorage.getItem('wakeTime')||'06:00', s=localStorage.getItem('sleepTime')||'22:30'; document.getElementById('wakeTime').value=w; document.getElementById('sleepTime').value=s; document.getElementById('sleepPill').textContent=`–°–æ–Ω: ${s} ‚Üí ${w} (‚âà7‚Äì8 —á)`; }

  /* ====== –î–∞–Ω–Ω—ã–µ/–∫–ª—é—á–∏ ====== */
  const baseDay = [
    ['05:30‚Äì06:00','–ü–æ–¥—ä—ë–º, –≤–æ–¥–∞, –¥—ã—Ö–∞–Ω–∏–µ, –∑–∞—Ä—è–¥–∫–∞'],
    ['06:00‚Äì07:00','–°–ø–æ—Ä—Ç'],
    ['07:00‚Äì07:30','–ó–∞–≤—Ç—Ä–∞–∫ (–±–µ–ª–æ–∫ + –æ–≤–æ—â–∏)'],
    ['08:00‚Äì08:40','–î–æ—Ä–æ–≥–∞ ‚Üí –∞—É–¥–∏–æ–∫–Ω–∏–≥–∞/–ø–æ–¥–∫–∞—Å—Ç'],
    ['09:00‚Äì13:00','–†–∞–±–æ—Ç–∞ (—Ñ–æ–∫—É—Å-–±–ª–æ–∫–∏)'],
    ['13:00‚Äì13:30','–û–±–µ–¥ + Duolingo'],
    ['13:30‚Äì18:00','–†–∞–±–æ—Ç–∞ (–≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏)'],
    ['18:00‚Äì18:40','–î–æ—Ä–æ–≥–∞ ‚Üí –∞–Ω–≥–ª. –ø–æ–¥–∫–∞—Å—Ç/–ª–µ–∫—Ü–∏—è'],
    ['19:00‚Äì20:00','–£–∂–∏–Ω (–ª—ë–≥–∫–∏–π –±–µ–ª–æ–∫ + –æ–≤–æ—â–∏)'],
    ['20:00‚Äì21:00','‚Äî —Å–≤–æ–±–æ–¥–Ω–æ–µ/—Å–µ–º—å—è ‚Äî'],
    ['21:00‚Äì21:30','–•–æ–±–±–∏ (–≥–∏—Ç–∞—Ä–∞/—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä)'],
    ['21:30‚Äì22:00','–ß—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥–∏'],
    ['22:00‚Äì22:30','–í–µ—á–µ—Ä–Ω–∏–π —Ä–∏—Ç—É–∞–ª, –¥—É—à'],
    ['22:30‚Äì06:00','–°–æ–Ω']
  ];
  const sportPlan = {0:'–°–∏–ª–æ–≤—ã–µ (–≥–∏—Ä—è/–≥–∞–Ω—Ç–µ–ª–∏)',1:'–ë–µ–≥ (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã 5‚Äì7 –∫–º)',2:'–§—É—Ç–±–æ–ª',3:'–°–∏–ª–æ–≤—ã–µ (–≥–∏—Ä—è/–≥–∞–Ω—Ç–µ–ª–∏)',4:'–ë–µ–≥ (5‚Äì7 –∫–º)',5:'–°–∏–ª–æ–≤—ã–µ + –±–µ–≥ (–∫–æ–º–±–æ)',6:'–§—É—Ç–±–æ–ª'};
  const goalsDaily  = ['7+ —á–∞—Å–æ–≤ —Å–Ω–∞','Duolingo 15‚Äì30 –º–∏–Ω','–ê—É–¥–∏–æ –≤ –¥–æ—Ä–æ–≥–µ (—É—Ç—Ä–æ/–≤–µ—á–µ—Ä)','20+ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏','–ü–∏—Ç–∞–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É','–°–ø–æ—Ä—Ç –¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω'];
  const goalsWeekly = ['5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫/–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π','2√ó —Å–∏–ª–æ–≤—ã–µ','2√ó —Ñ—É—Ç–±–æ–ª','2√ó –±–µ–≥ (–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã/–¥–ª–∏–Ω–Ω—ã–π)','7√ó Duolingo','7√ó 20+ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏','–ü–ª–∞–Ω –Ω–µ–¥–µ–ª–∏ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω'];

  const DAY_KEY  =(d,i)=>`day:${ymd(d)}:${i}`;
  const GOAL_KEY =(d,i)=>`goal:${ymd(d)}:${i}`;
  const WEEK_KEY =(w,i)=>`wgoal:${w}:${i}`;
  const NF_KEY   =(d,m,f)=>`n:${ymd(d)}:${m}:${f}`;
  const STATE_KEY=(d,t)=>`state:${ymd(d)}:${t}`;
  const PULSE_KEY=(d)=>`metric:${ymd(d)}:pulse`;
  const WEIGHT_KEY=(d)=>`metric:${ymd(d)}:weight`;
  const ERECT_KEY =(d)=>`metric:${ymd(d)}:erection`;
  const ALPHA_KEY =(d,i)=>`alpha:${ymd(d)}:${i}`;

  /* ====== –†–µ–Ω–¥–µ—Ä ====== */
  const tabs=document.getElementById('dayTabs');
  function renderTabs(){
    tabs.innerHTML='';
    DAYS_FULL.forEach((name,i)=>{
      const b=document.createElement('button');
      b.className='tab'+(i===currentDay?' active':''); b.textContent=name;
      b.onclick=()=>{ currentDay=i; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderAll(); syncLoadFor(getViewDate()); };
      tabs.appendChild(b);
    });
    const vd=getViewDate();
    document.getElementById('dateLine').textContent = `${DAYS_FULL[currentDay]} ‚Ä¢ ${ymd(vd)}`;
    document.getElementById('weekLabel').textContent = `–ù–µ–¥–µ–ª—è ${isoWeek(vd)}`;
  }

  const grid=document.getElementById('scheduleGrid'), daily=document.getElementById('dailyGoals'), weekly=document.getElementById('weeklyGoals'), sportPill=document.getElementById('sportPill');
  function makeRow(time,label,checked,onchange,key){
    const t=document.createElement('div'); t.className='row';
    const c1=document.createElement('div'); c1.className='time'; c1.textContent=time; t.appendChild(c1);
    const c2=document.createElement('div'); c2.className='label'; c2.textContent=label; t.appendChild(c2);
    const c3=document.createElement('div'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=checked; cb.onchange=()=>onchange(cb.checked); c3.appendChild(cb); t.appendChild(c3);
    cb.setAttribute('data-key',key); return t;
  }
  function renderSchedule(){
    const vd=getViewDate(); grid.innerHTML=''; sportPill.textContent=`–°–ø–æ—Ä—Ç –¥–Ω—è: ${sportPlan[currentDay]}`;
    baseDay.forEach((it,i)=>{ const key=DAY_KEY(vd,i); const saved=localStorage.getItem(key)==='1';
      grid.appendChild(makeRow(it[0],it[1],saved,(v)=>{ localStorage.setItem(key,v?'1':'0'); updateProgress(); scheduleSave(); },key)); });
  }
  function renderDailyGoals(){
    const vd=getViewDate(); daily.innerHTML='';
    goalsDaily.forEach((lab,i)=>{ const key=GOAL_KEY(vd,i); const saved=localStorage.getItem(key)==='1';
      daily.appendChild(makeRow('‚Äî',lab,saved,(v)=>{ localStorage.setItem(key,v?'1':'0'); updateProgress(); scheduleSave(); },key)); });
  }
  function renderWeeklyGoals(){
    weekly.innerHTML=''; const w=isoWeek(getViewDate());
    goalsWeekly.forEach((lab,i)=>{ const key=WEEK_KEY(w,i); const saved=localStorage.getItem(key)==='1';
      weekly.appendChild(makeRow('–ù–µ–¥–µ–ª—è',lab,saved,(v)=>{ localStorage.setItem(key,v?'1':'0'); updateProgress(); scheduleSave(); },key)); });
  }
  function updateProgress(){
    const vd=getViewDate(); const dayTotal=baseDay.length+goalsDaily.length;
    let done=0; for(let i=0;i<baseDay.length;i++) if(localStorage.getItem(DAY_KEY(vd,i))==='1') done++;
    for(let i=0;i<goalsDaily.length;i++) if(localStorage.getItem(GOAL_KEY(vd,i))==='1') done++;
    const dp=Math.round(100*done/Math.max(1,dayTotal)); document.getElementById('doneToday').textContent=dp+'%'; document.getElementById('progToday').value=dp;
    const w=isoWeek(vd); let wDone=0; for(let i=0;i<goalsWeekly.length;i++) if(localStorage.getItem(WEEK_KEY(w,i))==='1') wDone++;
    const wp=Math.round(100*wDone/Math.max(1,goalsWeekly.length)); document.getElementById('doneWeek').textContent=wp+'%'; document.getElementById('progWeek').value=wp;
  }

  /* ====== –ü–∏—Ç–∞–Ω–∏–µ ====== */
  const mealsGrid=document.getElementById('nutritionMeals'), totalsGrid=document.getElementById('nutritionTotals');
  const MEALS=['–ó–∞–≤—Ç—Ä–∞–∫','–û–±–µ–¥','–£–∂–∏–Ω','–ü–µ—Ä–µ–∫—É—Å—ã']; const N_FIELDS=['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)','–ë–µ–ª–∫–∏ (–≥)','–ñ–∏—Ä—ã (–≥)','–£–≥–ª–µ–≤–æ–¥—ã (–≥)'];
  const getNum=(k)=>parseInt(localStorage.getItem(k)||0); const setNum=(k,v)=>localStorage.setItem(k,String(v));
  function renderMeals(){
    const vd=getViewDate(); mealsGrid.innerHTML='';
    const header=document.createElement('div'); header.className='row'; header.innerHTML='<div class="time">–ü—Ä–∏—ë–º</div><div class="label">–ö–ë–ñ–£</div><div></div>'; mealsGrid.appendChild(header);
    MEALS.forEach(meal=>{
      const row=document.createElement('div'); row.className='row'; const c1=document.createElement('div'); c1.className='time'; c1.textContent=meal; row.appendChild(c1);
      const c2=document.createElement('div'); c2.className='label'; const wrap=document.createElement('div'); wrap.className='flex';
      N_FIELDS.forEach(f=>{ const key=NF_KEY(vd,meal,f); const inp=document.createElement('input'); inp.type='number'; inp.min='0'; inp.placeholder='0'; inp.value=getNum(key);
        inp.onchange=()=>{ setNum(key,parseInt(inp.value||0)); renderTotals(); scheduleSave(); };
        const lbl=document.createElement('span'); lbl.className='muted small'; lbl.textContent=f.split(' ')[0]+':'; const box=document.createElement('div'); box.className='flex'; box.appendChild(lbl); box.appendChild(inp); wrap.appendChild(box);
      });
      c2.appendChild(wrap); row.appendChild(c2); row.appendChild(document.createElement('div')); mealsGrid.appendChild(row);
    });
  }
// –ü–ª–∞–Ω–æ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
const PLANS = {
  '–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)': 1950,
  '–ë–µ–ª–∫–∏ (–≥)': 210,
  '–ñ–∏—Ä—ã (–≥)': 55,
  '–£–≥–ª–µ–≤–æ–¥—ã (–≥)': 150
};

function renderTotals(){
  const vd = getViewDate();
  totalsGrid.innerHTML = '';

  // –°—É–º–º–∏—Ä—É–µ–º —Ñ–∞–∫—Ç –∑–∞ –¥–µ–Ω—å
  const sums = {'–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)':0,'–ë–µ–ª–∫–∏ (–≥)':0,'–ñ–∏—Ä—ã (–≥)':0,'–£–≥–ª–µ–≤–æ–¥—ã (–≥)':0};
  MEALS.forEach(meal => N_FIELDS.forEach(field => {
    sums[field] += getNum(NF_KEY(vd, meal, field));
  }));

  // –†–µ–Ω–¥–µ—Ä —Å—Ç—Ä–æ–∫ (–§–∞–∫—Ç / –ü–ª–∞–Ω –∏ % –æ—Ç –ø–ª–∞–Ω–∞)
  N_FIELDS.forEach(field=>{
    const row = document.createElement('div');
    row.className = 'row';

    const c1 = document.createElement('div');
    c1.className = 'time';
    c1.textContent = field;
    row.appendChild(c1);

    const fact = sums[field];
    const plan = PLANS[field] ?? 0;
    const pct  = plan ? Math.round((fact/plan)*100) : 0;

    const c2 = document.createElement('div');
    c2.className = 'label';
    c2.textContent = `${fact} / ${plan} (${pct}%)`;

    // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –ø–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—é –æ—Ç –ø–ª–∞–Ω–∞: >110% ‚Äî –∫—Ä–∞—Å–Ω—ã–π, <90% ‚Äî —Å–∏–Ω–∏–π
    if (plan) {
      if (fact > plan*1.10)      c2.style.color = '#ef4444'; // –ø–µ—Ä–µ–±–æ—Ä
      else if (fact < plan*0.90) c2.style.color = '#2563eb'; // –Ω–µ–¥–æ–±–æ—Ä
      else                       c2.style.color = 'inherit'; // –≤ –∫–æ—Ä–∏–¥–æ—Ä–µ
    }

    row.appendChild(c2);
    row.appendChild(document.createElement('div'));
    totalsGrid.appendChild(row);
  });
}


  /* ====== –°–æ—Å—Ç–æ—è–Ω–∏–µ ====== */
  const stateGrid=document.getElementById('stateGrid');
  const stateOptions=[{v:1,label:'üòñ 1'},{v:2,label:'üòï 2'},{v:3,label:'üòê 3'},{v:4,label:'üôÇ 4'},{v:5,label:'üòÑ 5'}];
  function stateRow(title,type){
    const vd=getViewDate(); const box=document.createElement('div'); box.className='stateRow';
    const h=document.createElement('div'); h.className='stateTitle'; h.textContent=title; box.appendChild(h);
    const wrap=document.createElement('div'); wrap.className='chips'; const saved=parseInt(localStorage.getItem(STATE_KEY(vd,type))||0);
    stateOptions.forEach(o=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'+(saved===o.v?' active':''); b.textContent=o.label; b.onclick=()=>{ localStorage.setItem(STATE_KEY(vd,type),String(o.v)); renderStates(); scheduleSave(); }; wrap.appendChild(b);});
    box.appendChild(wrap); return box;
  }
  function renderStates(){ stateGrid.innerHTML=''; stateGrid.appendChild(stateRow('–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ','mood')); stateGrid.appendChild(stateRow('–§–∏–∑–∏—á–µ—Å–∫–∏','body')); }

  /* ====== –ó–¥–æ—Ä–æ–≤—å–µ/–ê–ª—å—Ñ–∞ ====== */
  const healthGrid=document.getElementById('healthGrid'); const alphaGrid=document.getElementById('alphaGrid');
  const alphaItems=['–ë—ã—Ç (–ø–æ—Ä—è–¥–æ–∫)','–°–ø–æ—Ä—Ç (–¥–ª—è —Å—Ç–∞–∏)','–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å (–±–µ–∑ –æ–ø—Ä–∞–≤–¥–∞–Ω–∏–π)','–î–µ–Ω—å–≥–∏ (3 —Å–ø–æ—Å–æ–±–∞ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å)'];
  function renderHealth(){
    const vd=getViewDate(); healthGrid.innerHTML='';
    // –ü—É–ª—å—Å
    let r=document.createElement('div'); r.className='row'; r.innerHTML=`<div class="time">–ü—É–ª—å—Å —É—Ç—Ä–æ–º</div>`; let c=document.createElement('div'); c.className='label';
    let i=document.createElement('input'); i.type='number'; i.min='30'; i.max='150'; i.placeholder='—É–¥/–º–∏–Ω'; i.value=localStorage.getItem(PULSE_KEY(vd))||''; i.onchange=()=>{localStorage.setItem(PULSE_KEY(vd),String(i.value||'')); scheduleSave();}; c.appendChild(i); r.appendChild(c); r.appendChild(document.createElement('div')); healthGrid.appendChild(r);
    // –í–µ—Å
    r=document.createElement('div'); r.className='row'; r.innerHTML=`<div class="time">–í–µ—Å (–∫–≥)</div>`; c=document.createElement('div'); c.className='label';
    i=document.createElement('input'); i.type='number'; i.min='40'; i.max='200'; i.step='0.1'; i.placeholder='–∫–≥'; i.value=localStorage.getItem(WEIGHT_KEY(vd))||''; i.onchange=()=>{localStorage.setItem(WEIGHT_KEY(vd),String(i.value||'')); scheduleSave();}; c.appendChild(i); r.appendChild(c); r.appendChild(document.createElement('div')); healthGrid.appendChild(r);
    // –≠—Ä–µ–∫—Ü–∏—è
    r=document.createElement('div'); r.className='row'; r.innerHTML=`<div class="time">–≠—Ä–µ–∫—Ü–∏—è</div>`; c=document.createElement('div'); c.className='label'; const wrap=document.createElement('div'); wrap.className='chips'; const saved=parseInt(localStorage.getItem(ERECT_KEY(vd))||0);
    [['–î–∞',1],['–ù–µ—Ç',0]].forEach(([txt,val])=>{ const b=document.createElement('button'); b.type='button'; b.className='chip'+(saved===val?' active':''); b.textContent=txt; b.onclick=()=>{localStorage.setItem(ERECT_KEY(vd),String(val)); renderHealth(); scheduleSave();}; wrap.appendChild(b);}); c.appendChild(wrap); r.appendChild(c); r.appendChild(document.createElement('div')); healthGrid.appendChild(r);
  }
  function renderAlpha(){
    const vd=getViewDate(); alphaGrid.innerHTML='';
    alphaItems.forEach((lab,idx)=>{ const key=ALPHA_KEY(vd,idx); const saved=localStorage.getItem(key)==='1';
      alphaGrid.appendChild(makeRow(idx===0?'–ê–ª—å—Ñ–∞ 30 –¥–Ω–µ–π':'', lab, saved, (v)=>{ localStorage.setItem(key,v?'1':'0'); scheduleSave(); }, key));
    });
  }

  /* ====== –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∏ –Ω–µ–¥–µ–ª–∏ ====== */
  function getWeekDates(){ const s=viewWeekStart; return Array.from({length:7},(_,i)=>addDays(s,i)); }
  function collectMetricSeries(keyFn){ return getWeekDates().map(d=>{ const v=localStorage.getItem(keyFn(d)); return v==null||v===''?null:Number(v); }); }
  function renderSpark(containerId, series, opts){
    const el=document.getElementById(containerId); el.innerHTML='';
    const w=el.clientWidth||220, h=40, pad=2, svgNS='http://www.w3.org/2000/svg';
    const svg=document.createElementNS(svgNS,'svg'); svg.setAttribute('viewBox',`0 0 ${w} ${h}`);
    const axis=document.createElementNS(svgNS,'line'); axis.setAttribute('x1',0);axis.setAttribute('y1',h-1);axis.setAttribute('x2',w);axis.setAttribute('y2',h-1);axis.setAttribute('class','axis'); svg.appendChild(axis);
    const xs=series.map((_,i)=> i/(series.length-1||1));
    const vals=series.filter(v=>v!=null); if(!vals.length){ el.appendChild(svg); return; }
    let min=opts.min??Math.min(...vals), max=opts.max??Math.max(...vals); if(min===max){min-=1;max+=1;}
    const path=document.createElementNS(svgNS,'path'); let d='';
    series.forEach((v,i)=>{ const x=pad+xs[i]*(w-2*pad); const y=v==null?(h-pad):(h-pad)-((v-min)/(max-min))*(h-2*pad); d+=(i===0?'M':'L')+`${x},${y} `; }); path.setAttribute('d',d.trim()); svg.appendChild(path);
    const last=[...series.keys()].reverse().find(i=>series[i]!=null); if(last!=null){ const xv=pad+xs[last]*(w-2*pad); const yv=(h-pad)-((series[last]-min)/(max-min))*(h-2*pad); const dot=document.createElementNS(svgNS,'circle'); dot.setAttribute('cx',xv);dot.setAttribute('cy',yv);dot.setAttribute('r',2.5);dot.setAttribute('class','dot'); svg.appendChild(dot); }
    el.appendChild(svg);
  }
  function renderHealthWeeklyCard(){
    const wSeries=collectMetricSeries(d=>`metric:${ymd(d)}:weight`);
    const lastW=[...wSeries].reverse().find(v=>v!=null); document.getElementById('weightLast').textContent=lastW!=null?`${lastW} –∫–≥`:'‚Äî';
    const pSeries=collectMetricSeries(d=>`metric:${ymd(d)}:pulse`);
    const lastP=[...pSeries].reverse().find(v=>v!=null); document.getElementById('pulseLast').textContent=lastP!=null?`${lastP} —É–¥/–º–∏–Ω`:'‚Äî';
    renderSpark('weightSpark', wSeries, {});
    renderSpark('pulseSpark', pSeries, {min:40,max:120});
  }

  /* ====== –≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç ====== */
  document.getElementById('exportBtn').onclick=()=>{
    const data={}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(!k) continue;
      if(k.startsWith('day:')||k.startsWith('goal:')||k.startsWith('wgoal:')||k.startsWith('n:')||k.startsWith('state:')||k.startsWith('metric:')||k.startsWith('alpha:')||k==='theme'||k==='wakeTime'||k==='sleepTime'){ data[k]=localStorage.getItem(k); }
    }
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tracker-backup.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
  };
  document.getElementById('importInput').onchange=async(e)=>{ const f=e.target.files[0]; if(!f) return; const t=await f.text();
    try{ const data=JSON.parse(t); Object.entries(data).forEach(([k,v])=>{ if(k.startsWith('day:')||k.startsWith('goal:')||k.startsWith('wgoal:')||k.startsWith('n:')||k.startsWith('state:')||k.startsWith('metric:')||k.startsWith('alpha:')||k==='theme'||k==='wakeTime'||k==='sleepTime') localStorage.setItem(k,String(v));});
      applyTheme(localStorage.getItem('theme')||'dark'); loadTimes(); renderAll(); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ'); scheduleSave();
    }catch{ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); } };

  /* ====== –°–±—Ä–æ—Å/–°–æ—Ö—Ä–∞–Ω–∏—Ç—å ====== */
  document.getElementById('resetDayBtn').onclick=()=>{
    const vd=getViewDate();
    for(let i=0;i<baseDay.length;i++) localStorage.removeItem(DAY_KEY(vd,i));
    for(let i=0;i<goalsDaily.length;i++) localStorage.removeItem(GOAL_KEY(vd,i));
    ['–ó–∞–≤—Ç—Ä–∞–∫','–û–±–µ–¥','–£–∂–∏–Ω','–ü–µ—Ä–µ–∫—É—Å—ã'].forEach(m=>['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)','–ë–µ–ª–∫–∏ (–≥)','–ñ–∏—Ä—ã (–≥)','–£–≥–ª–µ–≤–æ–¥—ã (–≥)'].forEach(f=>localStorage.removeItem(NF_KEY(vd,m,f))));
    ['mood','body'].forEach(t=> localStorage.removeItem(STATE_KEY(vd,t)));
    [PULSE_KEY,WEIGHT_KEY,ERECT_KEY].forEach(fn=> localStorage.removeItem(fn(vd)));
    for(let i=0;i<4;i++) localStorage.removeItem(ALPHA_KEY(vd,i));
    renderAll(); scheduleSave();
  };
  document.getElementById('saveNearBtn').onclick=()=> syncSaveFor(getViewDate());

  /* ====== PWA ====== */
  (function(){ const sw=`self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('tracker-v1').then(c=>c.addAll(['./'])))});self.addEventListener('fetch',e=>{e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request)))})`; const blob=new Blob([sw],{type:'text/javascript'}); const url=URL.createObjectURL(blob); if('serviceWorker' in navigator){ navigator.serviceWorker.register(url); }
    let dp; const btn=document.getElementById('addToHome'); window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); dp=e; btn.style.display='inline-flex'; }); btn.onclick=async()=>{ if(!dp) return; dp.prompt(); await dp.userChoice; btn.style.display='none'; dp=null; }; })();

  /* ====== Supabase sync (–ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç–µ) ====== */
  async function sbGetUser(){ const {data:{user}}=await sb.auth.getUser(); return user; }
  function collectDailyFor(d){
    const s=ymd(d), out={};
    for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(!k) continue;
      if(k.startsWith('day:'+s)||k.startsWith('goal:'+s)||k.startsWith('n:'+s)||k.startsWith('state:'+s)||k.startsWith('metric:'+s)||k.startsWith('alpha:'+s)) out[k]=localStorage.getItem(k);
    } return out;
  }
  function collectWeeklyFor(d){ const w=isoWeek(d), out={}; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k?.startsWith('wgoal:'+w+':')) out[k]=localStorage.getItem(k);} return out; }
  function applyData(map){ Object.entries(map||{}).forEach(([k,v])=>localStorage.setItem(k,v)); }

  async function syncLoadFor(d){
    const user=await sbGetUser(); if(!user) return;
    const s=ymd(d), w=isoWeek(d);
    const {data:drow, error:e1}=await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',s).maybeSingle();
    if(e1) console.warn('daily_data load error', e1);
    applyData(drow?.data);
    const {data:wrow, error:e2}=await sb.from('weekly_data').select('data').eq('user_id',user.id).eq('week_id',w).maybeSingle();
    if(e2) console.warn('weekly_data load error', e2);
    applyData(wrow?.data);
    renderAll();
  }
  async function syncSaveFor(d){
    const user=await sbGetUser(); if(!user) return;
    const s=ymd(d), w=isoWeek(d);
    const daily=collectDailyFor(d), weekly=collectWeeklyFor(d);
    if(Object.keys(daily).length){
      const { error } = await sb.from('daily_data').upsert({user_id:user.id, ymd:s, data:daily,  updated_at:new Date().toISOString()},{onConflict:'user_id,ymd'});
      if(error) { console.warn('daily_data save error', error); alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–Ω—è: '+error.message); }
    }
    if(Object.keys(weekly).length){
      const { error } = await sb.from('weekly_data').upsert({user_id:user.id, week_id:w, data:weekly, updated_at:new Date().toISOString()},{onConflict:'user_id,week_id'});
      if(error) { console.warn('weekly_data save error', error); alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏: '+error.message); }
    }
  }
  let saveTimer; function scheduleSave(){ clearTimeout(saveTimer); saveTimer=setTimeout(()=>syncSaveFor(getViewDate()),800); }
  try{ sb.channel('changes')
      .on('postgres_changes',{event:'*',schema:'public',table:'daily_data'},()=>syncLoadFor(getViewDate()))
      .on('postgres_changes',{event:'*',schema:'public',table:'weekly_data'},()=>syncLoadFor(getViewDate()))
      .subscribe(); }catch(e){}

  /* ====== AUTH: Magic Link ====== */
  const loginBtn   = document.getElementById('loginBtn');
  const logoutBtn  = document.getElementById('logoutBtn');
  const whoamiEl   = document.getElementById('whoami');
  const emailInput = document.getElementById('emailInput');

  // –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π Redirect URL –¥–ª—è GitHub Pages (/tracker/)
  const REDIRECT_URL = (() => {
    const u = new URL(window.location.href);
    let p = u.pathname;
    if (p.endsWith('.html')) p = p.slice(0, p.lastIndexOf('/')+1);
    if (!p.endsWith('/')) p += '/';
    return `${u.origin}${p}`;
  })();

  loginBtn.onclick = async ()=>{
    const email = emailInput.value.trim();
    if(!email) return alert('–í–≤–µ–¥–∏ email');
    try {
      const { error } = await sb.auth.signInWithOtp({
        email,
        options: {
          shouldCreateUser: true,
          emailRedirectTo: REDIRECT_URL
        }
      });
      if (error) return alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
      alert('–ü–∏—Å—å–º–æ —Å–æ —Å—Å—ã–ª–∫–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û—Ç–∫—Ä–æ–π —Å—Å—ã–ª–∫—É —Å —ç—Ç–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞.');
    } catch (e) {
      alert('–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å URL –≤ Supabase (Site/Redirect URLs) –∏ –±–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫–∏.');
    }
  };

  logoutBtn.onclick = async ()=>{
    await sb.auth.signOut();
    whoamiEl.textContent = '';
    logoutBtn.style.display = 'none';
    alert('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞ –ø–æ magic link
  (async ()=>{
    try {
      // –î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ø–æ—Ç–æ–∫–æ–≤ (PKCE) —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Å–µ—Å—Å–∏—é ‚Äî –ø—Ä–æ–±—É–µ–º –º–æ–ª—á–∞
      try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(_) {}
      // –ß–∏—Å—Ç–∏–º URL –æ—Ç —Ö–≤–æ—Å—Ç–æ–≤ ?code= / #access_token=, —á—Ç–æ–±—ã –Ω–µ –º–µ—à–∞–ª–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
      if (/[?#].*(access_token|refresh_token|code)=/i.test(location.href)) {
        history.replaceState({}, document.title, REDIRECT_URL);
      }
      const { data:{ session } } = await sb.auth.getSession();
      const user = session?.user;
      whoamiEl.textContent = user ? ('‚Ä¢ ' + (user.email || user.id)) : '';
      logoutBtn.style.display = user ? 'inline-flex' : 'none';
      if (user) await syncLoadFor(getViewDate());
    } catch {}
  })();

  // –ü–æ–¥–ø–∏—Å–∫–∞ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ–º UI –ø–æ —Å–º–µ–Ω–µ —Å–µ—Å—Å–∏–∏
  sb.auth.onAuthStateChange(async (_e, session)=>{
    const user = session?.user;
    whoamiEl.textContent = user ? ('‚Ä¢ ' + (user.email || user.id)) : '';
    logoutBtn.style.display = user ? 'inline-flex' : 'none';
  });

  // ¬´–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏¬ª —Ç–æ–ª—å–∫–æ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–π –¥–∞—Ç—ã
  function toggleWeeklyVisibility(){ const sec=document.getElementById('weeklySection'); sec.style.display=(getViewDate().getDay()===0)?'block':'none'; }

  function renderAll(){ renderTabs(); renderSchedule(); renderMeals(); renderTotals(); renderDailyGoals(); renderWeeklyGoals(); renderStates(); renderHealth(); renderAlpha(); renderHealthWeeklyCard(); updateProgress(); toggleWeeklyVisibility(); }
  loadTimes(); renderAll();

  // –ù–∞–≤–∏–≥–∞—Ü–∏—è –Ω–µ–¥–µ–ª—å
  document.getElementById('prevWeekBtn').onclick=()=>{ viewWeekStart=addDays(viewWeekStart,-7); renderAll(); syncLoadFor(getViewDate()); };
  document.getElementById('nextWeekBtn').onclick=()=>{ viewWeekStart=addDays(viewWeekStart, 7); renderAll(); syncLoadFor(getViewDate()); };
  </script>
</body>
</html>
