<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä ‚Äî –ì–ª–∞–≤–Ω–∞—è</title>
<style>
  :root{--bg:#0f172a;--card:#0d1320;--muted:#94a3b8;--text:#e6eef8;--accent:#3b82f6;--danger:#ef4444;--border:#1f2937}
  [data-theme="light"]{--bg:#f7fafc;--card:#fff;--muted:#374151;--text:#0f172a;--accent:#2563eb;--danger:#dc2626;--border:#e5e7eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
  header{padding:12px 0;border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:white}
  .card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;margin-top:12px}
  .grid{display:grid;grid-template-columns:110px 1fr 44px;gap:8px;align-items:center}
  .row{display:contents}
  .time{color:var(--muted);font-variant-numeric:tabular-nums}
  .label{font-size:15px}
  input,textarea,select{font-size:15px;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
  .meal-kbju{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .kbju-field{display:flex;flex-direction:column;gap:6px}
  .chips{display:flex;gap:8px;overflow:auto}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  @media(max-width:560px){ .grid{grid-template-columns:88px 1fr 36px} }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>üìÖ –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</h1>
        <div id="dateLine" class="sub">‚Äî</div>
      </div>
      <div class="flex right">
        <button id="themeBtn" class="btn">üåô/‚òÄÔ∏è</button>
        <button id="saveAllBtn" class="btn primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="exportBtn" class="btn">–≠–∫—Å–ø–æ—Ä—Ç</button>
        <label class="btn"><input id="importInput" type="file" accept="application/json" style="display:none">–ò–º–ø–æ—Ä—Ç</label>
        <a class="btn" href="workout.html">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</a>
        <a class="btn" href="charts.html">–ì—Ä–∞—Ñ–∏–∫–∏</a>
      </div>
    </div>

    <div id="authBox" class="flex" style="margin-top:10px;align-items:center">
      <input id="emailInput" type="email" placeholder="Email –¥–ª—è –≤—Ö–æ–¥–∞ (magic link)" style="max-width:320px">
      <button id="loginBtn" class="btn">–í–æ–π—Ç–∏</button>
      <button id="logoutBtn" class="btn" style="display:none">–í—ã–π—Ç–∏</button>
      <div id="whoami" class="sub" style="margin-left:8px"></div>
    </div>
    <div class="flex" style="margin-top:10px;gap:8px">
      <button class="btn" id="prevWeekBtn">‚üµ –ù–µ–¥–µ–ª—è</button>
      <div class="btn" id="weekLabel">–ù–µ–¥–µ–ª—è ‚Äî</div>
      <button class="btn" id="nextWeekBtn">–ù–µ–¥–µ–ª—è ‚ü∂</button>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h3 style="margin:0">–ü–ª–∞–Ω –¥–Ω—è</h3>
    <div id="scheduleGrid" class="grid" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0">–ü–∏—Ç–∞–Ω–∏–µ</h3>
    <div id="nutritionArea"></div>
    <div id="nutritionTotals" style="margin-top:8px" class="small"></div>
    <div class="small" style="margin-top:8px">–ü–ª–∞–Ω: –ö–∞–ª–æ—Ä–∏–∏ ‚âà1950 –∫–∫–∞–ª, –ë–µ–ª–∫–∏ 210 –≥, –ñ–∏—Ä—ã 55 –≥, –£–≥–ª–µ–≤–æ–¥—ã 150 –≥. –ò—Ç–æ–≥ –æ–∫—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è: &gt;2000 ‚Äî –∫—Ä–∞—Å–Ω—ã–º, &lt;1500 ‚Äî —Å–∏–Ω–∏–º.</div>
  </section>

  <section class="card">
    <h3 style="margin:0">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ü–µ–ª–∏</h3>
    <div id="dailyGoals" style="margin-top:8px"></div>
  </section>

  <section class="card" id="weeklySection">
    <h3 style="margin:0">–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</h3>
    <div id="weeklyGoals" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0">–°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
    <div id="stateGrid" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0">–ó–¥–æ—Ä–æ–≤—å–µ</h3>
    <div id="healthGrid" style="margin-top:8px"></div>
  </section>
</main>

<footer class="wrap small" style="margin-bottom:24px">
  –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ Supabase. –õ–æ–∫–∞–ª—å–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ —Ç–µ–º–∞.
</footer>

<script>
/* ============ Supabase config (–ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –≤–∞—à–∏ –∑–Ω–∞—á–µ–Ω–∏—è) ============ */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* =================================================================== */

/* ============ Helpers & Dates ============ */
const pad=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function isoWeek(d){ const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-day+3); const first=new Date(Date.UTC(t.getUTCFullYear(),0,4)); const w=1+Math.round(((t-first)/86400000-3+((first.getUTCDay()+6)%7))/7); return `${t.getUTCFullYear()}-W${pad(w)}`;}
function startOfISOWeek(d){ const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day); t.setHours(0,0,0,0); return t;}
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

const today = new Date();
let viewWeekStart = startOfISOWeek(today);
let currentDay = (today.getDay()+6)%7;
function getViewDate(){ return addDays(viewWeekStart,currentDay); }

/* ============ Templates ============ */
const DAYS_FULL=['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
const baseDay=[
  ['05:30‚Äì06:00','–ü–æ–¥—ä—ë–º, –≤–æ–¥–∞, –¥—ã—Ö–∞–Ω–∏–µ, –∑–∞—Ä—è–¥–∫–∞'],
  ['06:00‚Äì07:00','–°–ø–æ—Ä—Ç'],
  ['07:00‚Äì07:30','–ó–∞–≤—Ç—Ä–∞–∫ (–±–µ–ª–æ–∫ + –æ–≤–æ—â–∏)'],
  ['08:00‚Äì08:40','–î–æ—Ä–æ–≥–∞ ‚Üí –∞—É–¥–∏–æ–∫–Ω–∏–≥–∞/–ø–æ–¥–∫–∞—Å—Ç'],
  ['09:00‚Äì13:00','–†–∞–±–æ—Ç–∞ (—Ñ–æ–∫—É—Å-–±–ª–æ–∫–∏)'],
  ['13:00‚Äì13:30','–û–±–µ–¥ + Duolingo'],
  ['13:30‚Äì18:00','–†–∞–±–æ—Ç–∞ (–≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏)'],
  ['18:00‚Äì18:40','–î–æ—Ä–æ–≥–∞ ‚Üí –∞–Ω–≥–ª. –ø–æ–¥–∫–∞—Å—Ç/–ª–µ–∫—Ü–∏—è'],
  ['19:00‚Äì20:00','–£–∂–∏–Ω (–ª—ë–≥–∫–∏–π –±–µ–ª–æ–∫ + –æ–≤–æ—â–∏)'],
  ['20:00‚Äì21:00','‚Äî —Å–≤–æ–±–æ–¥–Ω–æ–µ/—Å–µ–º—å—è ‚Äî'],
  ['21:00‚Äì21:30','–•–æ–±–±–∏ (–≥–∏—Ç–∞—Ä–∞/—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä)'],
  ['21:30‚Äì22:00','–ß—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥–∏'],
  ['22:00‚Äì22:30','–í–µ—á–µ—Ä–Ω–∏–π —Ä–∏—Ç—É–∞–ª, –¥—É—à'],
  ['22:30‚Äì06:00','–°–æ–Ω']
];
const sportPlan = {0:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',1:'–ë–µ–≥ —É–ª–∏—Ü–∞',2:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',3:'–ë–µ–≥ —É–ª–∏—Ü–∞',4:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',5:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',6:'–§—É—Ç–±–æ–ª'};
const MEALS=['–ó–∞–≤—Ç—Ä–∞–∫','–û–±–µ–¥','–£–∂–∏–Ω','–ü–µ—Ä–µ–∫—É—Å—ã'];
const N_FIELDS=['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)','–ë–µ–ª–∫–∏ (–≥)','–ñ–∏—Ä—ã (–≥)','–£–≥–ª–µ–≤–æ–¥—ã (–≥)'];
const goalsDaily=['7+ —á–∞—Å–æ–≤ —Å–Ω–∞','Duolingo 15‚Äì30 –º–∏–Ω','–ê—É–¥–∏–æ –≤ –¥–æ—Ä–æ–≥–µ','20+ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏','–ü–∏—Ç–∞–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É','–°–ø–æ—Ä—Ç –¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω'];
const goalsWeekly=['5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫','2√ó —Å–∏–ª–æ–≤—ã–µ','2√ó —Ñ—É—Ç–±–æ–ª','2√ó –±–µ–≥','7√ó Duolingo','7√ó —á—Ç–µ–Ω–∏–µ','–ü–ª–∞–Ω –Ω–µ–¥–µ–ª–∏'];

/* ============ DOM refs ============ */
const dateLine = document.getElementById('dateLine');
const scheduleGrid = document.getElementById('scheduleGrid');
const nutritionArea = document.getElementById('nutritionArea');
const nutritionTotals = document.getElementById('nutritionTotals');
const dailyGoalsDiv = document.getElementById('dailyGoals');
const weeklyGoalsDiv = document.getElementById('weeklyGoals');
const stateGrid = document.getElementById('stateGrid');
const healthGrid = document.getElementById('healthGrid');
const weekLabel = document.getElementById('weekLabel');

/* ============ Auth UI ============ */
const emailInput = document.getElementById('emailInput');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const whoami = document.getElementById('whoami');
const saveAllBtn = document.getElementById('saveAllBtn');

loginBtn.onclick = async ()=>{
  const email = emailInput.value.trim(); if(!email) return alert('–í–≤–µ–¥–∏—Ç–µ email');
  const { error } = await sb.auth.signInWithOtp({ email, options:{ emailRedirectTo: window.location.href } });
  if(error) alert('–û—à–∏–±–∫–∞: '+error.message); else alert('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –≤—Ö–æ–¥–∞.');
};

logoutBtn.onclick = async ()=>{ await sb.auth.signOut(); location.reload(); };

/* ============ UI helpers ============ */
function makeRow(time,label,checked,onchange,key){
  const t=document.createElement('div'); t.className='row';
  const c1=document.createElement('div'); c1.className='time'; c1.textContent=time; t.appendChild(c1);
  const c2=document.createElement('div'); c2.className='label'; c2.textContent=label; t.appendChild(c2);
  const c3=document.createElement('div'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=checked; cb.onchange=()=>onchange(cb.checked); c3.appendChild(cb); cb.setAttribute('data-key',key); t.appendChild(c3);
  return t;
}

/* ============ Renderers ============ */
/* Cloud-first: render UI using dataMap (map from cloud row.data) */
function renderTabs(){
  const tabs = document.getElementById('dayTabs') || document.createElement('div');
  tabs.innerHTML = '';
  DAYS_FULL.forEach((name,i)=>{
    const b=document.createElement('button'); b.className='tab'+(i===currentDay?' active':''); b.textContent=name;
    b.onclick=()=>{ currentDay=i; document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); b.classList.add('active'); renderAll(); };
    tabs.appendChild(b);
  });
  const vd = getViewDate();
  dateLine.textContent = `${DAYS_FULL[currentDay]} ‚Ä¢ ${ymd(vd)}`;
  weekLabel.textContent = `–ù–µ–¥–µ–ª—è ${isoWeek(vd)}`;
}

async function renderSchedule(dataMap){
  scheduleGrid.innerHTML=''; const vd=getViewDate();
  sportPlan && (document.getElementById('sportPill') && (document.getElementById('sportPill').textContent=`–°–ø–æ—Ä—Ç –¥–Ω—è: ${sportPlan[currentDay]}`));
  baseDay.forEach((it,idx)=>{
    const key = `day:${ymd(vd)}:${idx}`;
    const checked = dataMap?.[key] === '1';
    const row = makeRow(it[0], it[1], checked, async (val)=>{
      const user = (await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
      const date = ymd(vd);
      const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
      const existing = (remote && remote.data) ? remote.data : {};
      existing[key] = val ? '1' : null;
      Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
      if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd',date);
      else await sb.from('daily_data').upsert({ user_id:user.id, ymd:date, data: existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
      await syncLoadFor(vd);
    }, key);
    scheduleGrid.appendChild(row);
  });
}

function renderNutrition(dataMap){
  nutritionArea.innerHTML='';
  const vd=getViewDate();
  const header=document.createElement('div'); header.className='row'; header.innerHTML='<div class="time">–ü—Ä–∏—ë–º</div><div class="label">–ö–ë–ñ–£</div><div></div>'; nutritionArea.appendChild(header);
  MEALS.forEach(meal=>{
    const row=document.createElement('div'); row.className='row';
    const c1=document.createElement('div'); c1.className='time'; c1.textContent=meal; row.appendChild(c1);
    const c2=document.createElement('div'); c2.className='label';
    const grid=document.createElement('div'); grid.className='meal-kbju';
    N_FIELDS.forEach(field=>{
      const fld=document.createElement('div'); fld.className='kbju-field';
      const lbl=document.createElement('label'); lbl.textContent=field.split(' ')[0];
      const inp=document.createElement('input'); inp.type='number'; inp.placeholder='0';
      const key = `n:${ymd(vd)}:${meal}:${field}`;
      inp.value = dataMap?.[key] ?? '';
      inp.onchange = async ()=>{
        const user = (await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
        const date=ymd(vd);
        const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
        const existing = (remote && remote.data) ? remote.data : {};
        existing[key] = inp.value ? String(inp.value) : null;
        Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
        if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd',date);
        else await sb.from('daily_data').upsert({ user_id:user.id, ymd:date, data: existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
        await syncLoadFor(vd);
      };
      fld.appendChild(lbl); fld.appendChild(inp); grid.appendChild(fld);
    });
    c2.appendChild(grid); row.appendChild(c2); row.appendChild(document.createElement('div')); nutritionArea.appendChild(row);
  });
  renderNutritionTotals(dataMap);
}
function renderNutritionTotals(dataMap){
  const vd=getViewDate();
  const sums={'–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)':0,'–ë–µ–ª–∫–∏ (–≥)':0,'–ñ–∏—Ä—ã (–≥)':0,'–£–≥–ª–µ–≤–æ–¥—ã (–≥)':0};
  MEALS.forEach(m=>N_FIELDS.forEach(f=>{ const v=dataMap?.[`n:${ymd(vd)}:${m}:${f}`]; sums[f]+= v ? Number(v) : 0; }));
  nutritionTotals.textContent = `–ò—Ç–æ–≥–æ: ${sums['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)']} –∫–∫–∞–ª ‚Ä¢ –ë ${sums['–ë–µ–ª–∫–∏ (–≥)']} –≥ ‚Ä¢ –ñ ${sums['–ñ–∏—Ä—ã (–≥)']} –≥ ‚Ä¢ –£ ${sums['–£–≥–ª–µ–≤–æ–¥—ã (–≥)']} –≥`;
  if(sums['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)']>2000) nutritionTotals.style.color='var(--danger)';
  else if(sums['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)']<1500) nutritionTotals.style.color='#2563eb';
  else nutritionTotals.style.color='';
}

function renderDailyGoals(dataMap){
  dailyGoalsDiv.innerHTML='';
  const vd=getViewDate();
  goalsDaily.forEach((lab,idx)=>{
    const key = `goal:${ymd(vd)}:${idx}`; const checked = dataMap?.[key] === '1';
    const row = makeRow('‚Äî', lab, checked, async (val)=>{
      const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
      const date=ymd(vd); const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
      const existing=(remote && remote.data)?remote.data:{};
      existing[key]=val? '1':null; Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
      if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd',date);
      else await sb.from('daily_data').upsert({ user_id:user.id, ymd:date, data:existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
      await syncLoadFor(vd);
    }, key);
    dailyGoalsDiv.appendChild(row);
  });
}

function renderWeeklyGoals(dataMap){
  weeklyGoalsDiv.innerHTML=''; const vd=getViewDate(); const w=isoWeek(vd);
  goalsWeekly.forEach((lab,idx)=>{
    const key = `wgoal:${w}:${idx}`; const checked = dataMap?.[key] === '1';
    const row = makeRow('–ù–µ–¥–µ–ª—è', lab, checked, async (val)=>{
      const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
      const { data: remote } = await sb.from('weekly_data').select('data').eq('user_id',user.id).eq('week_id',w).maybeSingle();
      const existing=(remote && remote.data)?remote.data:{};
      existing[key]=val?'1':null; Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
      if(Object.keys(existing).length===0) await sb.from('weekly_data').delete().eq('user_id',user.id).eq('week_id',w);
      else await sb.from('weekly_data').upsert({ user_id:user.id, week_id:w, data:existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,week_id' });
      await syncLoadFor(vd);
    }, key);
    weeklyGoalsDiv.appendChild(row);
  });
}

const stateOptions=[{v:1,label:'üòñ'},{v:2,label:'üòï'},{v:3,label:'üòê'},{v:4,label:'üôÇ'},{v:5,label:'üòÑ'}];
function renderStates(dataMap){
  stateGrid.innerHTML=''; const vd=getViewDate();
  ['mood','body'].forEach(type=>{
    const box=document.createElement('div'); box.style.margin='8px 0';
    const title=document.createElement('div'); title.className='small'; title.textContent = type==='mood' ? '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ' : '–§–∏–∑–∏—á–µ—Å–∫–∏';
    box.appendChild(title);
    const chips=document.createElement('div'); chips.className='chips';
    stateOptions.forEach(opt=>{
      const b=document.createElement('button'); b.className='chip'; b.textContent=opt.label;
      const key=`state:${ymd(vd)}:${type}`;
      if(dataMap?.[key]==String(opt.v)) b.style.outline='2px solid var(--accent)';
      b.onclick=async ()=>{
        const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
        const date=ymd(vd); const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
        const existing=(remote && remote.data)?remote.data:{};
        existing[key]=String(opt.v); Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
        if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd',date);
        else await sb.from('daily_data').upsert({ user_id:user.id, ymd:date, data:existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
        await syncLoadFor(vd);
      };
      chips.appendChild(b);
    });
    box.appendChild(chips); stateGrid.appendChild(box);
  });
}

function renderHealth(dataMap){
  healthGrid.innerHTML=''; const vd=getViewDate();
  // weight daily
  const row=document.createElement('div'); row.className='row';
  const t=document.createElement('div'); t.className='time'; t.textContent='–í–µ—Å (–∫–≥)'; row.appendChild(t);
  const c=document.createElement('div'); c.className='label';
  const inp=document.createElement('input'); inp.type='number'; inp.step='0.1'; inp.value = dataMap?.[`metric:${ymd(vd)}:weight`] ?? '';
  inp.onchange = async ()=>{
    const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
    const date=ymd(vd);
    const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
    const existing=(remote && remote.data)?remote.data:{};
    existing[`metric:${date}:weight`] = inp.value ? String(inp.value) : null;
    Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
    if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd',date);
    else await sb.from('daily_data').upsert({ user_id:user.id, ymd:date, data:existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
    await syncLoadFor(vd);
  };
  c.appendChild(inp); row.appendChild(c); row.appendChild(document.createElement('div')); healthGrid.appendChild(row);

  // Sunday circumferences
  const isSunday = getViewDate().getDay()===0;
  if(isSunday){
    ['waist','biceps','quad'].forEach(k=>{
      const r=document.createElement('div'); r.className='row';
      const tt=document.createElement('div'); tt.className='time'; tt.textContent = k==='waist'?'–û–±—ä–µ–º –∂–∏–≤–æ—Ç–∞':k==='biceps'?'–û–±—ä—ë–º –±–∏—Ü–µ–ø—Å–∞':'–û–±—ä—ë–º –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å–∞';
      r.appendChild(tt);
      const cc=document.createElement('div'); cc.className='label';
      const ii=document.createElement('input'); ii.type='number'; ii.step='0.1'; ii.value = dataMap?.[`circ:${ymd(vd)}:${k}`] ?? '';
      ii.onchange = async ()=>{
        const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ');
        const date=ymd(vd);
        const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
        const existing=(remote && remote.data)?remote.data:{};
        existing[`circ:${date}:${k}`] = ii.value ? String(ii.value) : null;
        Object.keys(existing).forEach(x=>{ if(existing[x]==null) delete existing[x]; });
        if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd',date);
        else await sb.from('daily_data').upsert({ user_id:user.id, ymd:date, data:existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
        await syncLoadFor(vd);
      };
      cc.appendChild(ii); r.appendChild(cc); r.appendChild(document.createElement('div')); healthGrid.appendChild(r);
    });
  }
}

/* ============ Cloud load/save ============ */
async function syncLoadFor(d){
  const userResp = await sb.auth.getUser();
  const user = userResp.data?.user || null;
  const vd = d || getViewDate();
  if(!user){
    // unauthenticated: show empty UI
    renderSchedule({});
    renderNutrition({});
    renderDailyGoals({});
    renderWeeklyGoals({});
    renderStates({});
    renderHealth({});
    document.getElementById('weeklySection').style.display = (vd.getDay()===0)?'block':'none';
    logoutBtn.style.display='none'; whoami.textContent='';
    return;
  }
  logoutBtn.style.display='inline-flex'; whoami.textContent = '‚Ä¢ '+(user.email||user.id);

  const date = ymd(vd), week = isoWeek(vd);
  const { data: drow } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd',date).maybeSingle();
  const { data: wrow } = await sb.from('weekly_data').select('data').eq('user_id',user.id).eq('week_id',week).maybeSingle();

  const dailyMap = (drow && drow.data)? drow.data : {};
  const weeklyMap = (wrow && wrow.data)? wrow.data : {};

  // render UI
  renderSchedule(dailyMap);
  renderNutrition(dailyMap);
  renderDailyGoals(dailyMap);
  renderWeeklyGoals(weeklyMap);
  renderStates(dailyMap);
  renderHealth(dailyMap);
  document.getElementById('weeklySection').style.display = (vd.getDay()===0)?'block':'none';
}

/* save full day via reload (we rely on immediate saves in handlers; this triggers reload) */
async function saveFullDay(){ await syncLoadFor(getViewDate()); alert('–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ'); }

/* Export/Import (JSON) */
document.getElementById('exportBtn').onclick = async ()=>{
  const userResp = await sb.auth.getUser();
  const user = userResp.data?.user || null;
  if(!user) return alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
  const { data } = await sb.from('daily_data').select('ymd,data').eq('user_id',user.id);
  const { data: wdata } = await sb.from('weekly_data').select('week_id,data').eq('user_id',user.id);
  const out = { daily: data || [], weekly: wdata || [] };
  const blob = new Blob([JSON.stringify(out,null,2)],{type:'application/json'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='tracker-export.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);
};
document.getElementById('importInput').onchange = async (e)=>{
  const f = e.target.files[0]; if(!f) return;
  const txt = await f.text(); try{ const obj=JSON.parse(txt); const userResp = await sb.auth.getUser(); const user = userResp.data?.user || null; if(!user) return alert('–í–æ–π–¥–∏—Ç–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞');
    // import daily
    for(const row of obj.daily||[]){ if(row.ymd && row.data) await sb.from('daily_data').upsert({ user_id:user.id, ymd:row.ymd, data:row.data, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' }); }
    for(const row of obj.weekly||[]){ if(row.week_id && row.data) await sb.from('weekly_data').upsert({ user_id:user.id, week_id:row.week_id, data:row.data, updated_at:new Date().toISOString() }, { onConflict:'user_id,week_id' }); }
    await syncLoadFor(getViewDate()); alert('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
  }catch(err){ alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: '+err.message); }
};

/* realtime */
try{
  sb.channel('app-changes')
    .on('postgres_changes',{event:'*',schema:'public',table:'daily_data'},()=>syncLoadFor(getViewDate()).catch(()=>{}))
    .on('postgres_changes',{event:'*',schema:'public',table:'weekly_data'},()=>syncLoadFor(getViewDate()).catch(()=>{}))
    .subscribe();
}catch(e){ console.warn('Realtime not available',e); }

/* navigation */
document.getElementById('prevWeekBtn').onclick = ()=>{ viewWeekStart = addDays(viewWeekStart,-7); renderAll(); syncLoadFor(getViewDate()).catch(()=>{}); };
document.getElementById('nextWeekBtn').onclick = ()=>{ viewWeekStart = addDays(viewWeekStart,7); renderAll(); syncLoadFor(getViewDate()).catch(()=>{}); };

/* auth state on load */
sb.auth.onAuthStateChange(async (_e, session)=>{ const user = session?.user || null; if(user){ logoutBtn.style.display='inline-flex'; whoami.textContent='‚Ä¢ '+(user.email||user.id); await syncLoadFor(getViewDate()); } else { logoutBtn.style.display='none'; whoami.textContent=''; await syncLoadFor(getViewDate()); } });

/* theme */
document.getElementById('themeBtn').onclick = ()=>{ const cur=document.documentElement.getAttribute('data-theme'); document.documentElement.setAttribute('data-theme', cur==='dark'?'light':'dark'); localStorage.setItem('theme', document.documentElement.getAttribute('data-theme')); };
document.documentElement.setAttribute('data-theme', localStorage.getItem('theme')||'dark');

/* button bindings */
saveAllBtn.onclick = saveFullDay;

/* initial render */
renderTabs();
syncLoadFor(getViewDate()).catch(()=>{});

function renderAll(){ syncLoadFor(getViewDate()).catch(()=>{}); }
</script>
</body>
</html>
