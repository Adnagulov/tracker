<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Тренировка дня</title>
<style>
 :root{--bg:#0f172a;--card:#0d1320;--muted:#94a3b8;--text:#e6eef8;--border:#1f2937}
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui;padding:12px}
 .card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;margin-bottom:12px}
 .flex{display:flex;gap:8px;align-items:center}
 .square{width:44px;height:44px;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer}
 .small{font-size:13px;color:var(--muted)}
 @media(max-width:560px){ .square{width:36px;height:36px} }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><h2 style="margin:0">Тренировка</h2><div id="dateTitle" class="small"></div></div>
    <div><a class="small" href="index.html">← Назад</a></div>
  </div>
</div>

<div id="programWrap"></div>

<div style="position:fixed;left:12px;bottom:12px">
  <button id="syncBtn" class="btn">Sync (в облако)</button>
  <span id="syncStatus" class="small" style="margin-left:8px">локально</span>
</div>

<script>
/* Supabase */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* program */
const WEEK_PROGRAM = {
  0:{title:'Понедельник',place:'Силовая дома',ex:[
    {id:'sq',title:'Присед с гирей 4x12',sets:4},
    {id:'lung',title:'Выпады с гантелями 3x10/нога',sets:3},
    {id:'press',title:'Жим гантелей лёжа 4x12',sets:4},
    {id:'curl',title:'Подъём гантелей на бицепс 3x12',sets:3},
    {id:'plank',title:'Планка 3x60с',sets:3}
  ]},
  1:{title:'Вторник',place:'Бег улица',ex:[
    {id:'tempo',title:'Темповый бег 30–40 мин',metrics:['Время (мин)','Средняя скорость','Средний пульс']},
    {id:'stretch',title:'Растяжка 10 мин',sets:1}
  ]},
  2:{title:'Среда',place:'Силовая улица',ex:[
    {id:'pull',title:'Подтягивания 4xmax',sets:4},{id:'dips',title:'Брусья 4xmax',sets:4},{id:'aus',title:'Австралийские подтягивания 3x12',sets:3},{id:'leglift',title:'Подъём ног в висе 3xmax',sets:3}
  ]},
  3:{title:'Четверг',place:'Бег улица',ex:[
    {id:'intervals',title:'Интервалы 8–10×(1 мин быстрый/90 сек шаг)',metrics:['Подходы выполнено']}
  ]},
  4:{title:'Пятница',place:'Силовая дома',ex:[
    {id:'row',title:'Тяга гири в наклоне 4x12',sets:4},{id:'ohp',title:'Жим гири 3x10/рука',sets:3},{id:'push',title:'Отжимания 4x15',sets:4},{id:'bridge',title:'Ягодичный мостик 3x15',sets:3},{id:'abs',title:'Скручивания 3x20',sets:3}
  ]},
  5:{title:'Суббота',place:'Силовая улица',ex:[
    {id:'pull2',title:'Подтягивания 4xmax',sets:4},{id:'dips2',title:'Отжимания на брусьях 4xmax',sets:4},{id:'push2',title:'Отжимания 3x15',sets:3},{id:'sideplank',title:'Планка боковая 3x30с/сторона',sets:3}
  ]},
  6:{title:'Воскресенье',place:'Футбол',ex:[
    {id:'football',title:'Футбол 60–90 мин',metrics:['Минуты','Спринты 10×100м выполнены?']}
  ]}
};

const pad=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const today = new Date(); const dayIndex = (today.getDay()+6)%7;

document.getElementById('dateTitle').textContent = `${ymd(today)} • ${WEEK_PROGRAM[dayIndex].title}`;

function getLocalMapForToday(){
  const out = {};
  const prefix = ymd(today);
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.includes(prefix)) out[k] = localStorage.getItem(k);
  }
  return out;
}

function createSquare(checked){ const b=document.createElement('div'); b.className='square'; b.textContent = checked ? '✔' : ''; return b; }

async function renderProgram(){
  programWrap.innerHTML = '';
  const dayProg = WEEK_PROGRAM[dayIndex];
  const map = getLocalMapForToday();
  dayProg.ex.forEach(ex=>{
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent = ex.title; card.appendChild(h);
    if(ex.sets){
      const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='8px';
      for(let s=0;s<ex.sets;s++){
        const key = `w:${ymd(today)}:${ex.id}:${s}`;
        const checked = map[key] === '1';
        const sq = createSquare(checked);
        sq.onclick = ()=>{
          // toggle local
          if(localStorage.getItem(key) === '1') localStorage.removeItem(key);
          else localStorage.setItem(key,'1');
          renderProgram();
        };
        wrap.appendChild(sq);
      }
      card.appendChild(wrap);
    }
    if(ex.metrics){
      ex.metrics.forEach((m,mi)=>{
        const div=document.createElement('div'); div.style.marginTop='8px';
        const label=document.createElement('div'); label.className='small'; label.textContent = m; div.appendChild(label);
        const inp=document.createElement('input'); inp.type='text';
        const key = `w:${ymd(today)}:metric:${ex.id}:${mi}`;
        inp.value = map[key] || '';
        inp.onchange = ()=> { if(inp.value) localStorage.setItem(key, String(inp.value)); else localStorage.removeItem(key); };
        div.appendChild(inp);
        card.appendChild(div);
      });
    }
    programWrap.appendChild(card);
  });
}

document.getElementById('syncBtn').onclick = async ()=>{
  // reuse syncUp from index.html style
  const { data: userResp } = await sb.auth.getUser().catch(()=>({data:{user:null}}));
  const user = userResp?.user;
  if(!user) return alert('Для синхронизации войдите на главной странице (magic link).');
  const dateStr = ymd(today);
  // collect local keys for today
  const local = getLocalMapForToday();
  const dailyData = {};
  const weeklyData = {};
  Object.entries(local).forEach(([k,v])=>{
    if(k.startsWith('wgoal:') || k.startsWith('w:')) weeklyData[k] = v;
    else dailyData[k] = v;
  });
  try{
    if(Object.keys(dailyData).length) await sb.from('daily_data').upsert({ user_id:user.id, ymd: dateStr, data: dailyData, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
    else await sb.from('daily_data').delete().eq('user_id', user.id).eq('ymd', dateStr);
    if(Object.keys(weeklyData).length) await sb.from('weekly_data').upsert({ user_id:user.id, week_id: (function(){const d=new Date(); const day=(d.getDay()+6)%7; return isoWeek(d); })(), data: weeklyData, updated_at:new Date().toISOString() }, { onConflict:'user_id,week_id' });
    else {/* nothing */}
    document.getElementById('syncStatus').textContent = 'синхронизировано';
    alert('Синхронизировано в облако');
  }catch(err){ console.error(err); alert('Ошибка синхронизации: '+(err.message||err)); }
};

function isoWeek(d){ const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-day+3); const first=new Date(Date.UTC(t.getUTCFullYear(),0,4)); const w=1+Math.round(((t-first)/86400000-3+((first.getUTCDay()+6)%7))/7); return `${t.getUTCFullYear()}-W${String(w).padStart(2,'0')}`; }

renderProgram();
</script>
</body>
</html>
