<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä ‚Äî –ì–ª–∞–≤–Ω–∞—è</title>
<style>
  :root{--bg:#0f172a;--card:#0d1320;--muted:#94a3b8;--text:#e6eef8;--accent:#3b82f6;--danger:#ef4444;--border:#1f2937}
  [data-theme="light"]{--bg:#fff;--card:#f8fafc;--muted:#374151;--text:#0f172a;--accent:#2563eb}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
  header{padding:12px;border-bottom:1px solid var(--border)}
  .wrap{max-width:980px;margin:0 auto;padding:12px}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-weight:700}
  .btn.primary{background:var(--accent);color:white}
  .card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;margin-top:12px}
  .grid{display:grid;grid-template-columns:110px 1fr 44px;gap:8px;align-items:center}
  .row{display:contents}
  .time{color:var(--muted);font-variant-numeric:tabular-nums}
  .label{font-size:15px}
  input,textarea,select{font-size:15px;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}
  .meal-kbju{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
  .kbju-field{display:flex;flex-direction:column;gap:6px}
  .chips{display:flex;gap:8px;overflow:auto}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:transparent;cursor:pointer}
  .small{font-size:13px;color:var(--muted)}
  .status{font-size:13px;color:var(--muted);margin-left:8px}
  @media(max-width:560px){ .grid{grid-template-columns:88px 1fr 36px} .meal-kbju{grid-template-columns:1fr} }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>üìÖ –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</h1>
        <div id="dateLine" class="sub">‚Äî</div>
        <div style="margin-top:8px" class="flex">
          <div class="small" id="sportPill">–°–ø–æ—Ä—Ç –¥–Ω—è: ‚Äî</div>
          <div class="small" id="sleepPill" style="margin-left:8px">–°–æ–Ω: 22:30 ‚Üí 06:00</div>
          <div class="small" style="margin-left:8px">–¶–µ–ª—å –≤–µ—Å–∞: 80 –∫–≥</div>
        </div>
      </div>
      <div class="flex right">
        <button id="themeBtn" class="btn">üåô/‚òÄÔ∏è</button>
        <button id="syncDownBtn" class="btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ –æ–±–ª–∞–∫–∞</button>
        <button id="syncUpBtn" class="btn primary">Sync (–≤ –æ–±–ª–∞–∫–æ)</button>
        <a class="btn" href="workout.html">–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞</a>
        <a class="btn" href="charts.html">–ì—Ä–∞—Ñ–∏–∫–∏</a>
      </div>
    </div>

    <div id="authBox" class="flex" style="margin-top:10px;align-items:center">
      <input id="emailInput" type="email" placeholder="Email –¥–ª—è –≤—Ö–æ–¥–∞ (magic link)" style="max-width:320px">
      <button id="loginBtn" class="btn">–í–æ–π—Ç–∏</button>
      <button id="logoutBtn" class="btn" style="display:none">–í—ã–π—Ç–∏</button>
      <div id="authStatus" class="status">Offline / –ª–æ–∫–∞–ª—å–Ω–æ</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <h3 style="margin:0">–ü–ª–∞–Ω –¥–Ω—è</h3>
    <div id="scheduleGrid" class="grid" style="margin-top:10px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0">–ü–∏—Ç–∞–Ω–∏–µ</h3>
    <div id="nutritionArea"></div>
    <div id="nutritionTotals" style="margin-top:8px" class="small"></div>
    <div class="small" style="margin-top:8px">–ü–ª–∞–Ω: –ö–∞–ª–æ—Ä–∏–∏ ‚âà1950 –∫–∫–∞–ª, –ë–µ–ª–∫–∏ 210 –≥, –ñ–∏—Ä—ã 55 –≥, –£–≥–ª–µ–≤–æ–¥—ã 150 –≥. –ò—Ç–æ–≥: &gt;2000 ‚Äî –∫—Ä–∞—Å–Ω—ã–π; &lt;1500 ‚Äî —Å–∏–Ω–∏–π.</div>
  </section>

  <section class="card">
    <h3 style="margin:0">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Ü–µ–ª–∏</h3>
    <div id="dailyGoals" style="margin-top:8px"></div>
  </section>

  <section class="card" id="weeklySection">
    <h3 style="margin:0">–ò—Ç–æ–≥–∏ –Ω–µ–¥–µ–ª–∏</h3>
    <div id="weeklyGoals" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0">–°–æ—Å—Ç–æ—è–Ω–∏–µ</h3>
    <div id="stateGrid" style="margin-top:8px"></div>
  </section>

  <section class="card">
    <h3 style="margin:0">–ó–¥–æ—Ä–æ–≤—å–µ</h3>
    <div id="healthGrid" style="margin-top:8px"></div>
  </section>
</main>

<footer class="wrap small" style="margin-bottom:24px">
  –î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏ –º–æ–≥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å—Å—è —Å Supabase. –ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ–±–ª–∞–∫–æ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É Sync.
</footer>

<script>
/* ================= CONFIG ================= */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* ========================================== */

/* ========== Utilities & date helpers ========== */
const pad = n => String(n).padStart(2,'0');
const ymd = d => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
function isoWeek(d){ const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-day+3); const first=new Date(Date.UTC(t.getUTCFullYear(),0,4)); const w=1+Math.round(((t-first)/86400000-3+((first.getUTCDay()+6)%7))/7); return `${t.getUTCFullYear()}-W${pad(w)}`; }
function startOfISOWeek(d){ const t=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const day=(t.getDay()+6)%7; t.setDate(t.getDate()-day); t.setHours(0,0,0,0); return t; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

const today = new Date();
let viewWeekStart = startOfISOWeek(today);
let currentDay = (today.getDay()+6)%7;
function getViewDate(){ return addDays(viewWeekStart, currentDay); }

/* ========== Templates ========== */
const DAYS_FULL = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];
const baseDay = [
  ['05:30‚Äì06:00','–ü–æ–¥—ä—ë–º, –≤–æ–¥–∞, –¥—ã—Ö–∞–Ω–∏–µ, –∑–∞—Ä—è–¥–∫–∞'],
  ['06:00‚Äì07:00','–°–ø–æ—Ä—Ç'],
  ['07:00‚Äì07:30','–ó–∞–≤—Ç—Ä–∞–∫ (–±–µ–ª–æ–∫ + –æ–≤–æ—â–∏)'],
  ['08:00‚Äì08:40','–î–æ—Ä–æ–≥–∞ ‚Üí –∞—É–¥–∏–æ–∫–Ω–∏–≥–∞/–ø–æ–¥–∫–∞—Å—Ç'],
  ['09:00‚Äì13:00','–†–∞–±–æ—Ç–∞ (—Ñ–æ–∫—É—Å-–±–ª–æ–∫–∏)'],
  ['13:00‚Äì13:30','–û–±–µ–¥ + Duolingo'],
  ['13:30‚Äì18:00','–†–∞–±–æ—Ç–∞ (–≤–∞–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏)'],
  ['18:00‚Äì18:40','–î–æ—Ä–æ–≥–∞ ‚Üí –∞–Ω–≥–ª. –ø–æ–¥–∫–∞—Å—Ç/–ª–µ–∫—Ü–∏—è'],
  ['19:00‚Äì20:00','–£–∂–∏–Ω (–ª—ë–≥–∫–∏–π –±–µ–ª–æ–∫ + –æ–≤–æ—â–∏)'],
  ['20:00‚Äì21:00','‚Äî —Å–≤–æ–±–æ–¥–Ω–æ–µ/—Å–µ–º—å—è ‚Äî'],
  ['21:00‚Äì21:30','–•–æ–±–±–∏ (–≥–∏—Ç–∞—Ä–∞/—Å–∏–Ω—Ç–µ–∑–∞—Ç–æ—Ä)'],
  ['21:30‚Äì22:00','–ß—Ç–µ–Ω–∏–µ –∫–Ω–∏–≥–∏'],
  ['22:00‚Äì22:30','–í–µ—á–µ—Ä–Ω–∏–π —Ä–∏—Ç—É–∞–ª, –¥—É—à'],
  ['22:30‚Äì06:00','–°–æ–Ω']
];
const sportPlan = {0:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',1:'–ë–µ–≥ —É–ª–∏—Ü–∞',2:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',3:'–ë–µ–≥ —É–ª–∏—Ü–∞',4:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',5:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',6:'–§—É—Ç–±–æ–ª'};
const MEALS = ['–ó–∞–≤—Ç—Ä–∞–∫','–û–±–µ–¥','–£–∂–∏–Ω','–ü–µ—Ä–µ–∫—É—Å—ã'];
const N_FIELDS = ['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)','–ë–µ–ª–∫–∏ (–≥)','–ñ–∏—Ä—ã (–≥)','–£–≥–ª–µ–≤–æ–¥—ã (–≥)'];
const goalsDaily = ['7+ —á–∞—Å–æ–≤ —Å–Ω–∞','Duolingo 15‚Äì30 –º–∏–Ω','–ê—É–¥–∏–æ –≤ –¥–æ—Ä–æ–≥–µ','20+ —Å—Ç—Ä–∞–Ω–∏—Ü –∫–Ω–∏–≥–∏','–ü–∏—Ç–∞–Ω–∏–µ –ø–æ –ø–ª–∞–Ω—É','–°–ø–æ—Ä—Ç –¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω'];
const goalsWeekly = ['5+ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫','2√ó —Å–∏–ª–æ–≤—ã–µ','2√ó —Ñ—É—Ç–±–æ–ª','2√ó –±–µ–≥','7√ó Duolingo','7√ó —á—Ç–µ–Ω–∏–µ','–ü–ª–∞–Ω –Ω–µ–¥–µ–ª–∏'];

/* ========== Keys ========== */
const DAY_KEY = (d,i) => `day:${ymd(d)}:${i}`;
const GOAL_KEY = (d,i) => `goal:${ymd(d)}:${i}`;
const WEEK_KEY = (w,i) => `wgoal:${w}:${i}`;
const NF_KEY = (d,meal,field) => `n:${ymd(d)}:${meal}:${field}`;
const STATE_KEY = (d,type) => `state:${ymd(d)}:${type}`;
const METRIC_KEY = (d,name) => `metric:${ymd(d)}:${name}`;
const CIRC_KEY = (d,name) => `circ:${ymd(d)}:${name}`;

/* ========== DOM refs ========== */
const dateLine = document.getElementById('dateLine');
const scheduleGrid = document.getElementById('scheduleGrid');
const nutritionArea = document.getElementById('nutritionArea');
const nutritionTotals = document.getElementById('nutritionTotals');
const dailyGoalsDiv = document.getElementById('dailyGoals');
const weeklyGoalsDiv = document.getElementById('weeklyGoals');
const stateGrid = document.getElementById('stateGrid');
const healthGrid = document.getElementById('healthGrid');
const authStatus = document.getElementById('authStatus');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const emailInput = document.getElementById('emailInput');
const syncUpBtn = document.getElementById('syncUpBtn');
const syncDownBtn = document.getElementById('syncDownBtn');
const themeBtn = document.getElementById('themeBtn');

/* ========== Auth handlers (magic link) ========== */
loginBtn.onclick = async () => {
  const email = emailInput.value.trim();
  if(!email) return alert('–í–≤–µ–¥–∏—Ç–µ email');
  try {
    const { error } = await sb.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
    if(error) alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + error.message);
    else alert('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ. –û—Ç–∫—Ä–æ–π—Ç–µ —Å—Å—ã–ª–∫—É –∏–∑ –ø–∏—Å—å–º–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –≤—Ö–æ–¥–∞.');
  } catch(err) { alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + err.message); }
};
logoutBtn.onclick = async () => {
  await sb.auth.signOut();
  updateAuthUI(null);
  renderAllFromLocal();
};

/* ========== Theme ========== */
themeBtn.onclick = ()=>{ const cur=document.documentElement.getAttribute('data-theme'); const next=cur==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); };
document.documentElement.setAttribute('data-theme', localStorage.getItem('theme')||'dark');

/* ========== Local storage helpers ========== */
function localGetAllForDate(d){
  const out = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(!k) continue;
    if(k.includes(ymd(d))) out[k] = localStorage.getItem(k);
  }
  return out;
}
function localApplyMap(map){
  Object.entries(map||{}).forEach(([k,v])=>{
    if(v==null) localStorage.removeItem(k); else localStorage.setItem(k, v);
  });
}
function localClearDate(d){
  const keys = [];
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.includes(ymd(d))) keys.push(k);
  }
  keys.forEach(k=>localStorage.removeItem(k));
}

/* ========== Render helpers ========== */
function makeRow(time,label,checked,onchange,key){
  const t=document.createElement('div'); t.className='row';
  const c1=document.createElement('div'); c1.className='time'; c1.textContent=time; t.appendChild(c1);
  const c2=document.createElement('div'); c2.className='label'; c2.textContent=label; t.appendChild(c2);
  const c3=document.createElement('div'); const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=checked; cb.onchange=()=>onchange(cb.checked); c3.appendChild(cb); cb.setAttribute('data-key',key); t.appendChild(c3);
  return t;
}

/* Render schedule using a map (from local or cloud) */
function renderScheduleFromMap(map){
  scheduleGrid.innerHTML = '';
  const vd = getViewDate();
  document.getElementById('sportPill').textContent = '–°–ø–æ—Ä—Ç –¥–Ω—è: ' + sportPlan[currentDay];
  baseDay.forEach((it,idx)=>{
    const key = DAY_KEY(vd, idx);
    const checked = map && (map[key] === '1' || localStorage.getItem(key) === '1');
    const row = makeRow(it[0], it[1], checked, async (val)=>{
      // save to local immediately
      if(val) localStorage.setItem(key,'1'); else localStorage.removeItem(key);
    }, key);
    scheduleGrid.appendChild(row);
  });
}

/* Nutrition UI (2-column KBJU layout) */
function renderNutritionFromMap(map){
  nutritionArea.innerHTML = '';
  const vd = getViewDate();
  const header=document.createElement('div'); header.className='row'; header.innerHTML='<div class="time">–ü—Ä–∏—ë–º</div><div class="label">–ö–ë–ñ–£</div><div></div>'; nutritionArea.appendChild(header);
  MEALS.forEach(meal=>{
    const row=document.createElement('div'); row.className='row';
    const c1=document.createElement('div'); c1.className='time'; c1.textContent = meal; row.appendChild(c1);
    const c2=document.createElement('div'); c2.className='label';
    const grid=document.createElement('div'); grid.className='meal-kbju';
    N_FIELDS.forEach(field=>{
      const fld=document.createElement('div'); fld.className='kbju-field';
      const lbl=document.createElement('label'); lbl.textContent = field.split(' ')[0];
      const inp=document.createElement('input'); inp.type='number'; inp.placeholder='0';
      const key = NF_KEY(vd, meal, field);
      inp.value = map && map[key] != null ? map[key] : (localStorage.getItem(key) || '');
      inp.onchange = ()=> {
        if(inp.value) localStorage.setItem(key, String(inp.value)); else localStorage.removeItem(key);
      };
      fld.appendChild(lbl); fld.appendChild(inp); grid.appendChild(fld);
    });
    c2.appendChild(grid); row.appendChild(c2); row.appendChild(document.createElement('div')); nutritionArea.appendChild(row);
  });
  renderNutritionTotalsFromMap(map);
}
function renderNutritionTotalsFromMap(map){
  const vd = getViewDate();
  const sums = {'–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)':0,'–ë–µ–ª–∫–∏ (–≥)':0,'–ñ–∏—Ä—ã (–≥)':0,'–£–≥–ª–µ–≤–æ–¥—ã (–≥)':0};
  MEALS.forEach(m=>N_FIELDS.forEach(f=>{
    const key = NF_KEY(vd,m,f);
    const v = map && map[key] != null ? Number(map[key]) : Number(localStorage.getItem(key) || 0);
    sums[f] += v;
  }));
  nutritionTotals.textContent = `–ò—Ç–æ–≥–æ: ${sums['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)']} –∫–∫–∞–ª ‚Ä¢ –ë ${sums['–ë–µ–ª–∫–∏ (–≥)']} –≥ ‚Ä¢ –ñ ${sums['–ñ–∏—Ä—ã (–≥)']} –≥ ‚Ä¢ –£ ${sums['–£–≥–ª–µ–≤–æ–¥—ã (–≥)']} –≥`;
  if(sums['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)'] > 2000) nutritionTotals.style.color = 'var(--danger)';
  else if(sums['–ö–∞–ª–æ—Ä–∏–∏ (–∫–∫–∞–ª)'] < 1500) nutritionTotals.style.color = '#2563eb';
  else nutritionTotals.style.color = '';
}

/* Daily & weekly goals render */
function renderDailyGoalsFromMap(map){
  dailyGoalsDiv.innerHTML = '';
  const vd = getViewDate();
  goalsDaily.forEach((lab, idx)=>{
    const key = GOAL_KEY(vd, idx);
    const checked = (map && map[key] === '1') || (localStorage.getItem(key) === '1');
    const row = makeRow('‚Äî', lab, checked, (val)=>{
      if(val) localStorage.setItem(key,'1'); else localStorage.removeItem(key);
    }, key);
    dailyGoalsDiv.appendChild(row);
  });
}
function renderWeeklyGoalsFromMap(map){
  weeklyGoalsDiv.innerHTML = '';
  const vd = getViewDate(); const w = isoWeek(vd);
  goalsWeekly.forEach((lab, idx)=>{
    const key = WEEK_KEY(w, idx);
    const checked = (map && map[key] === '1') || (localStorage.getItem(key) === '1');
    const row = makeRow('–ù–µ–¥–µ–ª—è', lab, checked, (val)=>{
      if(val) localStorage.setItem(key,'1'); else localStorage.removeItem(key);
    }, key);
    weeklyGoalsDiv.appendChild(row);
  });
}

/* State (emoji) */
const stateOptions = [{v:1,label:'üòñ'},{v:2,label:'üòï'},{v:3,label:'üòê'},{v:4,label:'üôÇ'},{v:5,label:'üòÑ'}];
function renderStatesFromMap(map){
  stateGrid.innerHTML = '';
  const vd = getViewDate();
  ['mood','body'].forEach(type=>{
    const box = document.createElement('div'); box.style.margin='8px 0';
    const title = document.createElement('div'); title.className='small'; title.textContent = type==='mood' ? '–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ' : '–§–∏–∑–∏—á–µ—Å–∫–∏';
    box.appendChild(title);
    const chips = document.createElement('div'); chips.className='chips';
    stateOptions.forEach(opt=>{
      const b = document.createElement('button'); b.className='chip'; b.textContent = opt.label;
      const key = STATE_KEY(vd,type);
      const saved = map && map[key] != null ? map[key] : localStorage.getItem(key);
      if(String(saved) === String(opt.v)) b.style.outline = '2px solid var(--accent)';
      b.onclick = ()=> {
        localStorage.setItem(key, String(opt.v));
      };
      chips.appendChild(b);
    });
    box.appendChild(chips); stateGrid.appendChild(box);
  });
}

/* Health: weight daily; volumes only on Sunday */
function renderHealthFromMap(map){
  healthGrid.innerHTML = '';
  const vd = getViewDate();
  // weight
  const row = document.createElement('div'); row.className='row';
  const t = document.createElement('div'); t.className='time'; t.textContent='–í–µ—Å (–∫–≥)'; row.appendChild(t);
  const c = document.createElement('div'); c.className='label';
  const inp = document.createElement('input'); inp.type='number'; inp.step='0.1';
  inp.value = map && map[METRIC_KEY(vd,'weight')] != null ? map[METRIC_KEY(vd,'weight')] : (localStorage.getItem(METRIC_KEY(vd,'weight')) || '');
  inp.onchange = ()=> { if(inp.value) localStorage.setItem(METRIC_KEY(vd,'weight'), String(inp.value)); else localStorage.removeItem(METRIC_KEY(vd,'weight')); };
  c.appendChild(inp); row.appendChild(c); row.appendChild(document.createElement('div')); healthGrid.appendChild(row);

  const isSunday = getViewDate().getDay() === 0;
  if(isSunday){
    [['–û–±—ä–µ–º –∂–∏–≤–æ—Ç–∞','waist'],['–û–±—ä—ë–º –±–∏—Ü–µ–ø—Å–∞','biceps'],['–û–±—ä—ë–º –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å–∞','quad']].forEach(([label,name])=>{
      const r=document.createElement('div'); r.className='row';
      const tt=document.createElement('div'); tt.className='time'; tt.textContent=label; r.appendChild(tt);
      const cc=document.createElement('div'); cc.className='label';
      const ii=document.createElement('input'); ii.type='number'; ii.step='0.1';
      ii.value = map && map[CIRC_KEY(vd,name)] != null ? map[CIRC_KEY(vd,name)] : (localStorage.getItem(CIRC_KEY(vd,name)) || '');
      ii.onchange = ()=> { if(ii.value) localStorage.setItem(CIRC_KEY(vd,name), String(ii.value)); else localStorage.removeItem(CIRC_KEY(vd,name)); };
      cc.appendChild(ii); r.appendChild(cc); r.appendChild(document.createElement('div')); healthGrid.appendChild(r);
    });
  }
}

/* ========== Render all from local storage (fast fallback) ========== */
function renderAllFromLocal(){
  const vd = getViewDate();
  dateLine.textContent = `${DAYS_FULL[currentDay]} ‚Ä¢ ${ymd(vd)}`;
  const localMap = localGetAllForDate(vd);
  renderScheduleFromMap(localMap);
  renderNutritionFromMap(localMap);
  renderDailyGoalsFromMap(localMap);
  renderWeeklyGoalsFromMap(localMap);
  renderStatesFromMap(localMap);
  renderHealthFromMap(localMap);
  document.getElementById('weeklySection').style.display = (vd.getDay()===0 ? 'block':'none');
  authStatus.textContent = 'Offline / –ª–æ–∫–∞–ª—å–Ω–æ';
}

/* ========== Cloud sync logic (merge safe) ========== */
/*
  Policy:
  - syncDown: fetch daily_data and weekly_data for user/date and merge into localStorage (apply keys from cloud)
  - syncUp: read local keys for date and upsert into daily_data / weekly_data
  - we keep localStorage as source of truth for UI responsiveness; cloud is synchronized to it.
*/

async function getUser(){
  try{
    const r = await sb.auth.getUser();
    return r.data?.user ?? null;
  }catch(e){ console.warn('getUser error',e); return null; }
}

async function syncDown(){
  const user = await getUser();
  if(!user){ alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ –æ–±–ª–∞–∫–∞.'); return; }
  const vd = getViewDate(), week = isoWeek(vd);
  try{
    const { data: drow } = await sb.from('daily_data').select('data').eq('user_id', user.id).eq('ymd', ymd(vd)).maybeSingle();
    const { data: wrow } = await sb.from('weekly_data').select('data').eq('user_id', user.id).eq('week_id', week).maybeSingle();
    // apply maps safely (cloud keys overwrite local)
    if(drow && drow.data) localApplyMap(drow.data);
    if(wrow && wrow.data) localApplyMap(wrow.data);
    renderAllFromLocal();
    authStatus.textContent = 'Online ‚Ä¢ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏–∑ –æ–±–ª–∞–∫–∞';
    alert('–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ.');
  }catch(err){ console.error(err); alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + (err.message || err)); }
}

async function syncUp(){
  const user = await getUser();
  if(!user){ alert('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã. –í–æ–π–¥–∏—Ç–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ –æ–±–ª–∞–∫–æ.'); return; }
  const vd = getViewDate(), w = isoWeek(vd);
  // collect local keys for this date
  const local = localGetAllForDate(vd);
  // split into daily (day/goal/n/metric/circ/w:)
  const dailyData = {};
  const weeklyData = {};
  Object.entries(local).forEach(([k,v])=>{
    if(k.startsWith('wgoal:') || k.startsWith('w:')) weeklyData[k] = v;
    else dailyData[k] = v;
  });
  try{
    // upsert daily
    if(Object.keys(dailyData).length > 0){
      await sb.from('daily_data').upsert({ user_id: user.id, ymd: ymd(vd), data: dailyData, updated_at: new Date().toISOString() }, { onConflict: 'user_id,ymd' });
    } else {
      // if empty, remove
      await sb.from('daily_data').delete().eq('user_id', user.id).eq('ymd', ymd(vd));
    }
    // upsert weekly
    if(Object.keys(weeklyData).length > 0){
      await sb.from('weekly_data').upsert({ user_id: user.id, week_id: w, data: weeklyData, updated_at: new Date().toISOString() }, { onConflict: 'user_id,week_id' });
    } else {
      await sb.from('weekly_data').delete().eq('user_id', user.id).eq('week_id', w);
    }
    authStatus.textContent = 'Online ‚Ä¢ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –≤ –æ–±–ª–∞–∫–æ';
    alert('–î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–ª–∞–∫–æ.');
  }catch(err){ console.error(err); alert('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: ' + (err.message||err)); }
}

/* ========== Event bindings ========== */
syncDownBtn.onclick = syncDown;
syncUpBtn.onclick = syncUp;

/* auth state listener */
sb.auth.onAuthStateChange((_event, session) => {
  const user = session?.user || null;
  updateAuthUI(user);
  if(user) syncDown();
});
async function updateAuthUI(user){
  if(user){ logoutBtn.style.display='inline-flex'; loginBtn.style.display='none'; emailInput.style.display='none'; authStatus.textContent = 'Online ‚Ä¢ '+(user.email||user.id); }
  else { logoutBtn.style.display='none'; loginBtn.style.display='inline-flex'; emailInput.style.display='inline-flex'; authStatus.textContent = 'Offline / –ª–æ–∫–∞–ª—å–Ω–æ'; }
}

/* navigation week control (keyboard like) */
document.getElementById('prevWeekBtn')?.addEventListener('click', ()=>{ viewWeekStart = addDays(viewWeekStart, -7); renderAllFromLocal(); });
document.getElementById('nextWeekBtn')?.addEventListener('click', ()=>{ viewWeekStart = addDays(viewWeekStart, +7); renderAllFromLocal(); });

/* ========== initial render ========== */
function renderAll(){ renderAllFromLocal(); }
renderAll();
</script>
</body>
</html>
