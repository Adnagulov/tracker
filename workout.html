<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Тренировка дня</title>
<style>
 :root{--bg:#0f172a;--card:#0d1320;--muted:#94a3b8;--text:#e6eef8;--border:#1f2937}
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui;padding:12px}
 .card{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;margin-bottom:12px}
 .flex{display:flex;gap:8px;align-items:center}
 .square{width:44px;height:44px;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer}
 .small{font-size:13px;color:var(--muted)}
 @media(max-width:560px){ .square{width:36px;height:36px} }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="card">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><h2 style="margin:0">Тренировка</h2><div id="dateTitle" class="small"></div></div>
    <div><a class="small" href="index.html">← Назад</a></div>
  </div>
</div>

<div id="programWrap"></div>

<script>
/* Supabase (подставлены ваши значения) */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* program */
const WEEK_PROGRAM = {
  0:{title:'Понедельник',place:'Силовая дома',ex:[
    {id:'sq',title:'Присед с гирей 4x12',sets:4},
    {id:'lung',title:'Выпады с гантелями 3x10/нога',sets:3},
    {id:'press',title:'Жим гантелей лёжа 4x12',sets:4},
    {id:'curl',title:'Подъём гантелей на бицепс 3x12',sets:3},
    {id:'plank',title:'Планка 3x60с',sets:3}
  ]},
  1:{title:'Вторник',place:'Бег улица',ex:[
    {id:'tempo',title:'Темповый бег 30–40 мин',metrics:['Время (мин)','Средняя скорость','Средний пульс']},
    {id:'stretch',title:'Растяжка 10 мин',sets:1}
  ]},
  2:{title:'Среда',place:'Силовая улица',ex:[
    {id:'pull',title:'Подтягивания 4xmax',sets:4},{id:'dips',title:'Брусья 4xmax',sets:4},{id:'aus',title:'Австралийские подтягивания 3x12',sets:3},{id:'leglift',title:'Подъём ног в висе 3xmax',sets:3}
  ]},
  3:{title:'Четверг',place:'Бег улица',ex:[
    {id:'intervals',title:'Интервалы 8–10×(1 мин быстрый/90 сек шаг)',metrics:['Подходы выполнено']}
  ]},
  4:{title:'Пятница',place:'Силовая дома',ex:[
    {id:'row',title:'Тяга гири в наклоне 4x12',sets:4},{id:'ohp',title:'Жим гири 3x10/рука',sets:3},{id:'push',title:'Отжимания 4x15',sets:4},{id:'bridge',title:'Ягодичный мостик 3x15',sets:3},{id:'abs',title:'Скручивания 3x20',sets:3}
  ]},
  5:{title:'Суббота',place:'Силовая улица',ex:[
    {id:'pull2',title:'Подтягивания 4xmax',sets:4},{id:'dips2',title:'Отжимания на брусьях 4xmax',sets:4},{id:'push2',title:'Отжимания 3x15',sets:3},{id:'sideplank',title:'Планка боковая 3x30с/сторона',sets:3}
  ]},
  6:{title:'Воскресенье',place:'Футбол',ex:[
    {id:'football',title:'Футбол 60–90 мин',metrics:['Минуты','Спринты 10×100м выполнены?']}
  ]}
};

const pad=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const today = new Date(); const dayIndex = (today.getDay()+6)%7;
document.getElementById('dateTitle').textContent = `${ymd(today)} • ${WEEK_PROGRAM[dayIndex].title}`;

function createSquare(checked){ const b=document.createElement('div'); b.className='square'; b.textContent = checked ? '✔' : ''; return b; }

async function renderProgram(){
  programWrap.innerHTML=''; const dayProg = WEEK_PROGRAM[dayIndex];
  const user=(await sb.auth.getUser()).data?.user;
  let map = {};
  if(user){
    const { data } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd', ymd(today)).maybeSingle();
    map = (data && data.data) ? data.data : {};
  }
  dayProg.ex.forEach(ex=>{
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.textContent = ex.title; card.appendChild(h);
    if(ex.sets){
      const wrap=document.createElement('div'); wrap.style.display='flex'; wrap.style.gap='8px';
      for(let s=0;s<ex.sets;s++){
        const key = `w:${ymd(today)}:${ex.id}:${s}`;
        const checked = map?.[key] === '1';
        const sq = createSquare(checked);
        sq.onclick = async ()=>{
          const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('Войдите');
          const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd', ymd(today)).maybeSingle();
          const existing = (remote && remote.data)?remote.data:{};
          existing[key] = existing[key] === '1' ? null : '1';
          Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
          if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd', ymd(today));
          else await sb.from('daily_data').upsert({ user_id:user.id, ymd: ymd(today), data: existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
          await renderProgram();
        };
        wrap.appendChild(sq);
      }
      card.appendChild(wrap);
    }
    if(ex.metrics){
      ex.metrics.forEach((m,mi)=>{
        const div=document.createElement('div'); div.style.marginTop='8px';
        const label=document.createElement('div'); label.className='small'; label.textContent = m; div.appendChild(label);
        const inp=document.createElement('input'); inp.type='text';
        const key = `w:${ymd(today)}:metric:${ex.id}:${mi}`;
        inp.value = map?.[key] ?? '';
        inp.onchange = async ()=>{
          const user=(await sb.auth.getUser()).data?.user; if(!user) return alert('Войдите');
          const { data: remote } = await sb.from('daily_data').select('data').eq('user_id',user.id).eq('ymd', ymd(today)).maybeSingle();
          const existing = (remote && remote.data)?remote.data:{};
          existing[key] = inp.value ? String(inp.value) : null;
          Object.keys(existing).forEach(k=>{ if(existing[k]==null) delete existing[k]; });
          if(Object.keys(existing).length===0) await sb.from('daily_data').delete().eq('user_id',user.id).eq('ymd', ymd(today));
          else await sb.from('daily_data').upsert({ user_id:user.id, ymd: ymd(today), data: existing, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
          await renderProgram();
        };
        div.appendChild(inp); card.appendChild(div);
      });
    }
    programWrap.appendChild(card);
  });
}

renderProgram();
</script>
</body>
</html>
