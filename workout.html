<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
      --chip-bg:#0b1222;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#4b5563; --text:#0f172a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#d97706; --danger:#dc2626; --border:#e5e7eb;
      --chip-bg:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}
    header{position:relative;background:var(--bg);border-bottom:1px solid var(--border)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{margin:0 0 4px;font-size:22px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;margin:12px 0}
    .title{margin:0 0 8px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    .ex{padding:12px;border:1px solid var(--border);border-radius:12px;background:transparent}
    .ex h4{margin:0 0 8px;font-size:16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .ex h4 a{font-size:12px;color:var(--accent2);text-decoration:none;border-bottom:1px dashed var(--accent2)}
    .sets{display:flex;gap:8px;flex-wrap:wrap;margin-top:4px}
    .set{width:32px;height:32px;border-radius:10px;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;cursor:pointer;background:var(--chip-bg);font-weight:700}
    .set.done{background:var(--accent);color:#fff;border-color:transparent}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .row label{font-size:13px;color:var(--muted)}
    input[type="number"], input[type="text"], textarea{
      padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);
    }
    input[type="number"]{max-width:140px}
    textarea{width:100%;min-height:70px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--chip-bg);color:var(--text);cursor:pointer;font-weight:700;text-decoration:none}
    .btn.primary{background:var(--accent2);color:#fff;border-color:transparent}
    .btn.warn{background:var(--warn);color:#000;border-color:transparent}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .muted{color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b1024;font-size:12px}
    [data-theme="light"] .pill{background:#f1f5f9}
    .ex-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .top-actions{display:flex;gap:8px;flex-wrap:wrap}
    .progress{height:12px;width:100%;background:transparent;border:1px solid var(--border);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:var(--accent2);width:0%}
    .kpi-line{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    @media(max-width:560px){
      h1{font-size:20px}
      .set{width:30px;height:30px}
    }
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;justify-content:space-between;align-items:flex-start">
      <div>
        <h1>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</h1>
        <div class="sub" id="dateLine">‚Äî</div>
        <div class="pill" id="dayType">‚Äî</div>
      </div>
      <div class="top-actions">
        <a class="btn" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
        <button class="btn" id="themeBtn">üåô/‚òÄÔ∏è</button>
        <button class="btn primary" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="kpi-line">
        <div class="row">
          <div class="pill">–ü–æ–¥—Ö–æ–¥—ã: <b id="setsDone">0</b>/<b id="setsTotal">0</b></div>
          <div class="pill">–ó–∞–¥–∞–Ω–∏—è (–º–µ—Ç—Ä–∏–∫–∏): <b id="fieldsFilled">0</b>/<b id="fieldsTotal">0</b></div>
        </div>
        <div class="row">
          <button class="btn" id="completeAllBtn">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã</button>
          <button class="btn warn" id="resetDayBtn">–°–±—Ä–æ—Å –¥–Ω—è</button>
        </div>
      </div>
      <div class="progress" style="margin-top:10px"><i id="progbar"></i></div>
    </section>

    <section class="card">
      <h3 class="title">–ü—Ä–æ–≥—Ä–∞–º–º–∞</h3>
      <div id="workoutBox" class="grid"></div>
      <div class="sub muted" style="margin-top:8px">–¢–∞–ø –ø–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫—É ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –ø–æ–¥—Ö–æ–¥. –ü–æ–ª—è –∏ –≥–∞–ª–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤ Supabase (–ø–æ –¥–∞—Ç–µ).</div>
    </section>

    <section class="card">
      <h3 class="title">–ó–∞–º–µ—Ç–∫–∞ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</h3>
      <textarea id="noteInput" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Å–µ—Å—Å–∏—è, —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ, —Ç–µ—Ö–Ω–∏–∫–∞..."></textarea>
    </section>
  </main>

  <script>
    /* ===== –¢–µ–º–∞ ===== */
    const root=document.documentElement;
    const applyTheme=(t)=>{ root.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
    applyTheme(localStorage.getItem('theme')||'dark');
    document.getElementById('themeBtn').onclick=()=> applyTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');

    /* ===== –î–∞—Ç–∞ –∏ —É—Ç–∏–ª–∏—Ç—ã ===== */
    const pad=n=>String(n).padStart(2,'0');
    const qs=(k)=> new URLSearchParams(location.search).get(k);
    const iso=(d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const DAYS = ['–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫','–í—Ç–æ—Ä–Ω–∏–∫','–°—Ä–µ–¥–∞','–ß–µ—Ç–≤–µ—Ä–≥','–ü—è—Ç–Ω–∏—Ü–∞','–°—É–±–±–æ—Ç–∞','–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ'];

    const dateParam = qs('date');
    const viewDate = dateParam ? new Date(dateParam+'T00:00:00') : new Date();
    const dayIdx = (viewDate.getDay()+6)%7; // 0=–ü–Ω ... 6=–í—Å
    const DATE = iso(viewDate);

    document.getElementById('dateLine').textContent = `${DAYS[dayIdx]} ‚Ä¢ ${DATE}`;

    /* ===== –¢–µ—Ö. —Å—Å—ã–ª–∫–∏ (–º–æ–∂–µ—à—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å/–¥–æ–ø–æ–ª–Ω—è—Ç—å) ===== */
    const TECH_LINKS = {
      '–ü—Ä–∏—Å–µ–¥ —Å –≥–∏—Ä–µ–π':'https://youtu.be/8vWZJ8Ww1aA',
      '–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏':'https://youtu.be/qSx6jG0P5WI',
      '–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞':'https://youtu.be/VM3vZ4lR7Oo',
      '–ü–æ–¥—ä—ë–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å':'https://youtu.be/ykJmrZ5v0Oo',
      '–ü–ª–∞–Ω–∫–∞':'https://youtu.be/pSHjTRCQxIw',
      '–¢—è–≥–∞ –≥–∏—Ä–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ':'https://youtu.be/Zf0mS7Q1YlQ',
      '–ñ–∏–º –≥–∏—Ä–∏ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π':'https://youtu.be/8QTs7WeB1VQ',
      '–û—Ç–∂–∏–º–∞–Ω–∏—è':'https://youtu.be/IODxDxX7oi4',
      '–Ø–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç–∏–∫ —Å –≥–∏—Ä–µ–π':'https://youtu.be/8bbE64NuDTU',
      '–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è':'https://youtu.be/Xyd_fa5zoEU',
      '–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è':'https://youtu.be/eGo4IYlbE5g',
      '–ë—Ä—É—Å—å—è':'https://youtu.be/2z8JmcrW-As',
      '–ê–≤—Å—Ç—Ä–∞–ª–∏–π—Å–∫–∏–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è':'https://youtu.be/2QyU2t9aNRg',
      '–ü–æ–¥—ä—ë–º –Ω–æ–≥ –≤ –≤–∏—Å–µ':'https://youtu.be/l4kQd9eWclE',
      '–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö':'https://youtu.be/2z8JmcrW-As',
      '–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞':'https://youtu.be/IODxDxX7oi4',
      '–ü–ª–∞–Ω–∫–∞ –±–æ–∫–æ–≤–∞—è':'https://youtu.be/NYgq1l0K6rc'
    };

    /* ===== –ü–ª–∞–Ω –Ω–µ–¥–µ–ª–∏ (–∫–∞–∫ –ø—Ä–æ—Å–∏–ª) ===== */
    // kind: 'sets' ‚Äî –ø–æ–¥—Ö–æ–¥—ã —Å –≥–∞–ª–æ—á–∫–∞–º–∏; 'metrics' ‚Äî —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
    const PLAN = {
      0: { type:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',  items:[
        {t:'–ü—Ä–∏—Å–µ–¥ —Å –≥–∏—Ä–µ–π', kind:'sets', sets:4, reps:'12'},
        {t:'–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏', kind:'sets', sets:3, reps:'10/–Ω–æ–≥–∞'},
        {t:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞', kind:'sets', sets:4, reps:'12'},
        {t:'–ü–æ–¥—ä—ë–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å', kind:'sets', sets:3, reps:'12'},
        {t:'–ü–ª–∞–Ω–∫–∞', kind:'sets', sets:3, reps:'60—Å'}
      ]},
      1: { type:'–£–ª–∏—Ü–∞ (–±–µ–≥)', items:[
        {t:'–¢–µ–º–ø–æ–≤—ã–π –±–µ–≥ 30‚Äì40 –º–∏–Ω', kind:'metrics', fields:[
          {k:'time_min', label:'–í—Ä–µ–º—è (–º–∏–Ω)'},
          {k:'avg_speed', label:'–°—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)'},
          {k:'avg_hr', label:'–°—Ä. –ø—É–ª—å—Å'}
        ]},
        {t:'–†–∞—Å—Ç—è–∂–∫–∞ 10 –º–∏–Ω', kind:'metrics', fields:[
          {k:'stretch_min', label:'–í—Ä–µ–º—è (–º–∏–Ω)', preset:10}
        ]}
      ]},
      2: { type:'–£–ª–∏—Ü–∞ (–ø–ª–æ—â–∞–¥–∫–∞)', items:[
        {t:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', kind:'sets', sets:4, reps:'max'},
        {t:'–ë—Ä—É—Å—å—è', kind:'sets', sets:4, reps:'max'},
        {t:'–ê–≤—Å—Ç—Ä–∞–ª–∏–π—Å–∫–∏–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', kind:'sets', sets:3, reps:'12'},
        {t:'–ü–æ–¥—ä—ë–º –Ω–æ–≥ –≤ –≤–∏—Å–µ', kind:'sets', sets:3, reps:'max'}
      ]},
      3: { type:'–£–ª–∏—Ü–∞ (–±–µ–≥)', items:[
        {t:'–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã 8‚Äì10√ó(1 –º–∏–Ω –±—ã—Å—Ç—Ä—ã–π –±–µ–≥ / 90 —Å–µ–∫ —à–∞–≥)', kind:'metrics', fields:[
          {k:'intervals_done', label:'–°–¥–µ–ª–∞–Ω–æ –ø–æ–≤—Ç–æ—Ä–æ–≤ (—à—Ç)'},
          {k:'avg_hr', label:'–°—Ä. –ø—É–ª—å—Å'}
        ]},
        {t:'–ó–∞–º–∏–Ω–∫–∞ 10 –º–∏–Ω', kind:'metrics', fields:[ {k:'cooldown_min', label:'–í—Ä–µ–º—è (–º–∏–Ω)', preset:10} ]}
      ]},
      4: { type:'–î–æ–º', items:[
        {t:'–¢—è–≥–∞ –≥–∏—Ä–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ', kind:'sets', sets:4, reps:'12'},
        {t:'–ñ–∏–º –≥–∏—Ä–∏ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π', kind:'sets', sets:3, reps:'10/—Ä—É–∫–∞'},
        {t:'–û—Ç–∂–∏–º–∞–Ω–∏—è', kind:'sets', sets:4, reps:'15'},
        {t:'–Ø–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç–∏–∫ —Å –≥–∏—Ä–µ–π', kind:'sets', sets:3, reps:'15'},
        {t:'–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è', kind:'sets', sets:3, reps:'20'}
      ]},
      5: { type:'–£–ª–∏—Ü–∞ (–ø–ª–æ—â–∞–¥–∫–∞)', items:[
        {t:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è', kind:'sets', sets:4, reps:'max'},
        {t:'–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö', kind:'sets', sets:4, reps:'max'},
        {t:'–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞', kind:'sets', sets:3, reps:'15'},
        {t:'–ü–ª–∞–Ω–∫–∞ –±–æ–∫–æ–≤–∞—è', kind:'sets', sets:3, reps:'30—Å/—Å—Ç–æ—Ä–æ–Ω–∞'}
      ]},
      6: { type:'–§—É—Ç–±–æ–ª', items:[
        {t:'–§—É—Ç–±–æ–ª 60‚Äì90 –º–∏–Ω', kind:'metrics', fields:[{k:'time_min', label:'–í—Ä–µ–º—è (–º–∏–Ω)'}]},
        {t:'–°–ø—Ä–∏–Ω—Ç—ã 10√ó100–º, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫', kind:'metrics', fields:[{k:'sprints_done', label:'–°–¥–µ–ª–∞–Ω–æ —Å–ø—Ä–∏–Ω—Ç–æ–≤ (—à—Ç)'}]}
      ]}
    };

    document.getElementById('dayType').textContent = PLAN[dayIdx]?.type || '‚Äî';

    /* ===== –ö–ª—é—á–∏ —Ö—Ä–∞–Ω–µ–Ω–∏—è ===== */
    // workout:<YYYY-MM-DD>:<slug>:[setN] –∏–ª–∏ :field:<name> –∏–ª–∏ :note
    function slugify(s){
      return s.toLowerCase().replace(/[—ë]/g,'e').replace(/[^a-z0-9]+/gi,'-').replace(/^-+|-+$/g,'');
    }
    const keySet  = (slug, n)=> `workout:${DATE}:${slug}:set${n}`;
    const keyFld  = (slug, field)=> `workout:${DATE}:${slug}:field:${field}`;
    const NOTE_KEY = `workout:${DATE}:note`;

    /* ===== DOM ===== */
    const box = document.getElementById('workoutBox');
    const setsDoneEl   = document.getElementById('setsDone');
    const setsTotalEl  = document.getElementById('setsTotal');
    const fieldsDoneEl = document.getElementById('fieldsFilled');
    const fieldsTotalEl= document.getElementById('fieldsTotal');
    const progbar = document.getElementById('progbar');
    const noteInput = document.getElementById('noteInput');

    /* ===== –†–µ–Ω–¥–µ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫ ===== */
    function makeSetToggle(slug, n){
      const el = document.createElement('button');
      el.type='button';
      el.className='set';
      const saved = localStorage.getItem(keySet(slug, n)) === '1';
      if(saved) el.classList.add('done');
      el.textContent = n;
      el.onclick=()=>{
        const nowDone = !el.classList.contains('done');
        if(nowDone){ el.classList.add('done'); localStorage.setItem(keySet(slug,n),'1'); }
        else { el.classList.remove('done'); localStorage.removeItem(keySet(slug,n)); }
        scheduleSave(); updateKPI();
      };
      return el;
    }

    function makeMetricInput(slug, field, label, preset){
      const wrap=document.createElement('div'); wrap.className='row';
      const l=document.createElement('label'); l.textContent=label; wrap.appendChild(l);
      const i=document.createElement('input'); i.type='number'; i.step='any'; i.placeholder='';
      const saved = localStorage.getItem(keyFld(slug, field));
      i.value = (saved!=null && saved!=='') ? saved : (preset ?? '');
      i.onchange=()=>{ 
        if(i.value==='') localStorage.removeItem(keyFld(slug,field));
        else localStorage.setItem(keyFld(slug,field), i.value);
        scheduleSave(); updateKPI();
      };
      wrap.appendChild(i);
      return wrap;
    }

    function exActionsAll(slug, setsCount, container){
      const row=document.createElement('div'); row.className='ex-actions';
      const all=document.createElement('button'); all.className='btn'; all.textContent='–í—Å–µ –ø–æ–¥—Ö–æ–¥—ã';
      all.onclick=()=>{
        for(let s=1;s<=setsCount;s++){ localStorage.setItem(keySet(slug,s),'1'); }
        // –æ—Ç–º–µ—Ç–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ
        container.querySelectorAll('.set').forEach(el=>el.classList.add('done'));
        scheduleSave(); updateKPI();
      };
      const reset=document.createElement('button'); reset.className='btn warn'; reset.textContent='–°–±—Ä–æ—Å';
      reset.onclick=()=>{
        for(let s=1;s<=setsCount;s++){ localStorage.removeItem(keySet(slug,s)); }
        container.querySelectorAll('.set').forEach(el=>el.classList.remove('done'));
        // –æ—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª—è –º–µ—Ç—Ä–∏–∫ —ç—Ç–æ–≥–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è
        container.querySelectorAll('input[type="number"]').forEach(inp=>{
          const name=inp.previousSibling?.textContent; // –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º
        });
        scheduleSave(); updateKPI();
      };
      row.appendChild(all); row.appendChild(reset);
      return row;
    }

    function render(){
      box.innerHTML='';
      const plan = PLAN[dayIdx];
      if(!plan){ box.innerHTML = '<div class="sub muted">–ù–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å –Ω–µ—Ç –ø–ª–∞–Ω–∞.</div>'; return; }

      plan.items.forEach(item=>{
        const card=document.createElement('div'); card.className='ex';
        const slug = slugify(item.t);
        const h=document.createElement('h4');
        h.textContent=item.t + (item.reps?` ‚Äî ${item.reps}`:'');
        // —Å—Å—ã–ª–∫–∞ "—Ç–µ—Ö–Ω–∏–∫–∞" (–µ—Å–ª–∏ –µ—Å—Ç—å)
        if(TECH_LINKS[item.t]){
          const a=document.createElement('a'); a.target='_blank'; a.rel='noopener noreferrer';
          a.href=TECH_LINKS[item.t]; a.textContent='—Ç–µ—Ö–Ω–∏–∫–∞';
          h.appendChild(a);
        }
        card.appendChild(h);

        if(item.kind==='sets'){
          const row=document.createElement('div'); row.className='sets';
          for(let s=1;s<=item.sets;s++) row.appendChild(makeSetToggle(slug, s));
          card.appendChild(row);
          card.appendChild( exActionsAll(slug, item.sets, card) );
        }
        if(item.kind==='metrics'){
          item.fields.forEach(f=>{
            card.appendChild( makeMetricInput(slug, f.k, f.label, f.preset) );
          });
        }
        box.appendChild(card);
      });

      // –ó–∞–º–µ—Ç–∫–∞
      noteInput.value = localStorage.getItem(NOTE_KEY) || '';
      noteInput.onchange = ()=>{ 
        const v = (noteInput.value||'').trim();
        if(v==='') localStorage.removeItem(NOTE_KEY); else localStorage.setItem(NOTE_KEY, v);
        scheduleSave();
      };

      updateKPI();
    }

    /* ===== KPI/–ø—Ä–æ–≥—Ä–µ—Å—Å ===== */
    function countAll(){
      const plan = PLAN[dayIdx]; if(!plan) return {setsDone:0, setsTotal:0, fieldsDone:0, fieldsTotal:0};
      let setsTotal=0, setsDone=0, fieldsTotal=0, fieldsDone=0;
      plan.items.forEach(item=>{
        const slug = slugify(item.t);
        if(item.kind==='sets'){
          setsTotal += item.sets;
          for(let s=1;s<=item.sets;s++){
            if(localStorage.getItem(keySet(slug,s))==='1') setsDone++;
          }
        }
        if(item.kind==='metrics'){
          item.fields.forEach(f=>{
            fieldsTotal++;
            const v = localStorage.getItem(keyFld(slug,f.k));
            if(v!=null && v!=='') fieldsDone++;
          });
        }
      });
      return {setsDone, setsTotal, fieldsDone, fieldsTotal};
    }

    function updateKPI(){
      const {setsDone, setsTotal, fieldsDone, fieldsTotal} = countAll();
      setsDoneEl.textContent = setsDone;
      setsTotalEl.textContent = setsTotal;
      fieldsDoneEl.textContent = fieldsDone;
      fieldsTotalEl.textContent = fieldsTotal;
      const denom = setsTotal + fieldsTotal;
      const num   = setsDone + fieldsDone;
      const pct = denom? Math.round(100*num/denom) : 0;
      progbar.style.width = pct+'%';
    }

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    document.getElementById('completeAllBtn').onclick=()=>{
      const plan = PLAN[dayIdx]; if(!plan) return;
      plan.items.forEach(item=>{
        const slug = slugify(item.t);
        if(item.kind==='sets'){
          for(let s=1;s<=item.sets;s++){ localStorage.setItem(keySet(slug,s),'1'); }
        }
        if(item.kind==='metrics'){
          item.fields.forEach(f=>{
            // –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–æ–ª–Ω—è–µ–º; –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –≤–≤–æ–¥–∏—Ç –∑–Ω–∞—á–µ–Ω–∏—è
          });
        }
      });
      // –æ—Ç–º–µ—Ç–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω–æ
      document.querySelectorAll('.set').forEach(el=>el.classList.add('done'));
      scheduleSave(); updateKPI();
    };

    document.getElementById('resetDayBtn').onclick=()=>{
      const plan = PLAN[dayIdx]; if(!plan) return;
      plan.items.forEach(item=>{
        const slug = slugify(item.t);
        if(item.kind==='sets'){
          for(let s=1;s<=item.sets;s++){ localStorage.removeItem(keySet(slug,s)); }
        }
        if(item.kind==='metrics'){
          item.fields.forEach(f=> localStorage.removeItem(keyFld(slug,f.k)) );
        }
      });
      localStorage.removeItem(NOTE_KEY);
      render(); scheduleSave();
    };

    /* ===== Supabase sync (daily_data) ===== */
    async function sbGetUser(){ const {data:{user}} = await sb.auth.getUser(); return user; }

    function collectWorkoutForDate(){
      const out={};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i); if(!k) continue;
        if(k.startsWith(`workout:${DATE}:`)){ out[k]=localStorage.getItem(k); }
      }
      return out;
    }
    function applyWorkoutMap(map){
      Object.entries(map||{}).forEach(([k,v])=>{
        if(k.startsWith(`workout:${DATE}:`)) localStorage.setItem(k,v);
      });
    }

    async function loadFromSupabase(){
      const user = await sbGetUser(); if(!user) return;
      const { data, error } = await sb.from('daily_data')
        .select('data').eq('user_id',user.id).eq('ymd',DATE).maybeSingle();
      if(error) return;
      applyWorkoutMap(data?.data);
      render();
    }

    async function saveToSupabase(){
      const user = await sbGetUser(); if(!user) { alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ (magic link)'); return; }
      const daily = collectWorkoutForDate();
      await sb.from('daily_data').upsert({
        user_id:user.id, ymd:DATE, data: daily, updated_at: new Date().toISOString()
      }, { onConflict:'user_id,ymd' });
    }

    let saveTimer;
    function scheduleSave(){ clearTimeout(saveTimer); saveTimer = setTimeout(saveToSupabase, 1000); }

    document.getElementById('saveBtn').onclick = async ()=>{ await saveToSupabase(); alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ'); };

    /* ===== Auth ‚Äî magic link session (–∫–∞–∫ –≤ index.html) ===== */
    const REDIRECT_URL = (() => {
      const u = new URL(window.location.href);
      let p = u.pathname;
      if (p.endsWith('.html')) p = p.slice(0, p.lastIndexOf('/')+1);
      if (!p.endsWith('/')) p += '/';
      return `${u.origin}${p}`;
    })();

    (async ()=>{
      try { try{ await sb.auth.exchangeCodeForSession(window.location.href); }catch(_){} 
        if (/[?#].*(access_token|refresh_token|code)=/i.test(location.href)) history.replaceState({}, document.title, REDIRECT_URL + `workout.html?date=${DATE}`);
        // –ª–æ–∫–∞–ª—å–Ω—ã–µ —Å—Ä–∞–∑—É –≤–∏–¥–Ω—ã:
        render();
        // –ø–æ–¥–≥—Ä—É–∑–∫–∞ –∏–∑ –æ–±–ª–∞–∫–∞:
        await loadFromSupabase();
      } catch {
        render();
      }
    })();
  </script>
</body>
</html>
