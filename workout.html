<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</title>
<link rel="icon" href="favicon.svg" type="image/svg+xml" />
<style>
 :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--text:#f9fafb;--border:#1f2937;--accent:#3b82f6}
 [data-theme="light"]{--bg:#ffffff;--card:#f8fafc;--muted:#374151;--text:#0f172a;--border:#e5e7eb;--accent:#2563eb}
 body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui}
 .wrap{max-width:980px;margin:0 auto;padding:12px}
 .card{background:var(--card);border:1px solid var(--border);padding:16px;border-radius:12px;margin:12px 0;box-shadow:0 2px 6px rgba(0,0,0,.2)}
 .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
 .square{width:40px;height:40px;border:1px solid var(--border);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer}
 .small{font-size:13px;color:var(--muted)}
 input{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text);min-width:120px}
 .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-weight:600}
 .btn:hover{background:var(--accent);color:#fff}
 header{padding:12px;border-bottom:1px solid var(--border);background:rgba(0,0,0,.05)}
 h2{margin:0}
 table{width:100%;border-collapse:collapse;margin-top:8px}
 th,td{padding:6px 8px;border-bottom:1px solid var(--border);text-align:left}
 th{color:var(--muted);font-weight:500;font-size:13px}
 .rowsets{display:grid;grid-template-columns:56px 1fr;gap:8px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header>
  <div class="wrap flex" style="justify-content:space-between;align-items:center">
    <div class="flex" style="gap:10px">
      <button id="themeBtn" class="btn" title="–°–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è">üåô/‚òÄÔ∏è</button>
      <a class="btn" href="index.html">‚Üê –ù–∞–∑–∞–¥</a>
    </div>
    <div class="small" id="dateTitle">‚Äî</div>
    <div class="flex">
      <button id="syncBtn" class="btn">Sync</button>
      <span id="syncStatus" class="small" style="margin-left:8px">–ª–æ–∫–∞–ª—å–Ω–æ</span>
    </div>
  </div>
</header>

<div class="wrap" id="programWrap"></div>

<script>
/* Theme */
(function(){ const t=localStorage.getItem('theme')||'dark'; document.documentElement.setAttribute('data-theme', t); })();
document.getElementById('themeBtn').onclick=()=>{ const cur=document.documentElement.getAttribute('data-theme'); const next=cur==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme', next); localStorage.setItem('theme', next); };

/* Supabase */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* program */
const WEEK_PROGRAM = {
  0:{title:'–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫',place:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',ex:[
    {id:'sq',title:'–ü—Ä–∏—Å–µ–¥ —Å –≥–∏—Ä–µ–π 4√ó12',sets:4},
    {id:'lung',title:'–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏ 3√ó10/–Ω–æ–≥–∞',sets:3},
    {id:'press',title:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞ 4√ó12',sets:4},
    {id:'curl',title:'–ü–æ–¥—ä—ë–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å 3√ó12',sets:3},
    {id:'plank',title:'–ü–ª–∞–Ω–∫–∞ 3√ó60—Å',sets:3, note:'—Å–µ–∫—É–Ω–¥—ã'}
  ]},
  1:{title:'–í—Ç–æ—Ä–Ω–∏–∫',place:'–ë–µ–≥ —É–ª–∏—Ü–∞',ex:[
    {id:'tempo',title:'–¢–µ–º–ø–æ–≤—ã–π –±–µ–≥ 30‚Äì40 –º–∏–Ω',metrics:['–í—Ä–µ–º—è (–º–∏–Ω)','–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å','–°—Ä–µ–¥–Ω–∏–π –ø—É–ª—å—Å']},
    {id:'stretch',title:'–†–∞—Å—Ç—è–∂–∫–∞ 10 –º–∏–Ω',sets:1, note:'–º–∏–Ω'}
  ]},
  2:{title:'–°—Ä–µ–¥–∞',place:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',ex:[
    {id:'pull',title:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è 4√ómax',sets:4},
    {id:'dips',title:'–ë—Ä—É—Å—å—è 4√ómax',sets:4},
    {id:'aus',title:'–ê–≤—Å—Ç—Ä–∞–ª–∏–π—Å–∫–∏–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è 3√ó12',sets:3},
    {id:'leglift',title:'–ü–æ–¥—ä—ë–º –Ω–æ–≥ –≤ –≤–∏—Å–µ 3√ómax',sets:3}
  ]},
  3:{title:'–ß–µ—Ç–≤–µ—Ä–≥',place:'–ë–µ–≥ —É–ª–∏—Ü–∞',ex:[
    {id:'intervals',title:'–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã 8‚Äì10√ó(1 –º–∏–Ω –±—ã—Å—Ç—Ä—ã–π/90 —Å–µ–∫ —à–∞–≥)',metrics:['–ü–æ–¥—Ö–æ–¥—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–æ']}
  ]},
  4:{title:'–ü—è—Ç–Ω–∏—Ü–∞',place:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',ex:[
    {id:'row',title:'–¢—è–≥–∞ –≥–∏—Ä–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ 4√ó12',sets:4},
    {id:'ohp',title:'–ñ–∏–º –≥–∏—Ä–∏ 3√ó10/—Ä—É–∫–∞',sets:3},
    {id:'push',title:'–û—Ç–∂–∏–º–∞–Ω–∏—è 4√ó15',sets:4},
    {id:'bridge',title:'–Ø–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç–∏–∫ 3√ó15',sets:3},
    {id:'abs',title:'–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è 3√ó20',sets:3}
  ]},
  5:{title:'–°—É–±–±–æ—Ç–∞',place:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',ex:[
    {id:'pull2',title:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è 4√ómax',sets:4},
    {id:'dips2',title:'–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö 4√ómax',sets:4},
    {id:'push2',title:'–û—Ç–∂–∏–º–∞–Ω–∏—è 3√ó15',sets:3},
    {id:'sideplank',title:'–ü–ª–∞–Ω–∫–∞ –±–æ–∫–æ–≤–∞—è 3√ó30—Å/—Å—Ç–æ—Ä–æ–Ω–∞',sets:3, note:'—Å–µ–∫'}
  ]},
  6:{title:'–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ',place:'–§—É—Ç–±–æ–ª',ex:[
    {id:'football',title:'–§—É—Ç–±–æ–ª 60‚Äì90 –º–∏–Ω',metrics:['–ú–∏–Ω—É—Ç—ã','–°–ø—Ä–∏–Ω—Ç—ã 10√ó100–º –≤—ã–ø–æ–ª–Ω–µ–Ω—ã?']}
  ]}
};

const pad=n=>String(n).padStart(2,'0');
const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
const today = new Date(); const dayIndex = (today.getDay()+6)%7;
document.getElementById('dateTitle').textContent = `${ymd(today)} ‚Ä¢ ${WEEK_PROGRAM[dayIndex].title} ‚Ä¢ ${WEEK_PROGRAM[dayIndex].place}`;

function getLocalMapForToday(){
  const out = {};
  const prefix = ymd(today);
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k && k.includes(prefix)) out[k] = localStorage.getItem(k);
  }
  return out;
}

function setState(key, val){ if(val==null || val==='') localStorage.removeItem(key); else localStorage.setItem(key, String(val)); }

function createSquare(checked){ const b=document.createElement('div'); b.className='square'; b.textContent = checked ? '‚úî' : ''; return b; }

async function renderProgram(){
  programWrap.innerHTML = '';
  const dayProg = WEEK_PROGRAM[dayIndex];
  const map = getLocalMapForToday();
  dayProg.ex.forEach(ex=>{
    const card=document.createElement('div'); card.className='card';
    const h=document.createElement('h3'); h.style.margin='0 0 8px 0'; h.textContent = ex.title; card.appendChild(h);

    if(ex.sets){
      // –¢–∞–±–ª–∏—Ü–∞ –ø–æ–¥—Ö–æ–¥–æ–≤: —á–µ–∫ + –ø–æ–ª–µ "–≤–µ—Å √ó –ø–æ–≤—Ç–æ—Ä—ã / –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ"
      const table=document.createElement('table');
      const thead=document.createElement('thead'); thead.innerHTML='<tr><th style="width:56px">‚úî</th><th>–í–µ—Å / –ü–æ–≤—Ç–æ—Ä—ã</th></tr>'; table.appendChild(thead);
      const tbody=document.createElement('tbody');
      for(let s=0;s<ex.sets;s++){
        const row=document.createElement('tr');
        const keyDone = `w:${ymd(today)}:${ex.id}:${s}`;
        const keyVal  = `w:${ymd(today)}:${ex.id}:${s}:val`;

        const td1=document.createElement('td');
        const sq = createSquare(map[keyDone] === '1');
        sq.onclick = ()=>{ if(localStorage.getItem(keyDone) === '1') localStorage.removeItem(keyDone); else localStorage.setItem(keyDone,'1'); sq.textContent = localStorage.getItem(keyDone)==='1'?'‚úî':''; };
        td1.appendChild(sq);

        const td2=document.createElement('td');
        const inp=document.createElement('input');
        inp.type='text'; inp.placeholder = ex.note ? ex.note : '–Ω–∞–ø—Ä. 20√ó12';
        inp.value = map[keyVal] || '';
        inp.onchange = ()=> setState(keyVal, inp.value);
        td2.appendChild(inp);

        row.appendChild(td1); row.appendChild(td2);
        tbody.appendChild(row);
      }
      table.appendChild(tbody); card.appendChild(table);
    }

    if(ex.metrics){
      ex.metrics.forEach((m,mi)=>{
        const row=document.createElement('div'); row.style.marginTop='8px'; row.className='rowsets';
        const label=document.createElement('div'); label.className='small'; label.textContent=m; row.appendChild(label);
        const inp=document.createElement('input'); inp.type='text';
        const key = `w:${ymd(today)}:metric:${ex.id}:${mi}`;
        inp.value = map[key] || '';
        inp.onchange = ()=> setState(key, inp.value);
        row.appendChild(inp);
        card.appendChild(row);
      });
    }
    programWrap.appendChild(card);
  });
}

document.getElementById('syncBtn').onclick = async ()=>{
  const { data: userResp } = await sb.auth.getUser().catch(()=>({data:{user:null}}));
  const user = userResp?.user;
  if(!user){ document.getElementById('syncStatus').textContent='–≤–æ–π–¥–∏—Ç–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π'; return; }
  const dateStr = ymd(today);
  const local = getLocalMapForToday();
  const dailyData = {};
  const weeklyData = {};
  Object.entries(local).forEach(([k,v])=>{
    if(k.startsWith('wgoal:') || k.startsWith('w:')) weeklyData[k] = v;
    else dailyData[k] = v;
  });
  try{
    if(Object.keys(dailyData).length) await sb.from('daily_data').upsert({ user_id:user.id, ymd: dateStr, data: dailyData, updated_at:new Date().toISOString() }, { onConflict:'user_id,ymd' });
    if(Object.keys(weeklyData).length) await sb.from('weekly_data').upsert({ user_id:user.id, week_id: (function(){const d=new Date(); const day=(d.getDay()+6)%7; return (function isoWeek(d){ const t=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const day=(t.getUTCDay()+6)%7; t.setUTCDate(t.getUTCDate()-day+3); const first=new Date(Date.UTC(t.getUTCFullYear(),0,4)); const w=1+Math.round(((t-first)/86400000-3+((first.getUTCDay()+6)%7))/7); return `${t.getUTCFullYear()}-${String(w).padStart(2,'0')}`; })(d); })(), data: weeklyData, updated_at:new Date().toISOString() }, { onConflict:'user_id,week_id' });
    document.getElementById('syncStatus').textContent = '—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ';
  }catch(err){ console.error(err); document.getElementById('syncStatus').textContent='–æ—à–∏–±–∫–∞'; }
};

renderProgram();
</script>
</body>
</html>
