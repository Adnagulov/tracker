<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937; --chip-bg:#0b1222;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#4b5563; --text:#0f172a; --border:#e5e7eb; --chip-bg:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}
    header{border-bottom:1px solid var(--border);background:var(--bg)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px;font-size:26px;line-height:1.1}
    .sub{color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:#0b1024;font-size:12px}
    [data-theme="light"] .pill{background:#f1f5f9}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--chip-bg);color:var(--text);cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent2);color:#fff}
    .btn.warn{background:var(--warn);color:#000}
    .title{font-weight:800}
    .muted{color:var(--muted);font-size:12px}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:800px){ .two-col{grid-template-columns:1fr} }
    .setrow{display:flex;gap:8px;flex-wrap:wrap}
    .setrow input[type="checkbox"]{width:28px;height:28px}
    input[type="number"], input[type="text"]{
      font-size:16px;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);
      min-width:120px;max-width:160px
    }
    progress{width:100%;height:14px}
  </style>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
<header>
  <div class="wrap">
    <div class="flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ –¥–Ω—è</h1>
        <div class="flex" style="gap:8px">
          <div class="sub" id="dateLabel">‚Äî</div>
          <span class="pill" id="sportPill">‚Äî</span>
        </div>
      </div>
      <div class="flex">
        <a class="btn" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
        <button class="btn" id="themeBtn">üåô/‚òÄÔ∏è</button>
        <button class="btn primary" id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="flex" style="justify-content:space-between;align-items:center">
      <div class="flex">
        <span class="pill">–ü–æ–¥—Ö–æ–¥—ã: <b id="setsDone">0</b>/<b id="setsTotal">0</b></span>
        <span class="pill">–ó–∞–¥–∞–Ω–∏—è (–º–µ—Ç—Ä–∏–∫–∏): <b id="mDone">0</b>/<b id="mTotal">0</b></span>
      </div>
      <div style="min-width:220px">
        <progress id="prog" value="0" max="100"></progress>
      </div>
    </div>
    <div class="flex" style="margin-top:8px">
      <button class="btn primary" id="completeAll">–í—Å–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã</button>
      <button class="btn warn" id="resetBtn">–°–±—Ä–æ—Å –¥–Ω—è</button>
    </div>
  </section>

  <section class="card">
    <div class="title" style="margin-bottom:6px">–ü—Ä–æ–≥—Ä–∞–º–º–∞</div>
    <div class="muted">–¢–∞–ø –ø–æ –∫–≤–∞–¥—Ä–∞—Ç–∏–∫—É ‚Äî –æ—Ç–º–µ—Ç–∏—Ç—å –ø–æ–¥—Ö–æ–¥/–∏–Ω—Ç–µ—Ä–≤–∞–ª. –ü–æ–ª—è –∏ –≥–∞–ª–æ—á–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –≤ Supabase (–ø–æ –¥–∞—Ç–µ).</div>
  </section>

  <section class="two-col" id="workoutGrid"></section>

  <section class="card">
    <div class="title" style="margin-bottom:6px">–ó–∞–º–µ—Ç–∫–∞ –∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–µ</div>
    <input id="note" type="text" placeholder="–ö–∞–∫ –ø—Ä–æ—à–ª–∞ —Å–µ—Å—Å–∏—è, —Å–∞–º–æ—á—É–≤—Å—Ç–≤–∏–µ, —Ç–µ—Ö–Ω–∏–∫–∞..." style="width:100%;max-width:none">
  </section>
</main>

<script>
/* ===== –¢–µ–º–∞ ===== */
const root=document.documentElement;
function applyTheme(t){ root.setAttribute('data-theme',t); localStorage.setItem('theme',t); }
applyTheme(localStorage.getItem('theme')||'dark');
document.getElementById('themeBtn').onclick=()=>applyTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');

/* ===== –î–∞—Ç–∞/–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ ===== */
const planName = {
  0:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',
  1:'–ë–µ–≥ —É–ª–∏—Ü–∞',
  2:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',
  3:'–ë–µ–≥ —É–ª–∏—Ü–∞',
  4:'–°–∏–ª–æ–≤–∞—è –¥–æ–º–∞',
  5:'–°–∏–ª–æ–≤–∞—è —É–ª–∏—Ü–∞',
  6:'–§—É—Ç–±–æ–ª'
};
const PLAN = {
  0:[
    {type:'sets', slug:'kb-squat',  name:'–ü—Ä–∏—Å–µ–¥ —Å –≥–∏—Ä–µ–π',           detail:'4√ó12',       sets:4},
    {type:'sets', slug:'db-lunge',  name:'–í—ã–ø–∞–¥—ã —Å –≥–∞–Ω—Ç–µ–ª—è–º–∏',       detail:'3√ó10/–Ω–æ–≥–∞', sets:3},
    {type:'sets', slug:'db-bench',  name:'–ñ–∏–º –≥–∞–Ω—Ç–µ–ª–µ–π –ª—ë–∂–∞',        detail:'4√ó12',       sets:4},
    {type:'sets', slug:'db-biceps', name:'–ü–æ–¥—ä—ë–º –≥–∞–Ω—Ç–µ–ª–µ–π –Ω–∞ –±–∏—Ü–µ–ø—Å',detail:'3√ó12',       sets:3},
    {type:'sets', slug:'plank',     name:'–ü–ª–∞–Ω–∫–∞',                   detail:'3√ó60—Å',      sets:3}
  ],
  1:[
    {type:'run', slug:'run-tempo', name:'–¢–µ–º–ø–æ–≤—ã–π –±–µ–≥ 30‚Äì40 –º–∏–Ω', fields:[
      {k:'time', ph:'–º–∏–Ω'},
      {k:'pace', ph:'—Å—Ä. —Å–∫–æ—Ä–æ—Å—Ç—å (–∫–º/—á)'},
      {k:'hr',   ph:'—Å—Ä. –ø—É–ª—å—Å'}
    ]},
    {type:'metric', slug:'stretch', name:'–†–∞—Å—Ç—è–∂–∫–∞', fields:[{k:'mins', ph:'10 –º–∏–Ω'}]}
  ],
  2:[
    {type:'sets', slug:'pullups',         name:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è',                detail:'4√ómax', sets:4},
    {type:'sets', slug:'dips',            name:'–ë—Ä—É—Å—å—è',                      detail:'4√ómax', sets:4},
    {type:'sets', slug:'australian-pull', name:'–ê–≤—Å—Ç—Ä–∞–ª–∏–π—Å–∫–∏–µ –ø–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è',  detail:'3√ó12',  sets:3},
    {type:'sets', slug:'leg-raise-hang',  name:'–ü–æ–¥—ä—ë–º –Ω–æ–≥ –≤ –≤–∏—Å–µ',           detail:'3√ómax', sets:3}
  ],
  3:[
    {type:'intervals', slug:'run-intervals', name:'–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã 8‚Äì10√ó(1 –º–∏–Ω –±—ã—Å—Ç—Ä—ã–π / 90 —Å–µ–∫ —à–∞–≥)', total:10, required:8},
    {type:'metric',    slug:'cooldown',      name:'–ó–∞–º–∏–Ω–∫–∞', fields:[{k:'mins', ph:'10 –º–∏–Ω'}]}
  ],
  4:[
    {type:'sets', slug:'kb-row',        name:'–¢—è–≥–∞ –≥–∏—Ä–∏ –≤ –Ω–∞–∫–ª–æ–Ω–µ',        detail:'4√ó12',     sets:4},
    {type:'sets', slug:'kb-press-oh',   name:'–ñ–∏–º –≥–∏—Ä–∏ –Ω–∞–¥ –≥–æ–ª–æ–≤–æ–π',       detail:'3√ó10/—Ä—É–∫–∞',sets:3},
    {type:'sets', slug:'pushups',       name:'–û—Ç–∂–∏–º–∞–Ω–∏—è',                   detail:'4√ó15',     sets:4},
    {type:'sets', slug:'glute-bridge',  name:'–Ø–≥–æ–¥–∏—á–Ω—ã–π –º–æ—Å—Ç–∏–∫ —Å –≥–∏—Ä–µ–π',    detail:'3√ó15',     sets:3},
    {type:'sets', slug:'crunch',        name:'–°–∫—Ä—É—á–∏–≤–∞–Ω–∏—è',                 detail:'3√ó20',     sets:3}
  ],
  5:[
    {type:'sets', slug:'pullups2',    name:'–ü–æ–¥—Ç—è–≥–∏–≤–∞–Ω–∏—è',            detail:'4√ómax',    sets:4},
    {type:'sets', slug:'dips2',       name:'–û—Ç–∂–∏–º–∞–Ω–∏—è –Ω–∞ –±—Ä—É—Å—å—è—Ö',    detail:'4√ómax',    sets:4},
    {type:'sets', slug:'pushups2',    name:'–û—Ç–∂–∏–º–∞–Ω–∏—è –æ—Ç –ø–æ–ª–∞',       detail:'3√ó15',     sets:3},
    {type:'sets', slug:'side-plank',  name:'–ü–ª–∞–Ω–∫–∞ –±–æ–∫–æ–≤–∞—è',          detail:'3√ó30—Å/—Å—Ç–æ—Ä',sets:3}
  ],
  6:[
    {type:'metric',    slug:'football', name:'–§—É—Ç–±–æ–ª', fields:[{k:'mins', ph:'60‚Äì90 –º–∏–Ω'}]},
    {type:'intervals', slug:'sprints',  name:'–°–ø—Ä–∏–Ω—Ç—ã 10√ó100–º, –æ—Ç–¥—ã—Ö 90 —Å–µ–∫', total:10, required:10}
  ]
};

const qs=new URLSearchParams(location.search);
const dateStr = qs.get('date') || new Date().toISOString().slice(0,10);
const dateObj = new Date(dateStr);
const weekday = (dateObj.getDay()+6)%7; // ISO: –ü–Ω=0

document.getElementById('dateLabel').textContent = `${['–ü–Ω','–í—Ç','–°—Ä','–ß—Ç','–ü—Ç','–°–±','–í—Å'][weekday]} ‚Ä¢ ${dateStr}`;
document.getElementById('sportPill').textContent = planName[weekday] || '‚Äî';

/* ===== –ö–ª—é—á–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è ===== */
const WKEY_SET = (slug,i)=>`workout:${dateStr}:${slug}:set:${i}`;
const WKEY_FIELD=(slug,k)=>`workout:${dateStr}:${slug}:field:${k}`;
const NOTE_KEY  = `workout:${dateStr}:note`;
const GOAL_SPORT= `goal:${dateStr}:5`;

/* ===== –†–µ–Ω–¥–µ—Ä ===== */
const grid=document.getElementById('workoutGrid');

function renderProgram(){
  grid.innerHTML='';
  const blocks = PLAN[weekday] || [];
  blocks.forEach(block=>{
    const card=document.createElement('div'); card.className='card';

    // –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const head=document.createElement('div'); head.className='title'; head.textContent = block.detail ? `${block.name} ‚Äî ${block.detail}` : block.name;
    card.appendChild(head);

    if(block.type==='sets' || block.type==='intervals'){
      const n = block.type==='sets' ? block.sets : block.total;
      const row=document.createElement('div'); row.className='setrow';
      for(let i=1;i<=n;i++){
        const cb=document.createElement('input'); cb.type='checkbox';
        const k=WKEY_SET(block.slug,i);
        cb.checked = localStorage.getItem(k)==='1';
        cb.onchange = ()=>{ localStorage.setItem(k, cb.checked?'1':'0'); recount(); scheduleSave(); };
        row.appendChild(cb);
      }
      card.appendChild(row);
      if(block.type==='intervals'){
        const hint=document.createElement('div'); hint.className='muted'; hint.textContent=`–¢—Ä–µ–±—É–µ—Ç—Å—è ${block.required} –∏–∑ ${block.total}`;
        card.appendChild(hint);
      }
    }

    if(block.type==='run' || block.type==='metric'){
      const fields=document.createElement('div'); fields.className='flex'; fields.style.marginTop='8px';
      (block.fields||[]).forEach(f=>{
        const inp=document.createElement('input'); inp.type='number'; inp.placeholder=f.ph;
        const k=WKEY_FIELD(block.slug,f.k);
        inp.value = localStorage.getItem(k)||'';
        inp.onchange = ()=>{ if(inp.value==='') localStorage.removeItem(k); else localStorage.setItem(k,inp.value); recount(); scheduleSave(); };
        fields.appendChild(inp);
      });
      card.appendChild(fields);
    }

    grid.appendChild(card);
  });

  // –∑–∞–º–µ—Ç–∫–∞
  const note = document.getElementById('note');
  note.value = localStorage.getItem(NOTE_KEY) || '';
  note.onchange = ()=>{ if(note.value==='') localStorage.removeItem(NOTE_KEY); else localStorage.setItem(NOTE_KEY,note.value); scheduleSave(); };

  recount();
}

function recount(){
  // —Å—á–∏—Ç–∞–µ–º –ø–æ–¥—Ö–æ–¥—ã
  let setsTot=0, setsDone=0, mTot=0, mDone=0;
  (PLAN[weekday]||[]).forEach(b=>{
    if(b.type==='sets' || b.type==='intervals'){
      const n=(b.type==='sets')?b.sets:b.total;
      for(let i=1;i<=n;i++){ setsTot++; if(localStorage.getItem(WKEY_SET(b.slug,i))==='1') setsDone++; }
    }
    if(b.fields){
      b.fields.forEach(f=>{ mTot++; if((localStorage.getItem(WKEY_FIELD(b.slug,f.k))||'')!=='') mDone++; });
    }
  });
  document.getElementById('setsTotal').textContent=String(setsTot);
  document.getElementById('setsDone').textContent =String(setsDone);
  document.getElementById('mTotal').textContent   =String(mTot);
  document.getElementById('mDone').textContent    =String(mDone);

  const pct = setsTot? Math.round(100*setsDone/setsTot) : 0;
  document.getElementById('prog').value = pct;

  // —Ü–µ–ª—å ¬´–°–ø–æ—Ä—Ç –¥–Ω—è –≤—ã–ø–æ–ª–Ω–µ–Ω¬ª: —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Å–µ –ø–æ–¥—Ö–æ–¥—ã –∑–∞–∫—Ä—ã—Ç—ã
  if(setsTot>0 && setsDone===setsTot){ localStorage.setItem(GOAL_SPORT,'1'); } else { localStorage.removeItem(GOAL_SPORT); }
}

/* –∫–Ω–æ–ø–∫–∏ */
document.getElementById('completeAll').onclick=()=>{
  (PLAN[weekday]||[]).forEach(b=>{
    if(b.type==='sets' || b.type==='intervals'){
      const n=(b.type==='sets')?b.sets:b.total;
      for(let i=1;i<=n;i++) localStorage.setItem(WKEY_SET(b.slug,i),'1');
    }
  });
  renderProgram(); scheduleSave();
};
document.getElementById('resetBtn').onclick=()=>{
  (PLAN[weekday]||[]).forEach(b=>{
    if(b.type==='sets' || b.type==='intervals'){
      const n=(b.type==='sets')?b.sets:b.total;
      for(let i=1;i<=n;i++) localStorage.removeItem(WKEY_SET(b.slug,i));
    }
    (b.fields||[]).forEach(f=> localStorage.removeItem(WKEY_FIELD(b.slug,f.k)));
  });
  localStorage.removeItem(NOTE_KEY);
  localStorage.removeItem(GOAL_SPORT);
  renderProgram(); scheduleSave();
};

/* ===== Supabase sync ===== */
async function sbUser(){ const {data:{user}}=await sb.auth.getUser(); return user; }
function collectForDay(){
  const out={};
  for(let i=0;i<localStorage.length;i++){
    const k=localStorage.key(i); if(!k) continue;
    if(k.startsWith(`workout:${dateStr}:`) || k===GOAL_SPORT) out[k]=localStorage.getItem(k);
  }
  return out;
}
function clearDailyFor(d){
  const s = ymd(d);
  const prefixes = [
    `w:${s}:`,       // –ø–æ–¥—Ö–æ–¥—ã –∏ –º–µ—Ç—Ä–∏–∫–∏ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    `day:${s}:`,     // –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π (–µ—Å–ª–∏ –æ—Ç–º–µ—á–∞–µ—à—å —Å–ø–æ—Ä—Ç –æ—Ç—Å—é–¥–∞)
    `goal:${s}:`,
    `n:${s}:`,
    `state:${s}:`,
    `metric:${s}:`,
    `circ:${s}:`
  ];
  const toDelete = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (!k) continue;
    if (prefixes.some(p => k.startsWith(p))) toDelete.push(k);
  }
  toDelete.forEach(k => localStorage.removeItem(k));
}

async function syncSave(){
  const u=await sbUser(); if(!u) return;
  const data=collectForDay();
  if(Object.keys(data).length){
    await sb.from('daily_data').upsert({user_id:u.id, ymd:dateStr, data, updated_at:new Date().toISOString()},{onConflict:'user_id,ymd'});
  }
}
async function syncLoadFor(d){
  const user = await sbGetUser();
  if (!user) return;

  const s = ymd(d);
  const { data: row } = await sb
    .from('daily_data')
    .select('data')
    .eq('user_id', user.id)
    .eq('ymd', s)
    .maybeSingle();

  // 1) —á–∏—Å—Ç–∏–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∑–∞ —ç—Ç—É –¥–∞—Ç—É
  clearDailyFor(d);

  // 2) –µ—Å–ª–∏ –æ–±–ª–∞–∫–æ —á—Ç–æ-—Ç–æ –≤–µ—Ä–Ω—É–ª–æ ‚Äî –ø—Ä–∏–º–µ–Ω—è–µ–º
  if (row?.data) applyData(row.data);

  render();
}

}
let tmr; function scheduleSave(){ clearTimeout(tmr); tmr=setTimeout(syncSave,700); }
document.getElementById('saveBtn').onclick=syncSave;

/* magic-link: –æ–±–º–µ–Ω –∫–æ–¥–∞ –Ω–∞ —Å–µ—Å—Å–∏—é –∏ —á–∏—Å—Ç–∫–∞ URL (–≤–∞–∂–Ω–æ –¥–ª—è GH Pages) */
(async ()=>{
  try{ try{ await sb.auth.exchangeCodeForSession(window.location.href); }catch(_){} 
    if (/[?#].*(access_token|refresh_token|code)=/i.test(location.href)) {
      const u=new URL(location.href); const base=`${u.origin}${u.pathname}`;
      history.replaceState({},document.title,`${base}?date=${dateStr}`);
    }
  }catch{}
})();

renderProgram(); syncLoad();
</script>
</body>
</html>
