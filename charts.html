<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</title>

  <!-- —Å—Ç–∏–ª—å —Å–æ–≤–º–µ—Å—Ç–∏–º —Å index.html -->
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
      --chip-bg:#0b1222;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#4b5563; --text:#0f172a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#d97706; --danger:#dc2626; --border:#e5e7eb;
      --chip-bg:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}
    header{border-bottom:1px solid var(--border)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px;font-size:24px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--chip-bg);color:var(--text)!important;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent2); color:#fff;}
    .btn.ghost{background:var(--card)}
    input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    th{color:var(--muted);font-weight:700}
    .empty{color:var(--muted);padding:12px}
    canvas{width:100%;height:300px;max-height:50vh}
    @media(max-width:560px){ h1{font-size:22px} }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // –¢–ï–ú–ê –∏–∑ localStorage –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏
    (function(){
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>
<body>
  <header>
    <div class="wrap flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>üìà –ì—Ä–∞—Ñ–∏–∫–∏</h1>
        <div class="sub" id="whoami">‚Äî</div>
      </div>
      <div class="flex">
        <a class="btn ghost" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="flex" style="justify-content:space-between">
        <div class="flex">
          <label class="sub">–° –¥–∞—Ç—ã</label>
          <input type="date" id="fromDate">
          <label class="sub">–ø–æ</label>
          <input type="date" id="toDate">
          <button class="btn" id="resetRange">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div class="flex right">
          <button class="btn" id="exportCsvBtn">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–í–µ—Å (–∫–≥)</h3>
      <canvas id="weightChart"></canvas>
      <div class="sub" id="weightStats" style="margin-top:8px">‚Äî</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–ü—É–ª—å—Å —É—Ç—Ä–æ–º (—É–¥/–º–∏–Ω)</h3>
      <canvas id="pulseChart"></canvas>
      <div class="sub" id="pulseStats" style="margin-top:8px">‚Äî</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–¢–∞–±–ª–∏—Ü–∞ –∑–Ω–∞—á–µ–Ω–∏–π</h3>
      <div id="tableBox" class="empty">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–∫—Ä–æ–π <b>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</b> –∏ –Ω–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –≤–µ—Å/–ø—É–ª—å—Å.</div>
    </section>
  </main>

  <script>
    // === Supabase –∫–ª–∏–µ–Ω—Ç (—Ç–µ –∂–µ URL/–∫–ª—é—á —á—Ç–æ –∏ –≤ index.html) ===
    const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const whoamiEl = document.getElementById('whoami');
    const fromDateEl = document.getElementById('fromDate');
    const toDateEl   = document.getElementById('toDate');
    const resetRangeBtn = document.getElementById('resetRange');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    const weightCtx = document.getElementById('weightChart').getContext('2d');
    const pulseCtx  = document.getElementById('pulseChart').getContext('2d');

    let ALL_ROWS = []; // [{ymd, weight, pulse}]
    let filtered = []; // —Ç–µ–∫—É—â–∏–π —Ñ–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–∞–º
    let weightChart, pulseChart;

    // –ì–æ—Ç–æ–≤–∏–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π redirect –¥–ª—è magic link (GitHub Pages / –æ—Ç–Ω–æ—Å–∏—Ç. –ø—É—Ç—å)
    const REDIRECT_URL = (() => {
      const u = new URL(window.location.href);
      let p = u.pathname;
      if (p.endsWith('.html')) p = p.slice(0, p.lastIndexOf('/')+1);
      if (!p.endsWith('/')) p += '/';
      return `${u.origin}${p}`;
    })();

    // ====== –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø ======
    async function ensureAuthAndLoad(){
      try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(_) {}
      if (/[?#].*(access_token|refresh_token|code)=/i.test(location.href)) {
        history.replaceState({}, document.title, REDIRECT_URL.replace(/\/$/,'') + '/charts.html');
      }

      const { data:{ session } } = await sb.auth.getSession();
      const user = session?.user;

      whoamiEl.textContent = user ? ('‚Ä¢ ' + (user.email || user.id)) : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥. –û—Ç–∫—Ä–æ–π –≥–ª–∞–≤–Ω—É—é –∏ –≤–æ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ email.';
      if (!user) return;

      await loadAllDaily(user.id);
      initDateRange();
      applyFilterAndRender();
    }

    // ====== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ò–ó daily_data ======
    async function loadAllDaily(userId){
      ALL_ROWS = [];
      const { data, error } = await sb.from('daily_data')
        .select('ymd,data')
        .eq('user_id', userId)
        .order('ymd', { ascending: true });

      if (error) {
        console.warn('loadAllDaily error', error);
        return;
      }
      for (const row of (data || [])) {
        const ymd = row.ymd;
        const map = row.data || {};
        const w = map[`metric:${ymd}:weight`];
        const p = map[`metric:${ymd}:pulse`];
        const weight = (w===null || w==='' || isNaN(Number(w))) ? null : Number(w);
        const pulse  = (p===null || p==='' || isNaN(Number(p))) ? null : Number(p);
        if (weight!=null || pulse!=null) {
          ALL_ROWS.push({ ymd, weight, pulse });
        }
      }
    }

    // ====== –î–ê–¢–´ / –§–ò–õ–¨–¢–† ======
    function initDateRange(){
      if (!ALL_ROWS.length) return;
      fromDateEl.value = ALL_ROWS[0].ymd;
      toDateEl.value   = ALL_ROWS[ALL_ROWS.length-1].ymd;
      fromDateEl.max   = toDateEl.value;
      toDateEl.min     = fromDateEl.value;
    }

    function applyFilterAndRender(){
      if (!ALL_ROWS.length){
        renderEmpty();
        return;
      }
      const from = fromDateEl.value || ALL_ROWS[0].ymd;
      const to   = toDateEl.value   || ALL_ROWS[ALL_ROWS.length-1].ymd;

      // –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
      const f = from <= to ? from : to;
      const t = to >= from ? to : from;
      if (fromDateEl.value !== f) fromDateEl.value = f;
      if (toDateEl.value   !== t) toDateEl.value   = t;

      filtered = ALL_ROWS.filter(r => r.ymd >= f && r.ymd <= t);
      renderCharts();
      renderTable();
    }

    function renderEmpty(){
      // –∑–∞—á–∏—Å—Ç–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤, —Ç–∞–±–ª–∏—Ü—ã
      if (weightChart){ weightChart.destroy(); weightChart = null; }
      if (pulseChart){ pulseChart.destroy(); pulseChart = null; }
      document.getElementById('weightStats').textContent = '‚Äî';
      document.getElementById('pulseStats').textContent = '‚Äî';
      document.getElementById('tableBox').innerHTML = '<div class="empty">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–∫—Ä–æ–π <b>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</b> –∏ –Ω–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –≤–µ—Å/–ø—É–ª—å—Å.</div>';
    }

    // ====== –ì–†–ê–§–ò–ö–ò ======
    function renderCharts(){
      const labels = filtered.map(r => r.ymd);
      const weights = filtered.map(r => r.weight);
      const pulses  = filtered.map(r => r.pulse);

      // –∞–≥—Ä–µ–≥–∞—Ç—ã
      const wVals = weights.filter(v => v!=null);
      const pVals = pulses.filter(v => v!=null);

      const wMin = wVals.length ? Math.min(...wVals) : null;
      const wMax = wVals.length ? Math.max(...wVals) : null;
      const wLast= wVals.length ? wVals[wVals.length-1] : null;
      document.getElementById('weightStats').textContent =
        wVals.length ? `–ø–æ—Å–ª–µ–¥–Ω–µ–µ: ${wLast} –∫–≥ ‚Ä¢ –º–∏–Ω: ${wMin} ‚Ä¢ –º–∞–∫—Å: ${wMax}` : '‚Äî';

      const pMin = pVals.length ? Math.min(...pVals) : null;
      const pMax = pVals.length ? Math.max(...pVals) : null;
      const pLast= pVals.length ? pVals[pVals.length-1] : null;
      document.getElementById('pulseStats').textContent =
        pVals.length ? `–ø–æ—Å–ª–µ–¥–Ω–µ–µ: ${pLast} —É–¥/–º–∏–Ω ‚Ä¢ –º–∏–Ω: ${pMin} ‚Ä¢ –º–∞–∫—Å: ${pMax}` : '‚Äî';

      // Weight chart
      if (weightChart) weightChart.destroy();
      weightChart = new Chart(weightCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '–í–µ—Å, –∫–≥',
            data: weights,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: getTextColor() }, grid: { color: getGridColor() } },
            y: { ticks: { color: getTextColor() }, grid: { color: getGridColor() } }
          }
        }
      });

      // Pulse chart
      if (pulseChart) pulseChart.destroy();
      pulseChart = new Chart(pulseCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: '–ü—É–ª—å—Å, —É–¥/–º–∏–Ω',
            data: pulses,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { ticks: { color: getTextColor() }, grid: { color: getGridColor() } },
            y: { suggestedMin: 40, suggestedMax: 120, ticks: { color: getTextColor() }, grid: { color: getGridColor() } }
          }
        }
      });
    }

    function getTextColor(){
      return getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#94a3b8';
    }
    function getGridColor(){
      const c = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
      return c || '#1f2937';
    }

    // ====== –¢–ê–ë–õ–ò–¶–ê ======
    function renderTable(){
      const box = document.getElementById('tableBox');
      if (!filtered.length){
        box.innerHTML = '<div class="empty">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
        return;
      }
      const rows = filtered.map(r => {
        const w = (r.weight==null || Number.isNaN(r.weight)) ? '' : r.weight;
        const p = (r.pulse==null  || Number.isNaN(r.pulse))  ? '' : r.pulse;
        return `<tr><td>${r.ymd}</td><td>${w}</td><td>${p}</td></tr>`;
      }).join('');
      box.innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead><tr><th>–î–∞—Ç–∞</th><th>–í–µ—Å (–∫–≥)</th><th>–ü—É–ª—å—Å (—É–¥/–º–∏–Ω)</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    // ====== CSV ======
    function toCsv(arr){
      const header = ['date','weight','pulse'];
      const lines = [header.join(',')];
      arr.forEach(r=>{
        lines.push([r.ymd, r.weight ?? '', r.pulse ?? ''].join(','));
      });
      return lines.join('\n');
    }
    function downloadCsv(name, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ====== –°–æ–±—ã—Ç–∏—è ======
    fromDateEl.addEventListener('change', ()=>{
      if (toDateEl.value && fromDateEl.value > toDateEl.value) toDateEl.value = fromDateEl.value;
      applyFilterAndRender();
    });
    toDateEl.addEventListener('change', ()=>{
      if (fromDateEl.value && toDateEl.value < fromDateEl.value) fromDateEl.value = toDateEl.value;
      applyFilterAndRender();
    });
    resetRangeBtn.addEventListener('click', ()=>{
      if (!ALL_ROWS.length) return;
      fromDateEl.value = ALL_ROWS[0].ymd;
      toDateEl.value   = ALL_ROWS[ALL_ROWS.length-1].ymd;
      applyFilterAndRender();
    });
    exportCsvBtn.addEventListener('click', ()=>{
      const csv = toCsv(filtered.length ? filtered : ALL_ROWS);
      const name = `tracker_metrics_${(new Date()).toISOString().slice(0,10)}.csv`;
      downloadCsv(name, csv);
    });

    // ====== –ó–∞–ø—É—Å–∫ ======
    ensureAuthAndLoad();
  </script>
</body>
</html>
