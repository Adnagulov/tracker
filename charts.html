<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Графики</title>
<style>
 body{margin:0;font-family:Inter,system-ui;background:#0f172a;color:#e6eef8;padding:12px}
 .wrap{max-width:980px;margin:0 auto}
 .card{background:#0d1320;border:1px solid #1f2937;padding:12px;border-radius:10px;margin-bottom:12px}
 canvas{width:100%!important;height:260px!important}
 .small{font-size:13px;color:#94a3b8}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="card"><h2 style="margin:0">Графики</h2><div class="small">Вес и объёмы (данные из Supabase)</div></div>
  <div class="card"><h3>Вес (факт vs цель)</h3><canvas id="weightChart"></canvas></div>
  <div class="card"><h3>Объём живота</h3><canvas id="waistChart"></canvas></div>
  <div class="card"><h3>Объём бицепса</h3><canvas id="bicepsChart"></canvas></div>
  <div class="card"><h3>Объём квадрицепса</h3><canvas id="quadChart"></canvas></div>
  <div class="card"><a href="index.html" class="small">← Вернуться</a></div>
</div>

<script>
/* Supabase config */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Target plan (ваши данные) */
const TARGET = [
  ['2025-09-17',97],['2025-09-23',95.9],['2025-09-30',94.7],['2025-10-07',93.6],
  ['2025-10-14',92.5],['2025-10-21',91.3],['2025-10-28',90.2],['2025-11-04',89.1],
  ['2025-11-11',87.9],['2025-11-18',86.8],['2025-11-25',85.7],['2025-12-02',84.5],
  ['2025-12-09',83.4],['2025-12-16',82.3],['2025-12-23',81.1],['2025-12-30',80.0]
];

/* collect series from daily_data for current user */
async function collectSeries(){
  const u = (await sb.auth.getUser()).data?.user;
  const labels = TARGET.map(t=>t[0]);
  const targetVals = TARGET.map(t=>t[1]);
  if(!u) return { labels, target: targetVals, weightActual:labels.map(()=>null), waist:labels.map(()=>null), biceps:labels.map(()=>null), quad:labels.map(()=>null) };
  const { data } = await sb.from('daily_data').select('ymd,data').eq('user_id',u.id);
  const map = {};
  (data||[]).forEach(row=>{
    const d = row.ymd;
    const obj = row.data || {};
    Object.entries(obj).forEach(([k,v])=>{
      map[k] = v;
    });
  });
  const weightActual = labels.map(lbl => { const k=`metric:${lbl}:weight`; return map[k] ? Number(map[k]) : null; });
  const waist = labels.map(lbl => { const k=`circ:${lbl}:waist`; return map[k] ? Number(map[k]) : null; });
  const biceps = labels.map(lbl => { const k=`circ:${lbl}:biceps`; return map[k] ? Number(map[k]) : null; });
  const quad = labels.map(lbl => { const k=`circ:${lbl}:quad`; return map[k] ? Number(map[k]) : null; });
  return { labels, target: targetVals, weightActual, waist, biceps, quad };
}

/* Chart helper */
function mkLine(ctx, labels, datasets){
  return new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true,
      interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:true}},
      scales:{ y:{ beginAtZero:false } }
    }
  });
}

async function renderCharts(){
  const s = await collectSeries();
  const labels = s.labels;
  mkLine(document.getElementById('weightChart').getContext('2d'), labels, [
    { label:'Фактический вес', data: s.weightActual, borderColor:'#3b82f6', fill:false, tension:0.2, spanGaps:true },
    { label:'Целевой вес', data: s.target, borderColor:'#ef4444', borderDash:[6,4], fill:false, tension:0.2 }
  ]);
  mkLine(document.getElementById('waistChart').getContext('2d'), labels, [{label:'Живот (см)',data:s.waist,borderColor:'#34d399',fill:false,spanGaps:true}]);
  mkLine(document.getElementById('bicepsChart').getContext('2d'), labels, [{label:'Бицепс (см)',data:s.biceps,borderColor:'#60a5fa',fill:false,spanGaps:true}]);
  mkLine(document.getElementById('quadChart').getContext('2d'), labels, [{label:'Квадрицепс (см)',data:s.quad,borderColor:'#f59e0b',fill:false,spanGaps:true}]);
}

renderCharts();
</script>
</body>
</html>
