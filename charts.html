<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --border:#1f2937;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#4b5563; --text:#0f172a;
      --accent:#16a34a; --accent2:#2563eb; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}
    header{position:relative;background:var(--bg);border-bottom:1px solid var(--border)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{margin:0;font-size:22px}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--card);color:var(--text);cursor:pointer;font-weight:600;text-decoration:none}
    .btn.primary{background:var(--accent2);color:#fff;border-color:transparent}
    .row{display:grid;grid-template-columns:1fr;gap:18px;margin:18px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .title{font-weight:700;margin:0 0 8px}
    .muted{color:var(--muted)}
    .range{display:flex;gap:8px;flex-wrap:wrap}
    .range .btn{padding:8px 10px}
    canvas{width:100%;height:360px;display:block}
    .legend{font-size:12px;color:var(--muted)}
    @media(max-width:560px){
      canvas{height:280px}
    }
  </style>
  <!-- Chart.js (–∏–∑ CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="wrap flex" style="justify-content:space-between">
      <div>
        <h1>–ì—Ä–∞—Ñ–∏–∫–∏</h1>
        <div class="sub">–í–µ—Å –∏ –∑–∞–º–µ—Ä—ã. –î–∏–∞–ø–∞–∑–æ–Ω –º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å.</div>
      </div>
      <div class="flex">
        <a class="btn" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
        <button id="themeBtn" class="btn">üåô/‚òÄÔ∏è</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 class="title">–î–∏–∞–ø–∞–∑–æ–Ω</h3>
        <div class="range">
          <button class="btn" data-range="30">30 –¥–Ω–µ–π</button>
          <button class="btn" data-range="90">90 –¥–Ω–µ–π</button>
          <button class="btn" data-range="180">180 –¥–Ω–µ–π</button>
          <button class="btn primary" data-range="all">–í—Å—ë</button>
        </div>
      </div>
    </div>

    <section class="row">
      <div class="card">
        <h3 class="title">–í–µ—Å (–∫–≥)</h3>
        <canvas id="chartWeight"></canvas>
        <div class="legend muted">–§–∞–∫—Ç ‚Äî –ª–∏–Ω–∏—è 1; –¶–µ–ª–µ–≤–æ–π ‚Äî –ø—É–Ω–∫—Ç–∏—Ä–Ω–∞—è –ª–∏–Ω–∏—è 2.</div>
      </div>
      <div class="card">
        <h3 class="title">–û–±—ä—ë–º –∂–∏–≤–æ—Ç–∞ (—Å–º)</h3>
        <canvas id="chartWaist"></canvas>
      </div>
      <div class="card">
        <h3 class="title">–û–±—ä—ë–º –±–∏—Ü–µ–ø—Å–∞ (—Å–º)</h3>
        <canvas id="chartBiceps"></canvas>
      </div>
      <div class="card">
        <h3 class="title">–û–±—ä—ë–º –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å–∞ (—Å–º)</h3>
        <canvas id="chartQuad"></canvas>
      </div>
    </section>
  </main>

  <script>
    // ===== –¢–µ–º–∞ =====
    const root = document.documentElement;
    const applyTheme = (t)=>{ root.setAttribute('data-theme', t); localStorage.setItem('theme', t); };
    applyTheme(localStorage.getItem('theme')||'dark');
    document.getElementById('themeBtn').onclick=()=> applyTheme(root.getAttribute('data-theme')==='dark'?'light':'dark');

    // ===== –£—Ç–∏–ª–∏—Ç—ã –¥–∞—Ç =====
    const pad=(n)=> String(n).padStart(2,'0');
    const toDate=(s)=> new Date(s);
    const fmt=(d)=> `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    const addDays=(d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };

    // ===== –ß—Ç–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ä—è–¥–æ–≤ –∏–∑ localStorage =====
    function readMetricSeries(prefix){ // prefix: 'weight'/'waist'/'biceps'/'quad'
      const rows=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(!k || !k.startsWith('metric:')) continue;
        // metric:YYYY-MM-DD:weight
        const parts=k.split(':');
        if(parts.length!==3) continue;
        const date=parts[1], name=parts[2];
        if(name!==prefix) continue;
        const v = localStorage.getItem(k);
        if(v!==null && v!=='') rows.push({x: date, y: Number(v)});
      }
      rows.sort((a,b)=> a.x.localeCompare(b.x));
      return rows;
    }

    // ===== –¶–µ–ª–µ–≤–æ–π –ø–ª–∞–Ω –ø–æ –≤–µ—Å—É (–∏–∑ —Ç–≤–æ–µ–π —Ç–∞–±–ª–∏—Ü—ã) =====
    const targetPlan = [
      ['2025-09-17', 97.0],
      ['2025-09-23', 95.9],
      ['2025-09-30', 94.7],
      ['2025-10-07', 93.6],
      ['2025-10-14', 92.5],
      ['2025-10-21', 91.3],
      ['2025-10-28', 90.2],
      ['2025-11-04', 89.1],
      ['2025-11-11', 87.9],
      ['2025-11-18', 86.8],
      ['2025-11-25', 85.7],
      ['2025-12-02', 84.5],
      ['2025-12-09', 83.4],
      ['2025-12-16', 82.3],
      ['2025-12-23', 81.1],
      ['2025-12-30', 80.0],
    ].map(([d,v])=>({x:d,y:v}));

    // ===== –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤ (Chart.js) =====
    let charts = {};
    const commonOpts = (title)=>({
      type:'line',
      data:{datasets:[]},
      options:{
        responsive:true,
        interaction:{mode:'nearest', intersect:false},
        plugins:{
          legend:{labels:{color:getComputedStyle(root).getPropertyValue('--text')}},
          title:{display:false, text:title, color:getComputedStyle(root).getPropertyValue('--text')}
        },
        scales:{
          x:{type:'time', time:{unit:'day', tooltipFormat:'yyyy-MM-dd'}, ticks:{color:getComputedStyle(root).getPropertyValue('--muted')}, grid:{color:getComputedStyle(root).getPropertyValue('--border')}},
          y:{ticks:{color:getComputedStyle(root).getPropertyValue('--muted')}, grid:{color:getComputedStyle(root).getPropertyValue('--border')}}
        },
        elements:{point:{radius:3}}
      }
    });

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ (–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ dayjs-lite –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –≤ chart.js 4)
    // Chart.js 4 —É–∂–µ –∏–º–µ–µ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π adapter "date-fns". –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ –¥–æ–±–∞–≤–∏–º –ø—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä:
    // –ù–æ chart.js 4.4.1 –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∞–¥–∞–ø—Ç–µ—Ä–∞ –ø–æ–Ω–∏–º–∞–µ—Ç ISO-—Å—Ç—Ä–æ–∫–∏ —á–µ—Ä–µ–∑ built-in adapter.

    function makeChart(ctxId, title){
      const ctx=document.getElementById(ctxId).getContext('2d');
      return new Chart(ctx, commonOpts(title));
    }

    function setThemeColors(){
      // –û–±–Ω–æ–≤–∏—Ç—å —Ü–≤–µ—Ç–∞ –æ—Å–µ–π/–ª–µ–≥–µ–Ω–¥—ã –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
      const text=getComputedStyle(root).getPropertyValue('--text');
      const muted=getComputedStyle(root).getPropertyValue('--muted');
      const grid=getComputedStyle(root).getPropertyValue('--border');
      Object.values(charts).forEach(ch=>{
        ch.options.plugins.legend.labels.color=text;
        ch.options.scales.x.ticks.color=muted;
        ch.options.scales.y.ticks.color=muted;
        ch.options.scales.x.grid.color=grid;
        ch.options.scales.y.grid.color=grid;
        ch.update('none');
      });
    }

    // –°–æ–∑–¥–∞—ë–º –≥—Ä–∞—Ñ–∏–∫–∏
    charts.weight = makeChart('chartWeight','–í–µ—Å');
    charts.waist  = makeChart('chartWaist','–ñ–∏–≤–æ—Ç');
    charts.biceps = makeChart('chartBiceps','–ë–∏—Ü–µ–ø—Å');
    charts.quad   = makeChart('chartQuad','–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å');

    // –¶–≤–µ—Ç–∞ –Ω–∞–±–æ—Ä–æ–≤
    function ds(colorIndex, label, data, dotted=false){
      const palette = [
        '#3b82f6', // —Å–∏–Ω–∏–π
        '#22c55e', // –∑–µ–ª—ë–Ω—ã–π
        '#f59e0b', // –∂—ë–ª—Ç—ã–π
        '#ef4444', // –∫—Ä–∞—Å–Ω—ã–π
        '#a855f7', // —Ñ–∏–æ–ª–µ—Ç
      ];
      const c = palette[colorIndex % palette.length];
      return {
        label, data,
        borderColor: c, backgroundColor: c+'33',
        tension: 0.25,
        borderWidth: 2,
        pointRadius: 2.5,
        spanGaps: true,
        borderDash: dotted ? [6,6] : undefined,
        fill: false
      };
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –¥–∞—Ç
    function filterByRange(rows, range){
      if(range==='all' || rows.length===0) return rows;
      const to = rows[rows.length-1].x;
      const toDate = new Date(to);
      const fromDate = addDays(toDate, -Number(range));
      return rows.filter(r => new Date(r.x) >= fromDate);
    }

    function refresh(range='all'){
      // –§–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä—è–¥—ã
      const weight = filterByRange(readMetricSeries('weight'), range);
      const waist  = filterByRange(readMetricSeries('waist'),  range);
      const biceps = filterByRange(readMetricSeries('biceps'), range);
      const quad   = filterByRange(readMetricSeries('quad'),   range);

      // –¶–µ–ª–µ–≤–æ–π –ø–ª–∞–Ω –≤–µ—Å–∞ ‚Äî –Ω–µ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –∂—ë—Å—Ç–∫–æ; –Ω–æ –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ç–µ–º –∂–µ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–º, –µ—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–∫—Ç
      let target = targetPlan;
      if(weight.length && range!=='all'){
        const to   = new Date(weight[weight.length-1].x);
        const from = addDays(to, -Number(range));
        target = targetPlan.filter(p => new Date(p.x) >= from && new Date(p.x) <= to);
        if(!target.length) target = targetPlan; // fallback
      }

      // –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞–±–æ—Ä—ã
      charts.weight.data.datasets = [
        ds(0,'–§–∞–∫—Ç', weight),
        ds(3,'–¶–µ–ª–µ–≤–æ–π', target, true)
      ];
      charts.waist.data.datasets  = [ ds(1,'–ñ–∏–≤–æ—Ç', waist) ];
      charts.biceps.data.datasets = [ ds(2,'–ë–∏—Ü–µ–ø—Å', biceps) ];
      charts.quad.data.datasets   = [ ds(4,'–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å', quad) ];

      Object.values(charts).forEach(ch=> ch.update());
      setThemeColors();
    }

    // –ö–Ω–æ–ø–∫–∏ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
    document.querySelectorAll('.range .btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.range .btn').forEach(x=>x.classList.remove('primary'));
        b.classList.add('primary');
        refresh(b.dataset.range);
      });
    });

    // –ù–∞—á–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥–æ–Ω
    refresh('all');

    // –†–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–º–µ–Ω—É —Ç–µ–º—ã (–∏–∑ –∫–Ω–æ–ø–∫–∏)
    const orig = document.getElementById('themeBtn').onclick;
    document.getElementById('themeBtn').onclick = ()=>{
      orig();
      setTimeout(setThemeColors, 0);
    };

    // –ù–∞–±–ª—é–¥–∞—Ç—å –∑–∞ localStorage (–µ—Å–ª–∏ –≤–∫–ª–∞–¥–∫–∞ index.html —á—Ç–æ-—Ç–æ –∏–∑–º–µ–Ω–∏–ª–∞)
    window.addEventListener('storage', ()=> refresh(document.querySelector('.range .btn.primary')?.dataset.range || 'all'));
  </script>
</body>
</html>
