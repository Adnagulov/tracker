<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</title>
  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --border:#1f2937; --accent2:#3b82f6;
    }
    [data-theme="light"]{ --bg:#f7fafc; --card:#fff; --muted:#4b5563; --text:#0f172a; --border:#e5e7eb; --accent2:#2563eb; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}
    header{position:sticky;top:0;background:linear-gradient(180deg,rgba(15,23,42,.97),rgba(15,23,42,.9));backdrop-filter:blur(8px);border-bottom:1px solid var(--border);z-index:10}
    [data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.97),rgba(255,255,255,.9))}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:1px solid var(--border);border-radius:12px;background:var(--card);color:var(--text);font-weight:700;text-decoration:none}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin:12px 0}
    h1{margin:0;font-size:22px}
    .muted{color:var(--muted)}
    .row{display:grid;grid-template-columns:110px 1fr;gap:10px;align-items:center;margin-bottom:8px}
    canvas{width:100%;height:220px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(0,0,0,.04))}
    .legend{display:flex;gap:12px;align-items:center;font-size:12px;color:var(--muted);margin-bottom:8px}
    .dot{width:10px;height:10px;border-radius:50%}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media(max-width:760px){ .grid2{grid-template-columns:1fr} .row{grid-template-columns:90px 1fr} }
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:10px">
      <h1>üìà –ì—Ä–∞—Ñ–∏–∫–∏</h1>
      <div style="display:flex;gap:8px">
        <a class="btn" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
        <button class="btn" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <div class="legend">
        <div class="dot" style="background:var(--accent2)"></div> –í–µ—Å (–∫–≥)
      </div>
      <canvas id="weightChart" width="800" height="220"></canvas>
      <div class="muted" style="margin-top:6px">–ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 90 –¥–Ω–µ–π.</div>
    </div>

    <div class="card">
      <div class="legend">
        <div class="dot" style="background:var(--accent2)"></div> –ü—É–ª—å—Å —É—Ç—Ä–æ–º (—É–¥/–º–∏–Ω)
      </div>
      <canvas id="pulseChart" width="800" height="220"></canvas>
      <div class="muted" style="margin-top:6px">–ü—É—Å—Ç—ã–µ –¥–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è. –ú–∞—Å—à—Ç–∞–± –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
    </div>
  </main>

  <script>
    const root=document.documentElement;
    function applyTheme(t){ root.setAttribute('data-theme', t); }
    applyTheme(localStorage.getItem('theme')||'dark');

    // —É—Ç–∏–ª–∏—Ç—ã
    function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); d.setHours(0,0,0,0); return d; }
    const pad=n=>String(n).padStart(2,'0');
    const ymd=d=>`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

    function readSeries(prefix, days=90){
      const arr=[];
      for(let i=days-1;i>=0;i--){
        const d=daysAgo(i);
        const k=`metric:${ymd(d)}:${prefix}`;
        const v=localStorage.getItem(k);
        if(v!=null && v!=='') arr.push({x:d, y:Number(v)});
      }
      return arr;
    }

    function lineChart(canvasId, series, colorCssVar='--accent2'){
      const c=document.getElementById(canvasId);
      const ctx=c.getContext('2d');
      const W=c.width, H=c.height, P=24;
      ctx.clearRect(0,0,W,H);

      if(series.length===0){
        ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted');
        ctx.font='14px system-ui';
        ctx.fillText('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö', 12, 24);
        return;
      }

      const xs=series.map((p)=>p.x.getTime());
      const ys=series.map(p=>p.y);
      const minX=Math.min(...xs), maxX=Math.max(...xs);
      let minY=Math.min(...ys), maxY=Math.max(...ys);
      if(minY===maxY){ minY-=1; maxY+=1; }

      const color=getComputedStyle(document.documentElement).getPropertyValue(colorCssVar).trim();
      ctx.strokeStyle='#00000022'; ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(P, H-P); ctx.lineTo(W-P, H-P); ctx.stroke();

      ctx.strokeStyle=color; ctx.lineWidth=2;
      ctx.beginPath();
      series.forEach((p,i)=>{
        const x=P+( (p.x.getTime()-minX)/(maxX-minX || 1) )*(W-2*P);
        const y=H-P- ( (p.y-minY)/(maxY-minY) )*(H-2*P);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // —Ç–æ—á–∫–∏
      ctx.fillStyle=color;
      series.forEach((p)=>{
        const x=P+( (p.x.getTime()-minX)/(maxX-minX || 1) )*(W-2*P);
        const y=H-P- ( (p.y-minY)/(maxY-minY) )*(H-2*P);
        ctx.beginPath(); ctx.arc(x,y,2.5,0,Math.PI*2); ctx.fill();
      });

      // –ø–æ–¥–ø–∏—Å–∏ –ø–æ –∫—Ä–∞—è–º
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--muted').trim();
      ctx.font='12px system-ui';
      ctx.fillText(series[0] ? ymd(series[0].x) : '', 8, H-6);
      ctx.textAlign='right';
      ctx.fillText(series[series.length-1] ? ymd(series[series.length-1].x) : '', W-8, H-6);
      ctx.textAlign='start';
    }

    function render(){
      lineChart('weightChart', readSeries('weight', 90));
      lineChart('pulseChart', readSeries('pulse', 90));
    }
    render();
    document.getElementById('refreshBtn').onclick=render;
  </script>
</body>
</html>
