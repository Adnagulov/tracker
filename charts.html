<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ì—Ä–∞—Ñ–∏–∫–∏ ‚Äî –õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</title>

  <style>
    :root{
      --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#3b82f6; --warn:#f59e0b; --danger:#ef4444; --border:#1f2937;
      --chip-bg:#0b1222;
    }
    [data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#4b5563; --text:#0f172a;
      --accent:#16a34a; --accent2:#2563eb; --warn:#d97706; --danger:#dc2626; --border:#e5e7eb;
      --chip-bg:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif}
    header{border-bottom:1px solid var(--border)}
    .wrap{max-width:1024px;margin:0 auto;padding:16px}
    h1{margin:0 0 8px;font-size:24px}
    .sub{color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin:12px 0}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto}
    .btn{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:var(--chip-bg);color:var(--text)!important;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent2); color:#fff;}
    .btn.ghost{background:var(--card)}
    input[type="date"]{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
    table{width:100%;border-collapse:collapse}
    th,td{border-bottom:1px solid var(--border);padding:8px;text-align:left}
    th{color:var(--muted);font-weight:700}
    .empty{color:var(--muted);padding:12px}
    canvas{width:100%;height:300px;max-height:50vh}
    @media(max-width:560px){ h1{font-size:22px} }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // —É–Ω–∞—Å–ª–µ–¥—É–µ–º —Ç–µ–º—É —Å –≥–ª–∞–≤–Ω–æ–π
    (function(){
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
</head>
<body>
  <header>
    <div class="wrap flex" style="justify-content:space-between;align-items:flex-start">
      <div>
        <h1>üìà –ì—Ä–∞—Ñ–∏–∫–∏</h1>
        <div class="sub" id="whoami">‚Äî</div>
      </div>
      <div class="flex">
        <a class="btn ghost" href="./index.html">‚Üê –ù–∞–∑–∞–¥</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div class="flex" style="justify-content:space-between">
        <div class="flex">
          <label class="sub">–° –¥–∞—Ç—ã</label>
          <input type="date" id="fromDate">
          <label class="sub">–ø–æ</label>
          <input type="date" id="toDate">
          <button class="btn" id="resetRange">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
        <div class="flex right">
          <button class="btn" id="exportCsvBtn">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–í–µ—Å (–∫–≥)</h3>
      <canvas id="weightChart"></canvas>
      <div class="sub" id="weightStats" style="margin-top:8px">‚Äî</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–û–±—ä–µ–º –∂–∏–≤–æ—Ç–∞ (—Å–º)</h3>
      <canvas id="waistChart"></canvas>
      <div class="sub" id="waistStats" style="margin-top:8px">‚Äî</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–û–±—ä–µ–º –±–∏—Ü–µ–ø—Å–∞ (—Å–º)</h3>
      <canvas id="bicepsChart"></canvas>
      <div class="sub" id="bicepsStats" style="margin-top:8px">‚Äî</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–û–±—ä–µ–º –∫–≤–∞–¥—Ä–∏—Ü–µ–ø—Å–∞ (—Å–º)</h3>
      <canvas id="quadChart"></canvas>
      <div class="sub" id="quadStats" style="margin-top:8px">‚Äî</div>
    </section>

    <section class="card">
      <h3 style="margin-top:0">–¢–∞–±–ª–∏—Ü–∞ –∑–Ω–∞—á–µ–Ω–∏–π</h3>
      <div id="tableBox" class="empty">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–∫—Ä–æ–π <b>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</b> –∏ –Ω–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –≤–µ—Å/–æ–±–º–µ—Ä—ã.</div>
    </section>
  </main>

  <script>
    // === Supabase ===
    const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const whoamiEl = document.getElementById('whoami');
    const fromDateEl = document.getElementById('fromDate');
    const toDateEl   = document.getElementById('toDate');
    const resetRangeBtn = document.getElementById('resetRange');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    const weightCtx = document.getElementById('weightChart').getContext('2d');
    const waistCtx  = document.getElementById('waistChart').getContext('2d');
    const bicepsCtx = document.getElementById('bicepsChart').getContext('2d');
    const quadCtx   = document.getElementById('quadChart').getContext('2d');

    let ALL_ROWS = []; // [{ymd, weight, waist, biceps, quad}]
    let filtered = [];
    let weightChart, waistChart, bicepsChart, quadChart;

    // –¶–µ–ª–µ–≤–æ–π –ø–ª–∞–Ω –ø–æ –≤–µ—Å—É (–¥–∞—Ç–∞ -> –∫–≥)
    const TARGET_WEIGHT_RAW = [
      ['2025-09-17','97'],
      ['2025-09-23','95,9'],
      ['2025-09-30','94,7'],
      ['2025-10-07','93,6'],
      ['2025-10-14','92,5'],
      ['2025-10-21','91,3'],
      ['2025-10-28','90,2'],
      ['2025-11-04','89,1'],
      ['2025-11-11','87,9'],
      ['2025-11-18','86,8'],
      ['2025-11-25','85,7'],
      ['2025-12-02','84,5'],
      ['2025-12-09','83,4'],
      ['2025-12-16','82,3'],
      ['2025-12-23','81,1'],
      ['2025-12-30','80']
    ];
    const TARGET_POINTS = TARGET_WEIGHT_RAW
      .map(([d,v])=>({ d, v:Number(String(v).replace(',','.')) }))
      .sort((a,b)=>a.d.localeCompare(b.d));

    // –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π redirect –¥–ª—è —Å—Å—ã–ª–æ–∫ –≤—Ö–æ–¥–∞ (GitHub Pages/–æ—Ç–Ω–æ—Å–∏—Ç. –ø—É—Ç—å)
    const REDIRECT_URL = (() => {
      const u = new URL(window.location.href);
      let p = u.pathname;
      if (p.endsWith('.html')) p = p.slice(0, p.lastIndexOf('/')+1);
      if (!p.endsWith('/')) p += '/';
      return `${u.origin}${p}`;
    })();

    // ====== AUTH ======
    async function ensureAuthAndLoad(){
      try { await sb.auth.exchangeCodeForSession(window.location.href); } catch(_) {}
      if (/[?#].*(access_token|refresh_token|code)=/i.test(location.href)) {
        history.replaceState({}, document.title, REDIRECT_URL.replace(/\/$/,'') + '/charts.html');
      }

      const { data:{ session } } = await sb.auth.getSession();
      const user = session?.user;

      whoamiEl.textContent = user ? ('‚Ä¢ ' + (user.email || user.id)) : '–ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω –≤—Ö–æ–¥. –û—Ç–∫—Ä–æ–π –≥–ª–∞–≤–Ω—É—é –∏ –≤–æ–π–¥–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ email.';
      if (!user) return;

      await loadAllDaily(user.id);
      initDateRange();
      applyFilterAndRender();
    }

    // ====== LOAD ======
    async function loadAllDaily(userId){
      ALL_ROWS = [];
      const { data, error } = await sb.from('daily_data')
        .select('ymd,data')
        .eq('user_id', userId)
        .order('ymd', { ascending: true });

      if (error) {
        console.warn('loadAllDaily error', error);
        return;
      }
      for (const row of (data || [])) {
        const y = row.ymd;
        const map = row.data || {};
        const w = map[`metric:${y}:weight`];
        const waist  = map[`metric:${y}:waist`];
        const biceps = map[`metric:${y}:biceps`];
        const quad   = map[`metric:${y}:quad`];

        const weight = (w==null || w==='' || isNaN(Number(w))) ? null : Number(w);
        const waistN  = (waist==null  || waist===''  || isNaN(Number(waist)))  ? null : Number(waist);
        const bicepsN = (biceps==null || biceps==='' || isNaN(Number(biceps))) ? null : Number(biceps);
        const quadN   = (quad==null   || quad===''   || isNaN(Number(quad)))   ? null : Number(quad);

        if (weight!=null || waistN!=null || bicepsN!=null || quadN!=null) {
          ALL_ROWS.push({ ymd: y, weight, waist: waistN, biceps: bicepsN, quad: quadN });
        }
      }
    }

    // ====== DATE RANGE / FILTER ======
    function initDateRange(){
      if (!ALL_ROWS.length) return;
      fromDateEl.value = ALL_ROWS[0].ymd;
      toDateEl.value   = ALL_ROWS[ALL_ROWS.length-1].ymd;
      fromDateEl.max   = toDateEl.value;
      toDateEl.min     = fromDateEl.value;
    }

    function applyFilterAndRender(){
      if (!ALL_ROWS.length){
        renderEmpty();
        return;
      }
      const from = fromDateEl.value || ALL_ROWS[0].ymd;
      const to   = toDateEl.value   || ALL_ROWS[ALL_ROWS.length-1].ymd;

      const f = from <= to ? from : to;
      const t = to >= from ? to : from;
      if (fromDateEl.value !== f) fromDateEl.value = f;
      if (toDateEl.value   !== t) toDateEl.value   = t;

      filtered = ALL_ROWS.filter(r => r.ymd >= f && r.ymd <= t);
      renderCharts();
      renderTable();
    }

    function renderEmpty(){
      [weightChart,waistChart,bicepsChart,quadChart].forEach(ch=>{ if(ch){ ch.destroy(); }});
      document.getElementById('weightStats').textContent = '‚Äî';
      document.getElementById('waistStats').textContent  = '‚Äî';
      document.getElementById('bicepsStats').textContent = '‚Äî';
      document.getElementById('quadStats').textContent   = '‚Äî';
      document.getElementById('tableBox').innerHTML = '<div class="empty">–î–∞–Ω–Ω—ã—Ö –ø–æ–∫–∞ –Ω–µ—Ç. –û—Ç–∫—Ä–æ–π <b>–õ–∏—á–Ω—ã–π —Ç—Ä–µ–∫–µ—Ä</b> –∏ –Ω–∞—á–Ω–∏ –≤–≤–æ–¥–∏—Ç—å –≤–µ—Å/–æ–±–º–µ—Ä—ã.</div>';
    }

    // ====== HELPERS ======
    function getTextColor(){
      return getComputedStyle(document.documentElement).getPropertyValue('--muted').trim() || '#94a3b8';
    }
    function getGridColor(){
      const c = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();
      return c || '#1f2937';
    }
    function statsLine(values, unit){
      const vals = values.filter(v => v!=null);
      if (!vals.length) return '‚Äî';
      const min = Math.min(...vals), max = Math.max(...vals), last = vals[vals.length-1];
      return `–ø–æ—Å–ª–µ–¥–Ω–µ–µ: ${last} ${unit} ‚Ä¢ –º–∏–Ω: ${min} ‚Ä¢ –º–∞–∫—Å: ${max}`;
    }
    // –¥–Ω–∏ –º–µ–∂–¥—É ISO –¥–∞—Ç–∞–º–∏
    function daysBetween(d1, d2){
      const t1 = new Date(d1+"T00:00:00Z").getTime();
      const t2 = new Date(d2+"T00:00:00Z").getTime();
      return Math.round((t2 - t1)/86400000);
    }
    // –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Ü–µ–ª–∏ –ø–æ –¥–∞—Ç–∞–º labels
    function buildInterpolatedTarget(labels){
      if (!TARGET_POINTS.length) return labels.map(()=>null);
      const arr = labels.map(()=>null);
      // –Ω–∞–π–¥—ë–º –±–ª–∏–∂–∞–π—à–∏–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ç–æ—á–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –¥–Ω—è
      for (let i=0;i<labels.length;i++){
        const d = labels[i];
        // –µ—Å–ª–∏ —Ç–æ—á–∫–∞ —Ü–µ–ª–∏ —Ä–æ–≤–Ω–æ –Ω–∞ —ç—Ç—É –¥–∞—Ç—É ‚Äî –ø—Ä–æ—Å—Ç–æ —Å—Ç–∞–≤–∏–º –µ—ë
        const exact = TARGET_POINTS.find(p=>p.d===d);
        if (exact){ arr[i] = exact.v; continue; }
        // –Ω–∞–π–¥—ë–º –ª–µ–≤—É—é –∏ –ø—Ä–∞–≤—É—é –æ–ø–æ—Ä–Ω—ã–µ —Ç–æ—á–∫–∏
        let left = null, right = null;
        for (const p of TARGET_POINTS){
          if (p.d < d) left = p; else { right = p; break; }
        }
        if (!left || !right) { // –≤–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ —Ü–µ–ª–∏ ‚Äî –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
          arr[i] = null; 
          continue;
        }
        const total = daysBetween(left.d, right.d);
        const offset = daysBetween(left.d, d);
        const k = offset / total;
        arr[i] = left.v + (right.v - left.v) * k; // –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è
      }
      return arr;
    }

    // ====== RENDER CHARTS ======
    function renderCharts(){
      const labels = filtered.map(r => r.ymd);

      // –≤–µ—Å (—Ñ–∞–∫—Ç)
      const weights = filtered.map(r => r.weight);
      // —Ü–µ–ª—å (–∏–Ω—Ç–µ—Ä–ø–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–æ–¥ –∫–∞–∂–¥—É—é –º–µ—Ç–∫—É)
      const targetInterp = buildInterpolatedTarget(labels);

      // –ø–æ–¥–∫—Ä–∞—Å–∫–∞ —Ç–æ—á–µ–∫ —Ñ–∞–∫—Ç–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–ª–∏
      const pointColors = weights.map((w, idx) => {
        const tgt = targetInterp[idx];
        if (w==null || tgt==null) return getTextColor(); // –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π —Ü–≤–µ—Ç –µ—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç
        return w <= tgt ? '#22c55e' : '#ef4444'; // –∑–µ–ª—ë–Ω—ã–π –µ—Å–ª–∏ –≤—ã–ø–æ–ª–Ω—è–µ—à—å –ø–ª–∞–Ω
      });

      const textColor = getTextColor();
      const gridColor = getGridColor();

      // WEIGHT
      if (weightChart) weightChart.destroy();
      weightChart = new Chart(weightCtx, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: '–§–∞–∫—Ç',
              data: weights,
              spanGaps: true,
              pointRadius: 3,
              pointBackgroundColor: pointColors,
              pointBorderColor: pointColors
            },
            {
              label: '–¶–µ–ª—å',
              data: targetInterp,
              spanGaps: true,
              borderDash: [6,4],
              pointRadius: 0
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { 
            legend: { labels: { color: textColor } },
            tooltip: {
              callbacks: {
                afterBody: (items) => {
                  // –ø–æ–∫–∞–∂–µ–º ‚àÜ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–ª–∏
                  const idx = items[0].dataIndex;
                  const w = weights[idx], t = targetInterp[idx];
                  if (w==null || t==null) return '';
                  const delta = (w - t).toFixed(1);
                  const sign = delta>0 ? '+' : '';
                  return `Œî –∫ —Ü–µ–ª–∏: ${sign}${delta} –∫–≥`;
                }
              }
            }
          },
          scales: {
            x: { ticks: { color: textColor }, grid: { color: gridColor } },
            y: { ticks: { color: textColor }, grid: { color: gridColor } }
          }
        }
      });

      // –ò—Ç–æ–≥ –ø–æ –ø–ª–∞–Ω—É: —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π ‚â§ —Ü–µ–ª–∏
      let planOk = 0, planTotal = 0;
      for (let i=0;i<labels.length;i++){
        if (weights[i]!=null && targetInterp[i]!=null){ planTotal++; if (weights[i] <= targetInterp[i]) planOk++; }
      }
      const wVals = weights.filter(v => v!=null);
      const wMin = wVals.length ? Math.min(...wVals) : null;
      const wMax = wVals.length ? Math.max(...wVals) : null;
      const wLast= wVals.length ? wVals[wVals.length-1] : null;
      document.getElementById('weightStats').textContent =
        (wVals.length ? `–ø–æ—Å–ª–µ–¥–Ω–µ–µ: ${wLast} –∫–≥ ‚Ä¢ –º–∏–Ω: ${wMin} ‚Ä¢ –º–∞–∫—Å: ${wMax}` : '‚Äî') +
        (planTotal ? ` ‚Ä¢ –¥–Ω–µ–π –ø–æ –ø–ª–∞–Ω—É: ${planOk}/${planTotal}` : '');

      // WAIST
      const waists = filtered.map(r => r.waist);
      if (waistChart) waistChart.destroy();
      waistChart = new Chart(waistCtx, {
        type: 'line',
        data: { labels, datasets: [{ label: '–ñ–∏–≤–æ—Ç', data: waists, spanGaps: true }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ x:{ ticks:{ color:textColor }, grid:{ color:gridColor } }, y:{ ticks:{ color:textColor }, grid:{ color:gridColor } } }
        }
      });
      document.getElementById('waistStats').textContent = statsLine(waists, '—Å–º');

      // BICEPS
      const biceps = filtered.map(r => r.biceps);
      if (bicepsChart) bicepsChart.destroy();
      bicepsChart = new Chart(bicepsCtx, {
        type: 'line',
        data: { labels, datasets: [{ label: '–ë–∏—Ü–µ–ø—Å', data: biceps, spanGaps: true }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ x:{ ticks:{ color:textColor }, grid:{ color:gridColor } }, y:{ ticks:{ color:textColor }, grid:{ color:gridColor } } }
        }
      });
      document.getElementById('bicepsStats').textContent = statsLine(biceps, '—Å–º');

      // QUAD
      const quads = filtered.map(r => r.quad);
      if (quadChart) quadChart.destroy();
      quadChart = new Chart(quadCtx, {
        type: 'line',
        data: { labels, datasets: [{ label: '–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å', data: quads, spanGaps: true }] },
        options: {
          responsive:true, maintainAspectRatio:false,
          plugins:{ legend:{ display:false } },
          scales:{ x:{ ticks:{ color:textColor }, grid:{ color:gridColor } }, y:{ ticks:{ color:textColor }, grid:{ color:gridColor } } }
        }
      });
      document.getElementById('quadStats').textContent = statsLine(quads, '—Å–º');
    }

    // ====== TABLE ======
    function renderTable(){
      const box = document.getElementById('tableBox');
      if (!filtered.length){
        box.innerHTML = '<div class="empty">–ó–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</div>';
        return;
      }
      const rows = filtered.map(r => {
        const w = (r.weight==null || Number.isNaN(r.weight)) ? '' : r.weight;
        const wa = (r.waist==null  || Number.isNaN(r.waist))  ? '' : r.waist;
        const bi = (r.biceps==null || Number.isNaN(r.biceps)) ? '' : r.biceps;
        const qu = (r.quad==null   || Number.isNaN(r.quad))   ? '' : r.quad;
        return `<tr><td>${r.ymd}</td><td>${w}</td><td>${wa}</td><td>${bi}</td><td>${qu}</td></tr>`;
      }).join('');
      box.innerHTML = `
        <div style="overflow:auto">
          <table>
            <thead><tr><th>–î–∞—Ç–∞</th><th>–í–µ—Å (–∫–≥)</th><th>–ñ–∏–≤–æ—Ç (—Å–º)</th><th>–ë–∏—Ü–µ–ø—Å (—Å–º)</th><th>–ö–≤–∞–¥—Ä–∏—Ü–µ–ø—Å (—Å–º)</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    // ====== CSV ======
    function toCsv(arr){
      const header = ['date','weight','waist','biceps','quad'];
      const lines = [header.join(',')];
      arr.forEach(r=>{
        lines.push([
          r.ymd,
          r.weight ?? '',
          r.waist ?? '',
          r.biceps ?? '',
          r.quad ?? ''
        ].join(','));
      });
      return lines.join('\n');
    }
    function downloadCsv(name, text){
      const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1000);
    }

    // ====== EVENTS ======
    fromDateEl.addEventListener('change', ()=>{
      if (toDateEl.value && fromDateEl.value > toDateEl.value) toDateEl.value = fromDateEl.value;
      applyFilterAndRender();
    });
    toDateEl.addEventListener('change', ()=>{
      if (fromDateEl.value && toDateEl.value < fromDateEl.value) fromDateEl.value = toDateEl.value;
      applyFilterAndRender();
    });
    resetRangeBtn.addEventListener('click', ()=>{
      if (!ALL_ROWS.length) return;
      fromDateEl.value = ALL_ROWS[0].ymd;
      toDateEl.value   = ALL_ROWS[ALL_ROWS.length-1].ymd;
      applyFilterAndRender();
    });
    exportCsvBtn.addEventListener('click', ()=>{
      const csv = toCsv(filtered.length ? filtered : ALL_ROWS);
      const name = `tracker_metrics_${(new Date()).toISOString().slice(0,10)}.csv`;
      downloadCsv(name, csv);
    });

    // ====== BOOT ======
    ensureAuthAndLoad();
  </script>
</body>
</html>
