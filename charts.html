<!doctype html>
<html lang="ru" data-theme="dark">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Графики</title>
<style>
 body{margin:0;font-family:Inter,system-ui;background:#0f172a;color:#e6eef8;padding:12px}
 .wrap{max-width:980px;margin:0 auto}
 .card{background:#0d1320;border:1px solid #1f2937;padding:12px;border-radius:10px;margin-bottom:12px}
 canvas{width:100%!important;height:300px!important}
 .small{font-size:13px;color:#94a3b8}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 style="margin:0">Графики</h2>
    <div class="small">Данные читаются из локального хранилища. Нажмите "Загрузить из облака" на главной, чтобы подтянуть данные.</div>
  </div>

  <div class="card"><h3>Вес (факт)</h3><canvas id="weightChart"></canvas></div>
  <div class="card"><h3>Объём живота</h3><canvas id="waistChart"></canvas></div>
  <div class="card"><h3>Объём бицепса</h3><canvas id="bicepsChart"></canvas></div>
  <div class="card"><h3>Объём квадрицепса</h3><canvas id="quadChart"></canvas></div>

  <div class="card"><a href="index.html" class="small">← Вернуться</a></div>
</div>

<script>
/* Supabase (на случай прямой sync) */
const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* target weight plan (your table) */
const TARGET = [
  ['2025-09-17',97],['2025-09-23',95.9],['2025-09-30',94.7],['2025-10-07',93.6],
  ['2025-10-14',92.5],['2025-10-21',91.3],['2025-10-28',90.2],['2025-11-04',89.1],
  ['2025-11-11',87.9],['2025-11-18',86.8],['2025-11-25',85.7],['2025-12-02',84.5],
  ['2025-12-09',83.4],['2025-12-16',82.3],['2025-12-23',81.1],['2025-12-30',80.0]
];

function pad(n){ return String(n).padStart(2,'0'); }
function ymd(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }

/* collect series from localStorage (scan keys) */
function collectLocalSeries(){
  // We'll take last 16 target dates as labels
  const labels = TARGET.map(t=>t[0]);
  const weightActual = labels.map(lbl => {
    const v = localStorage.getItem(`metric:${lbl}:weight`);
    return v ? Number(v) : null;
  });
  const waist = labels.map(lbl => { const v = localStorage.getItem(`circ:${lbl}:waist`); return v?Number(v):null; });
  const biceps = labels.map(lbl => { const v = localStorage.getItem(`circ:${lbl}:biceps`); return v?Number(v):null; });
  const quad = labels.map(lbl => { const v = localStorage.getItem(`circ:${lbl}:quad`); return v?Number(v):null; });
  const target = TARGET.map(t=>t[1]);
  return { labels, weightActual, waist, biceps, quad, target };
}

function mkLine(ctx, labels, datasets){
  return new Chart(ctx, {
    type:'line',
    data:{ labels, datasets },
    options:{
      responsive:true, interaction:{mode:'index',intersect:false},
      plugins:{legend:{display:true}}, scales:{ y:{ beginAtZero:false } }
    }
  });
}

function renderCharts(){
  const s = collectLocalSeries();
  mkLine(document.getElementById('weightChart').getContext('2d'), s.labels, [
    { label:'Фактический вес', data: s.weightActual, borderColor:'#3b82f6', fill:false, tension:0.2, spanGaps:true },
    { label:'Целевой вес', data: s.target, borderColor:'#ef4444', borderDash:[6,4], fill:false, tension:0.2 }
  ]);
  mkLine(document.getElementById('waistChart').getContext('2d'), s.labels, [{ label:'Живот (см)', data: s.waist, borderColor:'#34d399', fill:false, spanGaps:true }]);
  mkLine(document.getElementById('bicepsChart').getContext('2d'), s.labels, [{ label:'Бицепс (см)', data: s.biceps, borderColor:'#60a5fa', fill:false, spanGaps:true }]);
  mkLine(document.getElementById('quadChart').getContext('2d'), s.labels, [{ label:'Квадрицепс (см)', data: s.quad, borderColor:'#f59e0b', fill:false, spanGaps:true }]);
}

renderCharts();
</script>
</body>
</html>
