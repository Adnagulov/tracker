<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Авторизация…</title>
  <link rel="icon" href="favicon.svg" type="image/svg+xml" />
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--border:#1f2937}
    [data-theme="light"]{--bg:#ffffff;--card:#f8fafc;--text:#0f172a;--border:#e5e7eb}
    body{margin:0;font:16px/1.5 system-ui,-apple-system,Segoe UI,Inter,Arial,sans-serif;background:var(--bg);color:var(--text);display:grid;place-items:center;height:100dvh}
    .box{max-width:520px;padding:24px;border:1px solid var(--border);border-radius:12px;background:var(--card);box-shadow:0 2px 6px rgba(0,0,0,.2)}
    .small{color:#94a3b8;font-size:13px}
    .btn{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text);cursor:pointer;font-weight:600}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://afxbyrypaqnobaalipjm.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vROzTIfTCdtiea3xfMCcHA_bthD-zZr";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    (async () => {
      try { await sb.auth.exchangeCodeForSession(window.location.href); }
      catch (e) {
        try {
          const u = new URL(window.location.href);
          const at = u.searchParams.get('access_token') || u.hash.match(/access_token=([^&]+)/)?.[1];
          const rt = u.searchParams.get('refresh_token')|| u.hash.match(/refresh_token=([^&]+)/)?.[1];
          if (at && rt) await sb.auth.setSession({ access_token:at, refresh_token:rt });
        } catch {}
      }
      const fallback = (location.origin + location.pathname).replace(/[^/]+$/,'') + 'index.html';
      const returnTo = localStorage.getItem('returnTo') || fallback;
      localStorage.removeItem('returnTo');
      location.replace(returnTo);
    })();
  </script>
</head>
<body>
  <div class="box">
    <img src="logo.svg" alt="logo" style="height:28px;vertical-align:middle;margin-right:6px">
    <b>Завершаем вход…</b>
    <div class="small" style="margin-top:8px">Если страница зависла, вернитесь назад и откройте письмо через «Открыть в браузере».</div>
    <div style="margin-top:12px"><a class="btn" href="index.html">← На главную</a></div>
  </div>
</body>
</html>
